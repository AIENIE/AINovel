# v2 模块落地说明

## 模块作用
- 提供 `design-doc/v2` 对应的后端 API 基线与前端联调入口。
- 在不破坏 `/api/v1/*` 的前提下，新增 `/api/v2/*` 端点与工作台 v2 面板。

## 功能点清单
| 功能点 | 作用 | 实现位置 |
|---|---|---|
| 上下文记忆 API | Lorebook、图谱查询、实体提取、上下文预览 | `backend/src/main/java/com/ainovel/app/v2/V2ContextController.java` |
| 风格画像/角色声音 API | 风格画像 CRUD、激活、风格分析、角色声音 CRUD/生成 | `backend/src/main/java/com/ainovel/app/v2/V2StyleController.java` |
| Beta Reader/连续性 API | 分析任务、报告、连续性问题管理 | `backend/src/main/java/com/ainovel/app/v2/V2AnalysisController.java` |
| 版本控制 API | 版本快照、分支、回滚、diff、自动保存配置 | `backend/src/main/java/com/ainovel/app/v2/V2VersionController.java` |
| 导出 API | 导出任务、模板 CRUD、下载 | `backend/src/main/java/com/ainovel/app/v2/V2ExportController.java` |
| 多模型协作 API | 模型列表、路由、偏好、用量、模型对比 | `backend/src/main/java/com/ainovel/app/v2/V2ModelController.java` |
| 工作台体验 API | 布局、写作会话、目标、快捷键 | `backend/src/main/java/com/ainovel/app/v2/V2WorkspaceController.java` |
| 访问守卫 | v2 统一用户/故事/稿件权限校验 | `backend/src/main/java/com/ainovel/app/v2/V2AccessGuard.java` |
| 前端 v2 联调面板 | 在工作台内触发 v2 关键接口链路 | `frontend/src/pages/Workbench/tabs/V2Studio.tsx` |
| 前端 v2 API 封装 | 按模块封装 `/api/v2/*` 调用 | `frontend/src/lib/mock-api.ts` |
| 稿件分支字段 | 支持当前活跃分支引用 | `backend/src/main/java/com/ainovel/app/manuscript/model/Manuscript.java` |

## 关键流程
1. 前端进入 `工作台 -> v2工作台`，填入 `storyId/manuscriptId` 后触发各模块接口。
2. 后端由 `V2AccessGuard` 做当前用户、故事归属、稿件归属与管理员权限校验。
3. 版本控制模块首次访问稿件时自动初始化 `main` 分支与初始快照。

## 测试覆盖
- `backend/src/test/java/com/ainovel/app/v2/V2ContextControllerTests.java`
- `backend/src/test/java/com/ainovel/app/v2/V2VersionControllerTests.java`
- `backend/src/test/java/com/ainovel/app/v2/V2WorkspaceControllerTests.java`
