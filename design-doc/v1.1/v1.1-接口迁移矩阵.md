# AINovel v1.1 接口迁移矩阵

## 1. 说明

- 本矩阵基于 2026-02-16 的 Consul 与 grpcurl 实测结果。
- 目标：把本地重复能力收敛到第三方 `AiService/UserService/PayService`，保留 AINovel 创作域能力。
- 状态定义：
  - `删除`：下线本地接口与实现
  - `保留-改造`：保留本地路径（前端兼容），实现改为调用第三方
  - `保留-不变`：本地核心创作能力，不在本次收敛范围

## 2. 本地接口迁移

## 2.1 AI 相关

| 本地接口 | 当前用途 | v1.1 处理 | 目标服务接口 |
|---|---|---|---|
| `GET /v1/ai/models` | 列出模型 | 保留-改造（BFF 透传） | `AiGatewayService.ListModels` |
| `POST /v1/ai/chat` | 聊天生成 | 保留-改造（BFF 透传） | `AiGatewayService.ChatCompletions` |
| `POST /v1/ai/refine` | 文本润色 | 保留-改造（BFF 透传） | `AiGatewayService.ChatCompletions` |
| `POST /v1/ai/generate-dialogue` | 对话生成 | 保留-改造 | `AiGatewayService.ChatCompletions` |
| `POST /v1/story-cards/{id}/refine` | 故事润色 | 保留-改造 | `AiGatewayService.ChatCompletions` |
| `POST /v1/character-cards/{id}/refine` | 角色润色 | 保留-改造 | `AiGatewayService.ChatCompletions` |
| `POST /v1/outlines/scenes/{id}/refine` | 场景润色 | 保留-改造 | `AiGatewayService.ChatCompletions` |
| `POST /v1/worlds/{id}/modules/{moduleKey}/fields/{fieldKey}/refine` | 世界观字段润色 | 保留-改造 | `AiGatewayService.ChatCompletions` |

## 2.2 用户与认证相关

| 本地接口 | 当前用途 | v1.1 处理 | 目标服务接口 |
|---|---|---|---|
| `GET /v1/admin/users` | 管理员查用户 | 保留-改造 | `userservice-http /api/admin/users` / `UserDirectoryService` |
| `POST /v1/admin/users/{id}/ban` | 封禁用户 | 保留-改造 | `userservice-http /api/admin/users/{id}/ban` / `UserBanService.BanUser` |
| `POST /v1/admin/users/{id}/unban` | 解封用户 | 保留-改造 | `userservice-http /api/admin/users/{id}/unban` / `UserBanService.UnbanUser` |
| `GET /v1/user/profile` | 个人资料 | 保留-改造 | `UserDirectoryService.GetUserBasic` + Pay 余额查询 |
| `POST /v1/user/password` | 改密（当前 501） | 删除 | `UserAuthService.ResetPassword`（由 UserService 对外） |
| `GET /v1/admin/email/smtp` | SMTP 状态 | 删除 | `userservice-http /api/admin/email/smtp` |
| `POST /v1/admin/email/test` | 测试邮件 | 删除 | `userservice-http /api/admin/email/smtp/{id}/test` |

## 2.3 支付与积分相关

| 本地接口 | 当前用途 | v1.1 处理 | 目标服务接口 |
|---|---|---|---|
| `POST /v1/user/check-in` | 每日签到 | 保留-改造 | `BillingCheckinService.Checkin` |
| `POST /v1/user/redeem` | 兑换码兑换 | 保留-改造 | `BillingRedeemCodeService.RedeemCode` |
| `POST /v1/admin/users/{id}/grant-credits` | 管理员发放积分 | 删除 | `BillingGrantService.GrantPublicTokens` |
| `GET /v1/admin/logs` | 积分日志 | 删除 | `BillingQueryService.ListLedgerEntries` / `payservice-http /api/admin/credit-logs` |
| `GET /v1/admin/redeem-codes` | 兑换码列表 | 删除 | `payservice-http /api/admin/redeem-codes` |
| `POST /v1/admin/redeem-codes` | 创建兑换码 | 删除 | `payservice-http /api/admin/redeem-codes` |

## 2.4 系统设置与管理聚合

| 本地接口 | 当前用途 | v1.1 处理 | 目标服务接口 |
|---|---|---|---|
| `GET /v1/admin/system-config` | 全局系统配置（含 LLM/签到） | 保留-改造（拆分来源） | 用户开关保留本地；签到来自 `payservice-http /api/admin/checkin-config`；LLM 来自 `AiService` |
| `PUT /v1/admin/system-config` | 更新全局配置 | 保留-改造（拆分写入） | 同上 |
| `GET /v1/admin/dashboard` | 管理看板 | 保留-改造（聚合） | 用户统计来自 UserService，计费统计来自 PayService，本地保留素材待审统计 |
| `GET /admin/api-management/*` | AINovel 本服务接口管理 | 删除 | 使用 SpringDoc 标准入口 `/api/swagger-ui/index.html`、`/api/v3/api-docs` |

## 2.5 创作域接口（本地保留）

以下域以 AINovel 自身业务为主，v1.1 不做下线：

- 故事/大纲/章节/场景：`/v1/story-cards*`, `/v1/stories*`, `/v1/outlines*`, `/v1/chapters*`, `/v1/scenes*`
- 世界观：`/v1/worlds*`, `/v1/world-building/definitions`
- 素材：`/v1/materials*`
- 稿件：`/v1/manuscripts*`
- Prompt 模板：`/v1/prompt-templates*`, `/v1/world-prompts*`

## 3. 前端页面与入口迁移

| 前端位置 | 当前功能 | v1.1 处理 |
|---|---|---|
| `frontend/src/pages/Admin/ModelManager.tsx` | 模型与 API 池管理 | 删除页面与路由 |
| `frontend/src/components/layout/AdminLayout.tsx` | 管理侧“模型管理”菜单 | 删除入口 |
| `frontend/src/pages/Settings/tabs/ModelSettings.tsx` | 用户侧模型接入配置 | 删除页面与入口 |
| `frontend/src/pages/Admin/SystemSettings.tsx` | LLM 全局配置段落 | 删除该段，改为三方只读或跳转 |
| `frontend/src/pages/Profile/ProfilePage.tsx` | 签到/兑换与积分展示 | 保留页面，接口改为 PayService 编排调用 |

## 4. 后端代码包级处理清单

## 4.1 删除候选

- `backend/src/main/java/com/ainovel/app/ai/**`
- `backend/src/main/java/com/ainovel/app/economy/**`
- `backend/src/main/java/com/ainovel/app/ai/model/**`
- `backend/src/main/java/com/ainovel/app/ai/repo/**`

## 4.2 改造候选

- `backend/src/main/java/com/ainovel/app/story/StoryService.java`
- `backend/src/main/java/com/ainovel/app/world/WorldService.java`
- `backend/src/main/java/com/ainovel/app/manuscript/ManuscriptService.java`
- `backend/src/main/java/com/ainovel/app/admin/AdminController.java`
- `backend/src/main/java/com/ainovel/app/user/UserController.java`
- `backend/src/main/java/com/ainovel/app/settings/SettingsService.java`

## 5. 配置基线修正（v1.1 首批）

建议在 v1.1 首批提交中统一以下配置：

- `CONSUL_HOST=192.168.1.4`
- `CONSUL_PORT=60000`
- `USER_GRPC_SERVICE_NAME=aienie-userservice-grpc`

说明：当前本项目默认 `userservice-grpc` 与 Consul 实际服务名 `aienie-userservice-grpc` 不一致。

## 6. Swagger 实施顺序（与迁移联动）

1. 先执行“删除/保留-改造”接口收敛，冻结最终保留接口清单。
2. 再对保留接口做 Swagger 全量注解，避免在将要删除的接口上浪费工作量。
3. 对保留且改造的接口补“上游依赖说明”和“错误码映射说明”。
