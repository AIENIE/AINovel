# AINovel v1.1 开发实施文档

## 1. 实施目标

本实施文档用于把 v1.1 的两条主线落到可执行任务：

1. 功能收敛：移除本地重复实现（AiService/UserService/PayService 重叠能力）。
2. 文档标准化：为全部 REST 接口补齐高质量 Swagger/OpenAPI 注解与示例。

关联文档：

- `design-doc/v1.1/v1.1-外部服务发现记录.md`
- `design-doc/v1.1/v1.1-接口迁移矩阵.md`

## 2. 第三方能力发现与比对流程

## 2.1 发现输入

- 服务发现来源：Consul
- 目标服务：`AiService`、`UserService`、`PayService`
- 工具：`grpcurl`

## 2.2 发现步骤（网络恢复后执行）

1. 从 Consul 拉取服务与健康实例列表。
2. 解析目标服务 `host:port`。
3. 对每个实例执行：
   - `grpcurl list`
   - `grpcurl describe <Service>`
   - 必要时 `grpcurl -d '<json>' <Service>/<Method>` 做最小探测（只读接口优先）
4. 形成“第三方能力矩阵”：服务 -> 方法 -> 请求/响应 -> 权限 -> 幂等语义。
5. 输出“本地删除映射表”：本地接口/服务 -> 替代的第三方接口。

## 2.3 当前状态

- `grpcurl` 已通过工具检查。
- 已确认 Consul 外部入口：`http://192.168.1.4:60000`（默认 `8500` 未对当前网络开放）。
- 已完成三方服务发现与 gRPC 反射拉取。

## 2.4 已发现的第三方接口能力（2026-02-16）

### 2.4.1 Consul 实例地址

- `aienie-userservice-grpc` -> `192.168.1.3:20002`
- `aienie-aiservice-grpc` -> `192.168.1.3:20003`
- `aienie-payservice-grpc` -> `192.168.1.3:20004`
- `aienie-userservice-http` -> `192.168.1.3:10002`
- `aienie-aiservice-http` -> `192.168.1.3:10003`
- `aienie-payservice-http` -> `192.168.1.3:10004`

### 2.4.2 gRPC 服务方法

- UserService（`192.168.1.3:20002`）
  - `EmailVerificationService`: `SendEmailCode`, `VerifyEmailCode`
  - `UserAuthService`: `LoginUser`, `RegisterUser`, `ResetPassword`, `ValidateSession`
  - `UserBanService`: `BanUser`, `GetBanStatus`, `UnbanUser`
  - `UserDirectoryService`: `GetUserBasic`, `BatchGetUserBasic`
  - `UserPreferenceService`: `GetProjectPreferences`, `UpsertProjectPreferences`
- AiService（`192.168.1.3:20003`）
  - `AiGatewayService`: `ListModels`, `ChatCompletions`, `Embeddings`
- PayService（`192.168.1.3:20004`）
  - `BillingCheckinService`: `Checkin`, `GetCheckinStatus`
  - `BillingRedeemCodeService`: `RedeemCode`, `GetRedemptionHistory`
  - `BillingGrantService`: `GrantPublicTokens`, `GrantProjectPermanentTokens`
  - `BillingQueryService`: `ListLedgerEntries`, `ListUsageRecords`
  - `BillingBalanceService`: `GetPublicBalance`, `GetProjectBalance`
  - `BillingUsageService`: `DeductPerCall`, `DeductUsage`
  - `BillingOnboardingService`: `EnsureUserInitialized`
  - `BillingConversionService`: `ConvertPublicToProject`
  - `BillingProjectModelQuotaService`: `CheckAndConsumeQuota`

## 3. 本地功能删减清单（首版）

以下为“已明确重叠”的首批项，执行时仍需与第三方接口矩阵逐项核对：

## 3.1 AI 相关（应下线）

- 后端：
  - `com.ainovel.app.ai` 全包（本地模型列表、聊天、润色、OpenAI 直连）
  - `ModelConfigEntity/Repository` 及初始化数据
  - `/v1/ai/models`、`/v1/ai/chat`、`/v1/ai/refine`
- 管理端：
  - `/admin/models` 页面与入口
  - 系统设置中的全局 LLM 配置
  - 用户设置中的模型接入配置

## 3.2 用户相关（应迁移到 UserService）

- 后端本地用户运营接口（按第三方能力对齐后下线）：
  - `/v1/admin/users`
  - `/v1/admin/users/{id}/ban`
  - `/v1/admin/users/{id}/unban`
  - `/v1/user/profile`
  - `/v1/user/summary`
- 数据层：
  - 本地用户侧冗余字段与统计逻辑（以第三方返回为准）
- 已确认迁移目标：
  - 封禁/解封 -> `UserBanService.BanUser` / `UserBanService.UnbanUser`
  - 用户基础信息 -> `UserDirectoryService.GetUserBasic` / `BatchGetUserBasic`
  - 登录态校验 -> `UserAuthService.ValidateSession`（项目已在用）

## 3.3 支付/积分相关（应迁移到 PayService）

- 用户侧：
  - `/v1/user/check-in`
  - `/v1/user/redeem`
- 管理侧：
  - `/v1/admin/users/{id}/grant-credits`
  - `/v1/admin/logs`
  - `/v1/admin/redeem-codes`
  - `/v1/admin/redeem-codes`(POST)
- 后端实现：
  - `com.ainovel.app.economy` 及关联仓储/实体
- 已确认迁移目标：
  - 签到 -> `BillingCheckinService.Checkin`
  - 兑换码 -> `BillingRedeemCodeService.RedeemCode`
  - 管理员发放 -> `BillingGrantService.GrantPublicTokens`（具体 token 类型待业务确认）
  - 日志查询 -> `BillingQueryService.ListLedgerEntries` / `ListUsageRecords`

## 3.4 收口结论

- `/admin/api-management` 已随“接口状态监控/接口管理入口”一起下线。
- Swagger/OpenAPI 统一通过 SpringDoc 标准入口提供：`/api/swagger-ui/index.html`、`/api/v3/api-docs`。
- 与创作主流程耦合的 AI 能力采用“后端 BFF 透传”方案保留兼容路径。

## 4. Swagger 全量改造方案

## 4.1 覆盖范围

- Controller（9 个）：
  - `AdminController`
  - `AiController`
  - `ManuscriptController`
  - `MaterialController`
  - `SettingsController`
  - `StoryController`
  - `UserController`
  - `WorldController`
  - `WorldDefinitionController`
- 端点总量约 98 个，要求 100% 覆盖。

## 4.2 注解规范

1. 类级别：
   - `@Tag(name = "...", description = "...")`
2. 方法级别：
   - `@Operation(summary = "...", description = "...")`
   - `@ApiResponses`（成功与关键失败码）
3. 参数级别：
   - `@Parameter(description = "...", example = "...")`
4. 请求/响应对象：
   - `@Schema(description = "...", example = "...")`
5. 示例：
   - 在请求体与响应体中使用 `@ExampleObject` 给出真实样例。

## 4.3 文档质量门槛

每个接口必须具备：

1. 业务意图说明（不是仅写“获取列表”）。
2. 关键参数含义与约束（必填、范围、格式）。
3. 响应字段语义（尤其状态、金额、时间、标识符）。
4. 至少 1 组成功示例；对关键接口补失败示例。

## 4.4 安全与分组

1. 定义统一 `BearerAuth` 安全方案并挂到需鉴权端点。
2. 区分“公开接口”与“管理接口”分组展示。
3. 校验 `SecurityConfig` 放行策略仅覆盖文档端点，不扩大业务接口匿名范围。

## 4.5 自动化校验

1. 启动后校验 `/api/v3/api-docs` 可访问。
2. 增加测试断言（或脚本检查）：
   - 端点存在 `summary`
   - 关键 DTO 存在字段描述
   - 核心接口存在示例对象
3. 对比 Controller 映射数量与 OpenAPI path 数量，避免漏文档。

## 5. 分阶段任务拆分

## 5.1 阶段 A：冻结删除矩阵

1. 联通 Consul + grpcurl，补齐第三方能力矩阵。
2. 形成“接口级删除/保留/迁移”清单并评审通过。

## 5.2 阶段 B：后端重构

1. 下线本地重叠 Controller/Service/Repository/Entity。
2. 接入第三方服务调用层（Consul 发现 + gRPC 客户端）。
3. 删除失效配置项与初始化数据。

## 5.3 阶段 C：前端收口

1. 移除管理端与设置端的重叠功能入口和页面。
2. 统一改为第三方能力入口或只读展示（按评审结果）。

## 5.4 阶段 D：Swagger 全量补齐

1. 补齐所有保留接口的 Swagger 注解与示例。
2. 校验 OpenAPI 结构与 Swagger UI 展示。

## 5.5 阶段 E：回归与发布准备

1. 完成关键路径回归（登录、创作、素材、世界观、管理）。
2. 完成文档一致性检查（设计文档、`doc/api`、OpenAPI）。

## 6. 验收清单

1. 代码层不再保留重复核心实现。
2. 前端不再暴露本地 AI 配置与本地接口状态监控入口。
3. 全部存量 REST 接口具备规范 Swagger 文档。
4. OpenAPI 示例可直接用于接口调试与联调。
5. 相关文档（本目录）与项目结构文档已更新。
