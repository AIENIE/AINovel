# 数据库变更总览

## 文档信息

| 字段 | 值 |
|------|-----|
| 版本 | v2.0 |
| 日期 | 2026-02-17 |
| 说明 | 汇总 v2 全部模块的数据库变更，含 MySQL 新增表 DDL、Neo4j Schema、现有表修改及索引建议 |

---

## 1. 变更概览

### 1.1 MySQL 新增表汇总

v2 共新增 **24 张** MySQL 表，按模块分布如下：

| 序号 | 表名 | 所属模块 | 来源文档 | 说明 |
|------|------|----------|----------|------|
| 1 | `lorebook_entries` | 上下文记忆 | 01 § 3.1.1 | Lorebook 世界观条目 |
| 2 | `context_snapshots` | 上下文记忆 | 01 § 3.1.1 | 场景上下文快照 |
| 3 | `entity_extractions` | 上下文记忆 | 01 § 3.1.1 | AI 实体提取记录 |
| 4 | `style_profiles` | 风格画像 | 02 § 3.1.2 | 风格画像定义 |
| 5 | `style_profile_scene_overrides` | 风格画像 | 02 § 3.1.3 | 场景模式风格覆盖 |
| 6 | `character_voices` | 角色声音 | 02 § 3.1.4 | 角色语言个性化 |
| 7 | `style_analysis_jobs` | 风格画像 | 02 § 3.1.5 | 风格分析异步任务 |
| 8 | `beta_reader_reports` | Beta Reader | 03 § 3.1.2 | AI 审读分析报告 |
| 9 | `continuity_issues` | 连续性检查 | 03 § 3.1.3 | 连续性问题追踪 |
| 10 | `analysis_jobs` | Beta Reader | 03 § 3.1.4 | 分析异步任务 |
| 11 | `manuscript_versions` | 版本控制 | 04 § 3.1.1 | 稿件版本快照 |
| 12 | `manuscript_branches` | 版本控制 | 04 § 3.1.2 | 稿件分支管理 |
| 13 | `version_diffs` | 版本控制 | 04 § 3.1.3 | 版本差异缓存 |
| 14 | `auto_save_config` | 版本控制 | 04 § 3.1.4 | 用户自动保存配置 |
| 15 | `export_templates` | 稿件导出 | 05 § 3.1.1 | 导出格式模板 |
| 16 | `export_jobs` | 稿件导出 | 05 § 3.1.2 | 导出异步任务 |
| 17 | `model_registry` | 多模型协作 | 06 § 3.1.1 | 模型注册表 |
| 18 | `task_model_routing` | 多模型协作 | 06 § 3.1.1 | 任务模型路由 |
| 19 | `user_model_preferences` | 多模型协作 | 06 § 3.1.1 | 用户模型偏好 |
| 20 | `model_usage_logs` | 多模型协作 | 06 § 3.1.1 | 模型使用日志 |
| 21 | `workspace_layouts` | 工作台 | 07 § 3.1.1 | 工作台布局配置 |
| 22 | `writing_sessions` | 工作台 | 07 § 3.1.2 | 写作会话追踪 |
| 23 | `writing_goals` | 工作台 | 07 § 3.1.3 | 写作目标 |
| 24 | `keyboard_shortcuts` | 工作台 | 07 § 3.1.4 | 快捷键配置 |

### 1.2 MySQL 现有表修改

| 表名 | 修改内容 | 来源模块 |
|------|----------|----------|
| `manuscripts` | 新增 `current_branch_id CHAR(36)` 字段，指向当前活跃分支 | 版本控制 (04) |
| `character_cards` | 逻辑关联 `character_voices`（通过 FK，不改表结构） | 角色声音 (02) |

### 1.3 Neo4j 节点与关系

来源：→ 见 `01-上下文记忆系统.md` § 3.1.2

| 类型 | 名称 | 关键属性 |
|------|------|----------|
| 节点 | `:Character` | id, name, storyId, aliases, description, status |
| 节点 | `:Location` | id, name, storyId, description, locationType |
| 节点 | `:Event` | id, name, storyId, chapterIndex, description |
| 节点 | `:Item` | id, name, storyId, description |
| 节点 | `:Concept` | id, name, storyId, description |
| 关系 | `(Character)-[:KNOWS]->(Character)` | since, relationship_type |
| 关系 | `(Character)-[:LOCATED_AT]->(Location)` | chapterIndex |
| 关系 | `(Character)-[:PARTICIPATES_IN]->(Event)` | role |
| 关系 | `(Character)-[:POSSESSES]->(Item)` | — |
| 关系 | `(Event)-[:OCCURS_AT]->(Location)` | — |
| 关系 | `(Event)-[:FOLLOWS]->(Event)` | — |

---

## 2. 完整 DDL（MySQL）

> 以下 DDL 从各模块文档中提取整合，统一使用 `utf8mb4_unicode_ci` 字符集、InnoDB 引擎。
> 主键均为 `CHAR(36)` UUID 格式，与现有 v1 表保持一致。

### 2.1 上下文记忆系统（→ 见 `01-上下文记忆系统.md` § 3.1）

```sql
CREATE TABLE lorebook_entries (
    id              CHAR(36)        NOT NULL    COMMENT '主键 UUID',
    story_id        CHAR(36)        NOT NULL    COMMENT '所属故事 FK -> stories.id',
    user_id         CHAR(36)        NOT NULL    COMMENT '创建用户 FK -> users.id',
    entry_key       VARCHAR(200)    NOT NULL    COMMENT '条目标识键（主触发词）',
    display_name    VARCHAR(200)    NOT NULL    COMMENT '显示名称',
    category        ENUM('character','location','item','event','concept','custom')
                                    NOT NULL DEFAULT 'custom'
                                                COMMENT '条目类别',
    content         TEXT            NOT NULL    COMMENT '条目正文内容（注入到 Prompt 的文本）',
    keywords_json   TEXT            NULL        COMMENT '触发关键词 JSON 数组',
    priority        INT             NOT NULL DEFAULT 0   COMMENT '注入优先级，数值越大越优先',
    enabled         TINYINT(1)      NOT NULL DEFAULT 1   COMMENT '是否启用',
    insertion_position ENUM('before_scene','after_scene','system_prompt')
                                    NOT NULL DEFAULT 'before_scene' COMMENT '注入位置',
    token_budget    INT             NOT NULL DEFAULT 500  COMMENT '该条目最大 Token 数',
    created_at      TIMESTAMP       NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at      TIMESTAMP       NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    PRIMARY KEY (id),
    INDEX idx_lorebook_story (story_id),
    INDEX idx_lorebook_user (user_id),
    INDEX idx_lorebook_category (story_id, category),
    INDEX idx_lorebook_enabled (story_id, enabled),
    CONSTRAINT fk_lorebook_story FOREIGN KEY (story_id) REFERENCES stories(id) ON DELETE CASCADE,
    CONSTRAINT fk_lorebook_user  FOREIGN KEY (user_id)  REFERENCES users(id)   ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='Lorebook 世界观条目表';

CREATE TABLE context_snapshots (
    id                      CHAR(36)        NOT NULL    COMMENT '主键 UUID',
    story_id                CHAR(36)        NOT NULL    COMMENT '所属故事 FK -> stories.id',
    manuscript_id           CHAR(36)        NULL        COMMENT '关联稿件 FK -> manuscripts.id',
    chapter_index           INT             NOT NULL    COMMENT '章节序号',
    scene_index             INT             NOT NULL    COMMENT '场景序号',
    active_characters_json  TEXT            NULL        COMMENT '当前场景活跃角色 JSON',
    active_locations_json   TEXT            NULL        COMMENT '当前场景活跃地点 JSON',
    timeline_position       VARCHAR(200)    NULL        COMMENT '时间线位置描述',
    summary                 TEXT            NULL        COMMENT 'AI 生成的场景摘要',
    emotional_tone          VARCHAR(100)    NULL        COMMENT '场景情感基调',
    word_count              INT             NOT NULL DEFAULT 0 COMMENT '该场景字数',
    created_at              TIMESTAMP       NOT NULL DEFAULT CURRENT_TIMESTAMP,
    PRIMARY KEY (id),
    INDEX idx_snapshot_story (story_id),
    INDEX idx_snapshot_chapter_scene (story_id, chapter_index, scene_index),
    CONSTRAINT fk_snapshot_story FOREIGN KEY (story_id) REFERENCES stories(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='场景上下文快照表';

CREATE TABLE entity_extractions (
    id              CHAR(36)        NOT NULL    COMMENT '主键 UUID',
    story_id        CHAR(36)        NOT NULL    COMMENT '所属故事 FK -> stories.id',
    manuscript_id   CHAR(36)        NULL        COMMENT '来源稿件 FK -> manuscripts.id',
    entity_name     VARCHAR(200)    NOT NULL    COMMENT '实体名称',
    entity_type     VARCHAR(50)     NOT NULL    COMMENT '实体类型',
    attributes_json TEXT            NULL        COMMENT '实体属性 JSON',
    source_text     TEXT            NULL        COMMENT '提取来源原文片段',
    confidence      FLOAT           NOT NULL DEFAULT 0.0 COMMENT 'AI 提取置信度 0.0-1.0',
    reviewed        TINYINT(1)      NOT NULL DEFAULT 0   COMMENT '是否已人工审核',
    review_action   ENUM('pending','approved','rejected','merged')
                                    NOT NULL DEFAULT 'pending' COMMENT '审核动作',
    linked_lorebook_id CHAR(36)     NULL        COMMENT '关联的 Lorebook 条目',
    created_at      TIMESTAMP       NOT NULL DEFAULT CURRENT_TIMESTAMP,
    PRIMARY KEY (id),
    INDEX idx_extraction_story (story_id),
    INDEX idx_extraction_manuscript (manuscript_id),
    INDEX idx_extraction_type (story_id, entity_type),
    INDEX idx_extraction_review (story_id, reviewed),
    CONSTRAINT fk_extraction_story FOREIGN KEY (story_id) REFERENCES stories(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='AI 实体提取记录表';
```

### 2.2 风格画像与角色声音（→ 见 `02-风格画像与角色声音.md` § 3.1）

```sql
CREATE TABLE style_profiles (
    id              CHAR(36)        NOT NULL COMMENT '主键 UUID',
    user_id         CHAR(36)        NOT NULL COMMENT '所属用户',
    story_id        CHAR(36)        NULL     COMMENT '所属故事；NULL 表示全局画像',
    name            VARCHAR(100)    NOT NULL COMMENT '画像名称',
    profile_type    ENUM('narrative','dialogue','global')
                                    NOT NULL DEFAULT 'global' COMMENT '画像类型',
    dimensions_json TEXT            NULL     COMMENT '风格维度 JSON',
    sample_text     TEXT            NULL     COMMENT '参考风格样本文本',
    ai_analysis_json TEXT           NULL     COMMENT 'AI 生成的风格分析结果 JSON',
    is_active       TINYINT(1)      NOT NULL DEFAULT 0 COMMENT '是否为当前激活画像',
    created_at      TIMESTAMP       NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at      TIMESTAMP       NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    PRIMARY KEY (id),
    INDEX idx_sp_user (user_id),
    INDEX idx_sp_story (story_id),
    INDEX idx_sp_active (story_id, is_active),
    CONSTRAINT fk_sp_user  FOREIGN KEY (user_id)  REFERENCES users(id)   ON DELETE CASCADE,
    CONSTRAINT fk_sp_story FOREIGN KEY (story_id)  REFERENCES stories(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='风格画像';

CREATE TABLE style_profile_scene_overrides (
    id              CHAR(36)        NOT NULL COMMENT '主键 UUID',
    style_profile_id CHAR(36)       NOT NULL COMMENT '所属风格画像',
    scene_type      ENUM('action','dialogue','introspection','description','flashback')
                                    NOT NULL COMMENT '场景类型',
    override_json   TEXT            NOT NULL COMMENT '覆盖的维度 JSON',
    created_at      TIMESTAMP       NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at      TIMESTAMP       NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    PRIMARY KEY (id),
    UNIQUE KEY uk_profile_scene (style_profile_id, scene_type),
    CONSTRAINT fk_spso_profile FOREIGN KEY (style_profile_id) REFERENCES style_profiles(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='风格画像场景模式覆盖';

CREATE TABLE character_voices (
    id                  CHAR(36)        NOT NULL COMMENT '主键 UUID',
    character_card_id   CHAR(36)        NOT NULL COMMENT '关联角色卡',
    story_id            CHAR(36)        NOT NULL COMMENT '所属故事',
    speech_pattern      TEXT            NULL     COMMENT '说话方式描述',
    vocabulary_level    VARCHAR(50)     NULL     COMMENT '词汇水平',
    catchphrases_json   TEXT            NULL     COMMENT '口头禅 JSON 数组',
    emotional_range_json TEXT           NULL     COMMENT '情感表达方式 JSON',
    dialect             VARCHAR(100)    NULL     COMMENT '方言/社会语域',
    sample_dialogues_json TEXT          NULL     COMMENT '示例对话 JSON 数组',
    ai_analysis_json    TEXT            NULL     COMMENT 'AI 生成的声音分析 JSON',
    created_at          TIMESTAMP       NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at          TIMESTAMP       NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    PRIMARY KEY (id),
    UNIQUE KEY uk_cv_character (character_card_id),
    INDEX idx_cv_story (story_id),
    CONSTRAINT fk_cv_character FOREIGN KEY (character_card_id) REFERENCES character_cards(id) ON DELETE CASCADE,
    CONSTRAINT fk_cv_story     FOREIGN KEY (story_id)          REFERENCES stories(id)         ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='角色声音';

CREATE TABLE style_analysis_jobs (
    id               CHAR(36)        NOT NULL COMMENT '主键 UUID',
    user_id          CHAR(36)        NOT NULL COMMENT '发起用户',
    source_type      ENUM('manuscript','uploaded_text','url')
                                     NOT NULL COMMENT '分析来源类型',
    source_reference TEXT            NOT NULL COMMENT '来源引用',
    status           ENUM('pending','processing','completed','failed')
                                     NOT NULL DEFAULT 'pending',
    result_json      TEXT            NULL     COMMENT '分析结果 JSON',
    error_message    VARCHAR(500)    NULL     COMMENT '失败原因',
    created_at       TIMESTAMP       NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at       TIMESTAMP       NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    PRIMARY KEY (id),
    INDEX idx_saj_user (user_id),
    INDEX idx_saj_status (status),
    CONSTRAINT fk_saj_user FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='风格分析任务';
```

### 2.3 AI Beta Reader 与连续性检查（→ 见 `03-AI-Beta-Reader与连续性检查.md` § 3.1）

```sql
CREATE TABLE beta_reader_reports (
    id                  CHAR(36)        NOT NULL    COMMENT '主键 UUID',
    story_id            CHAR(36)        NOT NULL    COMMENT '所属故事 FK -> stories.id',
    user_id             CHAR(36)        NOT NULL    COMMENT '发起用户 FK -> users.id',
    scope               ENUM('chapter','full_manuscript','scene')
                                        NOT NULL    COMMENT '分析范围',
    scope_reference     VARCHAR(200)    NULL        COMMENT '范围引用',
    status              ENUM('pending','analyzing','completed','failed')
                                        NOT NULL DEFAULT 'pending' COMMENT '报告状态',
    analysis_json       LONGTEXT        NULL        COMMENT '完整分析结果 JSON',
    summary             TEXT            NULL        COMMENT '执行摘要',
    score_overall       INT             NULL        COMMENT '综合评分 1-100',
    score_pacing        INT             NULL        COMMENT '叙事节奏评分',
    score_characters    INT             NULL        COMMENT '角色塑造评分',
    score_dialogue      INT             NULL        COMMENT '对话质量评分',
    score_consistency   INT             NULL        COMMENT '情节连贯性评分',
    score_engagement    INT             NULL        COMMENT '读者吸引力评分',
    token_cost          INT             NOT NULL DEFAULT 0 COMMENT '消耗 Token 数',
    created_at          TIMESTAMP       NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at          TIMESTAMP       NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    PRIMARY KEY (id),
    INDEX idx_brr_story (story_id),
    INDEX idx_brr_user (user_id),
    INDEX idx_brr_status (story_id, status),
    INDEX idx_brr_created (story_id, created_at DESC),
    CONSTRAINT fk_brr_story FOREIGN KEY (story_id) REFERENCES stories(id) ON DELETE CASCADE,
    CONSTRAINT fk_brr_user  FOREIGN KEY (user_id)  REFERENCES users(id)   ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='AI Beta Reader 分析报告';

CREATE TABLE continuity_issues (
    id                  CHAR(36)        NOT NULL    COMMENT '主键 UUID',
    story_id            CHAR(36)        NOT NULL    COMMENT '所属故事',
    report_id           CHAR(36)        NULL        COMMENT '来源报告 FK -> beta_reader_reports.id',
    issue_type          ENUM('character_inconsistency','timeline_error','location_error',
                             'object_state','plot_hole','dead_character','name_inconsistency')
                                        NOT NULL    COMMENT '问题类型',
    severity            ENUM('critical','warning','info')
                                        NOT NULL DEFAULT 'warning' COMMENT '严重程度',
    description         TEXT            NOT NULL    COMMENT '问题描述',
    evidence_json       TEXT            NULL        COMMENT '证据 JSON 数组',
    suggestion          TEXT            NULL        COMMENT '修复建议',
    status              ENUM('open','acknowledged','resolved','false_positive')
                                        NOT NULL DEFAULT 'open' COMMENT '问题状态',
    resolved_at         TIMESTAMP       NULL        COMMENT '解决时间',
    created_at          TIMESTAMP       NOT NULL DEFAULT CURRENT_TIMESTAMP,
    PRIMARY KEY (id),
    INDEX idx_ci_story (story_id),
    INDEX idx_ci_report (report_id),
    INDEX idx_ci_type (story_id, issue_type),
    INDEX idx_ci_status (story_id, status),
    CONSTRAINT fk_ci_story  FOREIGN KEY (story_id)  REFERENCES stories(id)             ON DELETE CASCADE,
    CONSTRAINT fk_ci_report FOREIGN KEY (report_id) REFERENCES beta_reader_reports(id) ON DELETE SET NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='连续性问题追踪表';

CREATE TABLE analysis_jobs (
    id                  CHAR(36)        NOT NULL    COMMENT '主键 UUID',
    story_id            CHAR(36)        NOT NULL    COMMENT '所属故事',
    user_id             CHAR(36)        NOT NULL    COMMENT '发起用户',
    job_type            ENUM('beta_reader','continuity_check','style_check')
                                        NOT NULL    COMMENT '任务类型',
    scope               ENUM('chapter','full','scene')
                                        NOT NULL    COMMENT '分析范围',
    scope_reference     VARCHAR(200)    NULL        COMMENT '范围引用',
    status              ENUM('queued','processing','completed','failed')
                                        NOT NULL DEFAULT 'queued' COMMENT '任务状态',
    progress            INT             NOT NULL DEFAULT 0 COMMENT '进度百分比 0-100',
    progress_message    VARCHAR(500)    NULL        COMMENT '当前进度描述',
    result_reference    CHAR(36)        NULL        COMMENT '结果引用：报告ID',
    error_message       TEXT            NULL        COMMENT '失败原因',
    created_at          TIMESTAMP       NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at          TIMESTAMP       NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    PRIMARY KEY (id),
    INDEX idx_aj_story (story_id),
    INDEX idx_aj_user (user_id),
    INDEX idx_aj_status (story_id, status),
    CONSTRAINT fk_aj_story FOREIGN KEY (story_id) REFERENCES stories(id) ON DELETE CASCADE,
    CONSTRAINT fk_aj_user  FOREIGN KEY (user_id)  REFERENCES users(id)   ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='分析异步任务表';
```

### 2.4 版本控制系统（→ 见 `04-版本控制系统.md` § 3.1）

```sql
CREATE TABLE manuscript_branches (
    id                  CHAR(36)        NOT NULL    COMMENT '主键 UUID',
    manuscript_id       CHAR(36)        NOT NULL    COMMENT '所属稿件 FK -> manuscripts.id',
    name                VARCHAR(100)    NOT NULL    COMMENT '分支名称',
    description         TEXT            NULL        COMMENT '分支描述',
    source_version_id   CHAR(36)        NULL        COMMENT '分支起点版本',
    status              ENUM('active','merged','abandoned')
                                        NOT NULL DEFAULT 'active' COMMENT '分支状态',
    is_main             TINYINT(1)      NOT NULL DEFAULT 0 COMMENT '是否为主分支',
    created_at          TIMESTAMP       NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at          TIMESTAMP       NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    PRIMARY KEY (id),
    INDEX idx_branch_manuscript (manuscript_id),
    UNIQUE INDEX uk_branch_name (manuscript_id, name),
    CONSTRAINT fk_branch_manuscript FOREIGN KEY (manuscript_id) REFERENCES manuscripts(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='稿件分支表';

CREATE TABLE manuscript_versions (
    id                  CHAR(36)        NOT NULL    COMMENT '主键 UUID',
    manuscript_id       CHAR(36)        NOT NULL    COMMENT '所属稿件',
    branch_id           CHAR(36)        NOT NULL    COMMENT '所属分支',
    version_number      INT             NOT NULL    COMMENT '版本序号（分支内递增）',
    label               VARCHAR(200)    NULL        COMMENT '用户自定义标签',
    snapshot_type       ENUM('auto','manual','branch_point','merge')
                                        NOT NULL DEFAULT 'auto' COMMENT '快照类型',
    content_hash        VARCHAR(64)     NOT NULL    COMMENT 'SHA-256 哈希',
    sections_json       LONGTEXT        NOT NULL    COMMENT '完整 sectionsJson 快照',
    metadata_json       TEXT            NULL        COMMENT '版本元数据 JSON',
    parent_version_id   CHAR(36)        NULL        COMMENT '父版本（自引用）',
    created_by          CHAR(36)        NOT NULL    COMMENT '创建用户',
    created_at          TIMESTAMP       NOT NULL DEFAULT CURRENT_TIMESTAMP,
    PRIMARY KEY (id),
    INDEX idx_version_manuscript (manuscript_id),
    INDEX idx_version_branch (branch_id),
    INDEX idx_version_hash (manuscript_id, content_hash),
    CONSTRAINT fk_version_manuscript FOREIGN KEY (manuscript_id) REFERENCES manuscripts(id) ON DELETE CASCADE,
    CONSTRAINT fk_version_branch    FOREIGN KEY (branch_id)     REFERENCES manuscript_branches(id) ON DELETE CASCADE,
    CONSTRAINT fk_version_parent    FOREIGN KEY (parent_version_id) REFERENCES manuscript_versions(id) ON DELETE SET NULL,
    CONSTRAINT fk_version_user      FOREIGN KEY (created_by)    REFERENCES users(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='稿件版本快照表';

CREATE TABLE version_diffs (
    id                  CHAR(36)        NOT NULL    COMMENT '主键 UUID',
    from_version_id     CHAR(36)        NOT NULL    COMMENT '起始版本',
    to_version_id       CHAR(36)        NOT NULL    COMMENT '目标版本',
    diff_json           LONGTEXT        NOT NULL    COMMENT '预计算差异结果 JSON',
    created_at          TIMESTAMP       NOT NULL DEFAULT CURRENT_TIMESTAMP,
    PRIMARY KEY (id),
    UNIQUE INDEX uk_diff_pair (from_version_id, to_version_id),
    CONSTRAINT fk_diff_from FOREIGN KEY (from_version_id) REFERENCES manuscript_versions(id) ON DELETE CASCADE,
    CONSTRAINT fk_diff_to   FOREIGN KEY (to_version_id)   REFERENCES manuscript_versions(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='版本差异缓存表';

CREATE TABLE auto_save_config (
    id                          CHAR(36)    NOT NULL    COMMENT '主键 UUID',
    user_id                     CHAR(36)    NOT NULL    COMMENT '用户',
    auto_save_interval_seconds  INT         NOT NULL DEFAULT 300 COMMENT '自动快照最小间隔（秒）',
    max_auto_versions           INT         NOT NULL DEFAULT 100 COMMENT '每稿件每分支自动快照上限',
    created_at                  TIMESTAMP   NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at                  TIMESTAMP   NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    PRIMARY KEY (id),
    UNIQUE INDEX uk_config_user (user_id),
    CONSTRAINT fk_config_user FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='用户自动保存配置表';
```

### 2.5 稿件导出系统（→ 见 `05-稿件导出系统.md` § 3.1）

```sql
CREATE TABLE export_templates (
    id              CHAR(36)        NOT NULL    COMMENT '主键 UUID',
    user_id         CHAR(36)        NULL        COMMENT '所属用户；NULL 表示系统预设模板',
    name            VARCHAR(100)    NOT NULL    COMMENT '模板名称',
    description     VARCHAR(500)    NULL        COMMENT '模板描述',
    format          ENUM('txt','docx','epub','pdf')
                                    NOT NULL    COMMENT '目标格式',
    config_json     TEXT            NOT NULL    COMMENT '格式专属配置 JSON',
    is_default      BOOLEAN         NOT NULL DEFAULT FALSE COMMENT '是否为该格式的默认模板',
    created_at      TIMESTAMP       NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at      TIMESTAMP       NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    PRIMARY KEY (id),
    INDEX idx_export_tpl_user (user_id),
    INDEX idx_export_tpl_format (format),
    CONSTRAINT fk_export_tpl_user FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='导出模板表';

CREATE TABLE export_jobs (
    id              CHAR(36)        NOT NULL    COMMENT '主键 UUID',
    user_id         CHAR(36)        NOT NULL    COMMENT '发起用户',
    story_id        CHAR(36)        NOT NULL    COMMENT '所属故事',
    manuscript_id   CHAR(36)        NOT NULL    COMMENT '导出稿件',
    template_id     CHAR(36)        NULL        COMMENT '使用模板',
    format          ENUM('txt','docx','epub','pdf')
                                    NOT NULL    COMMENT '导出格式',
    config_json     TEXT            NOT NULL    COMMENT '本次导出的完整配置快照',
    chapter_range   VARCHAR(200)    NULL        COMMENT '章节范围',
    status          ENUM('queued','processing','completed','failed')
                                    NOT NULL DEFAULT 'queued' COMMENT '任务状态',
    progress        INT             NOT NULL DEFAULT 0 COMMENT '进度百分比',
    file_path       VARCHAR(500)    NULL        COMMENT '生成文件存储路径',
    file_name       VARCHAR(300)    NULL        COMMENT '下载文件名',
    file_size_bytes BIGINT          NULL        COMMENT '文件大小（字节）',
    error_message   TEXT            NULL        COMMENT '错误信息',
    expires_at      TIMESTAMP       NULL        COMMENT '文件过期时间',
    created_at      TIMESTAMP       NOT NULL DEFAULT CURRENT_TIMESTAMP,
    PRIMARY KEY (id),
    INDEX idx_export_job_user (user_id),
    INDEX idx_export_job_story (story_id),
    INDEX idx_export_job_status (status),
    INDEX idx_export_job_expires (expires_at),
    CONSTRAINT fk_export_job_user       FOREIGN KEY (user_id)       REFERENCES users(id)            ON DELETE CASCADE,
    CONSTRAINT fk_export_job_story      FOREIGN KEY (story_id)      REFERENCES stories(id)          ON DELETE CASCADE,
    CONSTRAINT fk_export_job_manuscript FOREIGN KEY (manuscript_id)  REFERENCES manuscripts(id)      ON DELETE CASCADE,
    CONSTRAINT fk_export_job_template   FOREIGN KEY (template_id)   REFERENCES export_templates(id)  ON DELETE SET NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='导出任务表';
```

### 2.6 多模型协作（→ 见 `06-多模型协作.md` § 3.1）

```sql
CREATE TABLE model_registry (
    id                  CHAR(36)        NOT NULL    COMMENT '主键 UUID',
    model_key           VARCHAR(100)    NOT NULL    COMMENT '模型唯一标识',
    display_name        VARCHAR(200)    NOT NULL    COMMENT '前端展示名称',
    provider            VARCHAR(50)     NOT NULL    COMMENT '模型提供方',
    capabilities_json   TEXT            NULL        COMMENT '能力标签 JSON 数组',
    max_context_tokens  INT             NOT NULL DEFAULT 0 COMMENT '最大上下文 Token 数',
    max_output_tokens   INT             NOT NULL DEFAULT 0 COMMENT '最大输出 Token 数',
    cost_per_1k_input   DECIMAL(10,6)   NOT NULL DEFAULT 0 COMMENT '每千输入 Token 成本（美元）',
    cost_per_1k_output  DECIMAL(10,6)   NOT NULL DEFAULT 0 COMMENT '每千输出 Token 成本（美元）',
    supports_streaming  BOOLEAN         NOT NULL DEFAULT TRUE  COMMENT '是否支持流式输出',
    is_available        BOOLEAN         NOT NULL DEFAULT TRUE  COMMENT '是否当前可用',
    priority            INT             NOT NULL DEFAULT 0     COMMENT '排序优先级',
    created_at          TIMESTAMP       NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at          TIMESTAMP       NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    PRIMARY KEY (id),
    UNIQUE KEY uk_model_key (model_key),
    INDEX idx_provider (provider),
    INDEX idx_available_priority (is_available, priority DESC)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='模型注册表';

CREATE TABLE task_model_routing (
    id                      CHAR(36)        NOT NULL    COMMENT '主键 UUID',
    task_type               VARCHAR(50)     NOT NULL    COMMENT '任务类型',
    recommended_model_id    CHAR(36)        NOT NULL    COMMENT '推荐模型',
    fallback_model_id       CHAR(36)        NULL        COMMENT '备选模型',
    routing_strategy        VARCHAR(30)     NOT NULL DEFAULT 'fixed' COMMENT '路由策略',
    config_json             TEXT            NULL        COMMENT '策略附加配置',
    created_at              TIMESTAMP       NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at              TIMESTAMP       NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    PRIMARY KEY (id),
    UNIQUE KEY uk_task_type (task_type),
    CONSTRAINT fk_routing_recommended FOREIGN KEY (recommended_model_id) REFERENCES model_registry(id),
    CONSTRAINT fk_routing_fallback    FOREIGN KEY (fallback_model_id)    REFERENCES model_registry(id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='任务模型路由表';

CREATE TABLE user_model_preferences (
    id                  CHAR(36)        NOT NULL    COMMENT '主键 UUID',
    user_id             CHAR(36)        NOT NULL    COMMENT '用户',
    task_type           VARCHAR(50)     NOT NULL    COMMENT '任务类型',
    preferred_model_id  CHAR(36)        NULL        COMMENT '偏好模型',
    created_at          TIMESTAMP       NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at          TIMESTAMP       NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    PRIMARY KEY (id),
    UNIQUE KEY uk_user_task (user_id, task_type),
    CONSTRAINT fk_pref_model FOREIGN KEY (preferred_model_id) REFERENCES model_registry(id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='用户模型偏好表';

CREATE TABLE model_usage_logs (
    id              CHAR(36)        NOT NULL    COMMENT '主键 UUID',
    user_id         CHAR(36)        NOT NULL    COMMENT '用户',
    story_id        CHAR(36)        NULL        COMMENT '关联故事',
    model_id        CHAR(36)        NOT NULL    COMMENT '实际使用模型',
    task_type       VARCHAR(50)     NOT NULL    COMMENT '任务类型',
    input_tokens    INT             NOT NULL DEFAULT 0 COMMENT '输入 Token 数',
    output_tokens   INT             NOT NULL DEFAULT 0 COMMENT '输出 Token 数',
    latency_ms      INT             NOT NULL DEFAULT 0 COMMENT '调用延迟（毫秒）',
    cost_estimate   DECIMAL(10,6)   NOT NULL DEFAULT 0 COMMENT '预估成本（美元）',
    success         BOOLEAN         NOT NULL DEFAULT TRUE COMMENT '是否成功',
    error_message   TEXT            NULL        COMMENT '错误信息',
    created_at      TIMESTAMP       NOT NULL DEFAULT CURRENT_TIMESTAMP,
    PRIMARY KEY (id),
    INDEX idx_user_created (user_id, created_at DESC),
    INDEX idx_story (story_id),
    INDEX idx_model_task (model_id, task_type),
    CONSTRAINT fk_usage_model FOREIGN KEY (model_id) REFERENCES model_registry(id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='模型使用日志表';
```

### 2.7 工作台与体验优化（→ 见 `07-工作台与体验优化.md` § 3.1）

```sql
CREATE TABLE workspace_layouts (
    id              CHAR(36)        NOT NULL    COMMENT '主键 UUID',
    user_id         CHAR(36)        NOT NULL    COMMENT '所属用户',
    name            VARCHAR(100)    NOT NULL    COMMENT '布局名称',
    layout_json     TEXT            NOT NULL    COMMENT '面板布局配置 JSON',
    is_active       TINYINT(1)      NOT NULL DEFAULT 0 COMMENT '是否为当前激活布局',
    created_at      TIMESTAMP       NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at      TIMESTAMP       NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    PRIMARY KEY (id),
    INDEX idx_layout_user (user_id),
    INDEX idx_layout_active (user_id, is_active),
    CONSTRAINT fk_layout_user FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='工作台布局配置表';

CREATE TABLE writing_sessions (
    id                  CHAR(36)        NOT NULL    COMMENT '主键 UUID',
    user_id             CHAR(36)        NOT NULL    COMMENT '所属用户',
    story_id            CHAR(36)        NOT NULL    COMMENT '关联故事',
    started_at          TIMESTAMP       NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '会话开始时间',
    ended_at            TIMESTAMP       NULL        COMMENT '会话结束时间',
    words_written       INT             NOT NULL DEFAULT 0 COMMENT '新增字数',
    words_deleted       INT             NOT NULL DEFAULT 0 COMMENT '删除字数',
    net_words           INT             NOT NULL DEFAULT 0 COMMENT '净增字数',
    duration_seconds    INT             NOT NULL DEFAULT 0 COMMENT '有效写作时长（秒）',
    chapters_edited_json TEXT           NULL        COMMENT '编辑的章节/场景 JSON',
    PRIMARY KEY (id),
    INDEX idx_session_user (user_id),
    INDEX idx_session_story (user_id, story_id),
    INDEX idx_session_time (user_id, started_at),
    CONSTRAINT fk_session_user  FOREIGN KEY (user_id)  REFERENCES users(id)   ON DELETE CASCADE,
    CONSTRAINT fk_session_story FOREIGN KEY (story_id)  REFERENCES stories(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='写作会话追踪表';

CREATE TABLE writing_goals (
    id              CHAR(36)        NOT NULL    COMMENT '主键 UUID',
    user_id         CHAR(36)        NOT NULL    COMMENT '所属用户',
    story_id        CHAR(36)        NULL        COMMENT '关联故事（NULL 表示全局目标）',
    goal_type       ENUM('daily_words','session_words','chapter_deadline','total_words')
                                    NOT NULL    COMMENT '目标类型',
    target_value    INT             NOT NULL    COMMENT '目标值',
    current_value   INT             NOT NULL DEFAULT 0 COMMENT '当前进度值',
    deadline        DATE            NULL        COMMENT '截止日期',
    status          ENUM('active','completed','expired')
                                    NOT NULL DEFAULT 'active' COMMENT '目标状态',
    created_at      TIMESTAMP       NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at      TIMESTAMP       NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    PRIMARY KEY (id),
    INDEX idx_goal_user (user_id),
    INDEX idx_goal_status (user_id, status),
    CONSTRAINT fk_goal_user  FOREIGN KEY (user_id)  REFERENCES users(id)   ON DELETE CASCADE,
    CONSTRAINT fk_goal_story FOREIGN KEY (story_id)  REFERENCES stories(id) ON DELETE SET NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='写作目标表';

CREATE TABLE keyboard_shortcuts (
    id              CHAR(36)        NOT NULL    COMMENT '主键 UUID',
    user_id         CHAR(36)        NOT NULL    COMMENT '所属用户',
    action          VARCHAR(100)    NOT NULL    COMMENT '操作标识',
    shortcut        VARCHAR(50)     NOT NULL    COMMENT '快捷键组合',
    is_custom       TINYINT(1)      NOT NULL DEFAULT 0 COMMENT '是否为用户自定义',
    created_at      TIMESTAMP       NOT NULL DEFAULT CURRENT_TIMESTAMP,
    PRIMARY KEY (id),
    INDEX idx_shortcut_user (user_id),
    UNIQUE INDEX uk_shortcut_user_action (user_id, action),
    CONSTRAINT fk_shortcut_user FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='快捷键配置表';
```

---

## 3. Neo4j Schema（→ 见 `01-上下文记忆系统.md` § 3.1.2）

```cypher
-- 约束与索引
CREATE CONSTRAINT character_id IF NOT EXISTS FOR (c:Character) REQUIRE c.id IS UNIQUE;
CREATE CONSTRAINT location_id IF NOT EXISTS FOR (l:Location) REQUIRE l.id IS UNIQUE;
CREATE CONSTRAINT event_id IF NOT EXISTS FOR (e:Event) REQUIRE e.id IS UNIQUE;
CREATE CONSTRAINT item_id IF NOT EXISTS FOR (i:Item) REQUIRE i.id IS UNIQUE;
CREATE CONSTRAINT concept_id IF NOT EXISTS FOR (c:Concept) REQUIRE c.id IS UNIQUE;

CREATE INDEX character_story IF NOT EXISTS FOR (c:Character) ON (c.storyId);
CREATE INDEX location_story IF NOT EXISTS FOR (l:Location) ON (l.storyId);
CREATE INDEX event_story IF NOT EXISTS FOR (e:Event) ON (e.storyId);

-- 示例数据
CREATE (c:Character {id: 'uuid', name: '林逸', storyId: 'story-uuid', aliases: ['小逸'], description: '主角', status: 'active'})
CREATE (l:Location {id: 'uuid', name: '青云山', storyId: 'story-uuid', description: '五大宗门之一'})
CREATE (c)-[:KNOWS {since: 0, relationship_type: '师兄弟'}]->(c2:Character {id: 'uuid2', name: '苏瑶'})
CREATE (c)-[:LOCATED_AT {chapterIndex: 0}]->(l)
```

---

## 4. 现有表变更 ALTER 语句

```sql
-- 为 manuscripts 表添加当前分支引用（版本控制模块）
ALTER TABLE manuscripts
    ADD COLUMN current_branch_id CHAR(36) NULL COMMENT '当前活跃分支 FK -> manuscript_branches.id'
    AFTER character_logs_json;

-- 注意：FK 约束需在 manuscript_branches 表创建后添加
ALTER TABLE manuscripts
    ADD CONSTRAINT fk_manuscript_current_branch
    FOREIGN KEY (current_branch_id) REFERENCES manuscript_branches(id) ON DELETE SET NULL;
```

---

## 5. 索引建议

除各表 DDL 中已包含的索引外，以下为基于预期查询模式的补充建议：

| 表名 | 建议索引 | 理由 |
|------|----------|------|
| `lorebook_entries` | `FULLTEXT(content, entry_key)` | 支持全文搜索触发词匹配 |
| `model_usage_logs` | `(created_at)` 按月分区 | 日志量大，按时间分区提升查询性能 |
| `manuscript_versions` | `(manuscript_id, created_at DESC)` | 版本历史按时间倒序查询 |
| `writing_sessions` | `(user_id, started_at DESC)` | 用户写作历史查询 |
| `continuity_issues` | `(story_id, status, created_at DESC)` | 未解决问题列表查询 |

---

## 6. 数据迁移注意事项

1. 现有 `manuscripts` 表数据需初始化版本控制：为每条现有稿件创建默认 `main` 分支和初始版本快照。
2. 现有 `character_cards` 数据不受影响，`character_voices` 为可选扩展。
3. Neo4j 为全新引入，无历史数据迁移需求；可提供批量导入工具从现有 `materials.entitiesJson` 和 `character_cards` 初始化图数据。
4. 所有新表使用 `CHAR(36)` UUID 主键，与现有 v1 表保持一致。
5. 建议使用 Flyway 或 Liquibase 管理 DDL 变更，按模块优先级分批执行。
6. `model_usage_logs` 预期数据量较大，建议上线后评估是否需要按月分表或归档策略。
