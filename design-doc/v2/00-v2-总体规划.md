# AINovel v2 总体规划

## 文档信息

| 字段 | 值 |
|------|-----|
| 版本 | v2.0（规划稿） |
| 创建日期 | 2026-02-17 |
| 作者 | AINovel 架构组 |
| 状态 | Draft |
| 关联文档 | 本目录下 `01` ~ `07` 号设计文档 |

---

## 1. 愿景与目标

### 1.1 产品愿景

AINovel v1 是一个基础的 AI 辅助写作工具，提供了故事构思、大纲生成、正文续写和素材管理等核心能力。v2 的目标是将其升级为**专业级 AI 辅助创作平台**——不仅能帮用户"写出来"，更能帮用户"写得好"、"管得住"、"记得全"。

核心理念：

- **记忆即质量**：上下文记忆系统是写作质量的基石，没有完整的角色/世界/情节记忆，AI 续写必然出现前后矛盾。
- **风格即灵魂**：每部作品应有独立的文风画像，每个角色应有独立的语言声音，AI 生成内容应忠于这些约束。
- **版本即安全**：创作是非线性的，作者需要自由回溯、分支探索，而不必担心丢失任何一个版本。

### 1.2 目标用户画像

| 用户类型 | 核心诉求 | 使用场景 | v2 关键价值 |
|----------|----------|----------|-------------|
| 网文作者 | 日更速度、情节连贯、角色不崩 | 每日 3000-8000 字连载 | 上下文记忆自动注入、角色声音一致性、连续性检查 |
| 文学创作者 | 文风精准、叙事结构、语言质量 | 长篇小说 / 中短篇精修 | 风格画像、AI Beta Reader、多模型协作（质量优先） |
| 爱好者 | 入门引导、灵感激发、成就感 | 周末写作、同人创作 | 智能推荐模板、一键导出成品、知识图谱可视化 |

### 1.3 成功指标

| 指标 | v1 基线 | v2 目标 |
|------|---------|---------|
| 上下文窗口有效利用率 | ~30%（手动拼接） | >80%（KAG 自动检索） |
| 角色一致性（人工评测） | 未度量 | >85% 通过率 |
| 单章生成后需人工修改比例 | ~60% | <35% |
| 导出格式支持 | 无 | EPUB / DOCX / PDF / TXT |
| 版本回溯能力 | 无 | 完整历史 + 分支 |

---

## 2. v1 → v2 架构演进

### 2.1 v1 现状总结

#### 2.1.1 当前架构

```
┌─────────────────────────────────────────────────────────────────┐
│                        用户浏览器                                │
│  React 18 + TypeScript + Vite + shadcn/ui + TailwindCSS         │
│  Tiptap Editor + react-resizable-panels                         │
│  端口: 10010                                                     │
└──────────────────────────┬──────────────────────────────────────┘
                           │ HTTP / REST
┌──────────────────────────▼──────────────────────────────────────┐
│              Spring Boot 3.4.2 (Java 17)                        │
│              端口: 10011    路径前缀: /api                        │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐           │
│  │ Story    │ │ Outline  │ │Manuscript│ │ Material │           │
│  │ Module   │ │ Module   │ │ Module   │ │ Module   │           │
│  └──────────┘ └──────────┘ └──────────┘ └──────────┘           │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐           │
│  │ World    │ │ User /   │ │ Settings │ │ AI       │           │
│  │ Module   │ │ Auth     │ │ Module   │ │ Gateway  │           │
│  └──────────┘ └──────────┘ └──────────┘ └──────────┘           │
└───────┬──────────────┬──────────────┬───────────────────────────┘
        │              │              │
   ┌────▼────┐   ┌─────▼─────┐  ┌────▼──────────────────────┐
   │ MySQL   │   │  Redis    │  │ AIENIE 微服务集群          │
   │ 9.1     │   │  Cache    │  │ (Consul 服务发现)          │
   │         │   │           │  │ ├─ ai-service    (gRPC)   │
   │         │   │           │  │ ├─ user-service  (gRPC)   │
   │         │   │           │  │ └─ pay-service   (gRPC)   │
   └─────────┘   └───────────┘  └────────────────────────────┘
```

#### 2.1.2 当前数据模型

| 表名 | 实体类 | 所属模块 | 说明 |
|------|--------|----------|------|
| `stories` | `Story` | story | 故事主体，含标题/简介/类型/基调/状态 |
| `outlines` | `Outline` | story | 大纲，JSON 存储章节与场景结构 |
| `character_cards` | `CharacterCard` | story | 角色卡，含简介/详情/关系 |
| `manuscripts` | `Manuscript` | manuscript | 稿件，JSON 存储各场景正文 |
| `materials` | `Material` | material | 素材库，含标题/类型/内容/标签/实体 |
| `material_upload_jobs` | `MaterialUploadJob` | material | 素材上传异步任务 |
| `worlds` | `World` | world | 世界观，JSON 存储模块与进度 |
| `users` | `User` | user | 用户，含积分/角色/远程UID |
| `user_roles` | — (ElementCollection) | user | 用户角色集合表 |
| `prompt_templates` | `PromptTemplatesEntity` | settings | 用户自定义提示词模板 |
| `world_prompt_templates` | `WorldPromptTemplatesEntity` | settings | 世界构建提示词模板 |
| `global_settings` | `GlobalSettings` | settings | 全局系统配置 |

#### 2.1.3 当前局限性

1. **无上下文记忆**：AI 续写时仅依赖手动拼接的 prompt，无法自动检索相关角色/世界/情节信息，长篇写作极易出现前后矛盾。
2. **无风格控制**：所有生成内容使用同一套 prompt 模板，无法区分不同作品的文风或不同角色的语言特征。
3. **无版本管理**：稿件只有最新状态，覆盖即丢失，作者无法回溯或分支探索。
4. **无导出能力**：作品只能在平台内查看，无法导出为标准电子书格式。
5. **单模型绑定**：全局使用同一个 LLM，无法根据任务类型选择最优模型。
6. **无质量反馈**：缺少 AI 审读、连续性检查等写作质量保障机制。

### 2.2 v2 架构目标

```
┌─────────────────────────────────────────────────────────────────────┐
│                          用户浏览器                                  │
│  React 18 + TypeScript + Vite + shadcn/ui + TailwindCSS             │
│  Tiptap Editor + react-resizable-panels                             │
│  + react-diff-viewer (版本对比)                                      │
│  + react-force-graph / D3 (知识图谱可视化)                            │
│  端口: 10010                                                         │
└──────────────────────────────┬──────────────────────────────────────┘
                               │ HTTP / REST
┌──────────────────────────────▼──────────────────────────────────────┐
│                Spring Boot 3.4.2 (Java 17)                          │
│                端口: 10011    路径前缀: /api                          │
│                                                                      │
│  ┌─────────────────────────────────────────────────────────────┐    │
│  │              多模型路由层 (Model Router)                      │    │
│  │  根据任务类型 + 用户偏好 → 选择最优模型 → 统一调用接口         │    │
│  └─────────────────────────────────────────────────────────────┘    │
│                                                                      │
│  ┌─────────────────────────────────────────────────────────────┐    │
│  │              上下文记忆层 (Context Memory)                    │    │
│  │  Lorebook 管理 + KAG 语义检索 + 自动 prompt 注入              │    │
│  └─────────────────────────────────────────────────────────────┘    │
│                                                                      │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐              │
│  │ Story    │ │ Outline  │ │Manuscript│ │ Material │              │
│  └──────────┘ └──────────┘ └──────────┘ └──────────┘              │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐              │
│  │ World    │ │ Version  │ │ Export   │ │ Quality  │              │
│  │          │ │ Control  │ │ Pipeline │ │ (Beta    │              │
│  │          │ │          │ │          │ │  Reader) │              │
│  └──────────┘ └──────────┘ └──────────┘ └──────────┘              │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐                           │
│  │ User /   │ │ Settings │ │ Style    │                           │
│  │ Auth     │ │          │ │ Profile  │                           │
│  └──────────┘ └──────────┘ └──────────┘                           │
│                                                                      │
│  ┌─────────────────────────────────────────────────────────────┐    │
│  │              异步任务层 (Spring @Async + 状态轮询)             │    │
│  └─────────────────────────────────────────────────────────────┘    │
└───────┬──────────┬──────────┬───────────┬───────────────────────────┘
        │          │          │           │
   ┌────▼────┐ ┌───▼───┐ ┌───▼───┐  ┌────▼──────────────────────┐
   │ MySQL   │ │ Neo4j │ │ Redis │  │ AIENIE 微服务集群          │
   │ 9.1     │ │ 5.x   │ │ Cache │  │ (Consul 服务发现)          │
   │         │ │ (KAG) │ │       │  │ ├─ ai-service    (gRPC)   │
   │         │ │       │ │       │  │ ├─ user-service  (gRPC)   │
   │         │ │       │ │       │  │ └─ pay-service   (gRPC)   │
   └─────────┘ └───────┘ └───────┘  └────────────────────────────┘
```

### 2.3 架构对比

| 维度 | v1 | v2 |
|------|-----|-----|
| 上下文管理 | 手动拼接 prompt，无自动检索 | Lorebook + KAG 语义检索，自动注入相关上下文 |
| 知识存储 | 仅 MySQL（JSON 字段） | MySQL + Neo4j 知识图谱 |
| 模型调用 | 单模型（全局配置） | 多模型路由（按任务类型 + 用户偏好） |
| 风格控制 | 无 | 作品级风格画像 + 角色级语言声音 |
| 质量保障 | 无 | AI Beta Reader + 连续性检查 |
| 版本管理 | 无（覆盖写入） | 完整历史 + 分支 + diff 对比 |
| 导出能力 | 无 | EPUB / DOCX / PDF / TXT |
| 异步任务 | 部分（素材上传） | 统一异步框架（@Async + 状态轮询） |
| 缓存策略 | Redis 基础缓存 | Redis 缓存 + Neo4j 查询缓存 |

---

## 3. 技术选型

### 3.1 新增依赖

#### 3.1.1 后端（Maven）

| 依赖 | 版本 | 用途 | 关联模块 |
|------|------|------|----------|
| `spring-boot-starter-data-neo4j` | 随 Spring Boot 3.4.2 | Neo4j 图数据库集成，KAG 知识图谱 | 上下文记忆系统 |
| Neo4j Community Server | 5.x | 图数据库引擎 | 上下文记忆系统 |
| `org.apache.poi:poi-ooxml` | 5.2.x | DOCX 文档生成 | 稿件导出 |
| `com.openhtmltopdf:openhtmltopdf-pdfbox` | 1.0.x | HTML→PDF 渲染 | 稿件导出 |
| `io.documentnode:epub4j-core` | 4.2.x | EPUB 电子书生成 | 稿件导出 |
| `io.github.java-diff-utils:java-diff-utils` | 4.12 | 文本差异计算 | 版本控制 |

#### 3.1.2 前端（npm）

| 依赖 | 用途 | 关联模块 |
|------|------|----------|
| `react-diff-viewer-continued` | 版本差异可视化对比 | 版本控制 |
| `react-force-graph` 或 `d3-force` | 知识图谱交互式可视化 | 上下文记忆系统 |
| `file-saver` | 客户端文件下载 | 稿件导出 |

### 3.2 保留依赖（v1 技术栈不变）

| 层 | 技术 | 版本 |
|----|------|------|
| 后端框架 | Spring Boot | 3.4.2 |
| 语言 | Java | 17 |
| 关系数据库 | MySQL | 9.1 |
| ORM | Spring Data JPA / Hibernate | 随 Spring Boot |
| 缓存 | Spring Data Redis | 随 Spring Boot |
| 安全 | Spring Security + JWT (jjwt 0.11.5) | — |
| API 文档 | springdoc-openapi 2.8.15 | — |
| 微服务通信 | gRPC (grpc-client-spring-boot-starter 3.1.0) | — |
| 服务发现 | Consul | — |
| 前端框架 | React | 18.3 |
| 构建工具 | Vite | 6.3 |
| 类型系统 | TypeScript | 5.5 |
| UI 组件 | shadcn/ui + Radix UI + TailwindCSS | — |
| 富文本编辑器 | Tiptap | 2.4 |
| 数据请求 | TanStack React Query | 5.x |
| 路由 | React Router | 6.x |

### 3.3 异步任务方案

v2 统一采用 **Spring `@Async` + 状态轮询** 模式处理耗时操作：

```
客户端                    后端                           数据库
  │                        │                              │
  │── POST /api/v2/xxx ──▶│                              │
  │                        │── 创建任务记录 ──────────────▶│
  │◀── 202 {taskId} ──────│                              │
  │                        │── @Async 执行任务 ──────────▶│
  │                        │                              │
  │── GET /api/v2/tasks/{taskId} ──▶│                    │
  │◀── {status: "running", progress: 40%} ──│            │
  │                        │                              │
  │── GET /api/v2/tasks/{taskId} ──▶│                    │
  │◀── {status: "done", result: {...}} ─────│            │
```

适用场景：
- KAG 知识图谱构建 / 增量更新
- AI Beta Reader 全文审读
- 批量导出（长篇 EPUB/PDF）
- 多模型并行生成 + 结果合并

> 暂不引入消息队列（如 RabbitMQ），保持架构简洁。若未来并发量显著增长，可在此层替换为消息队列而不影响上层接口。

---

## 4. 模块全景

### 4.1 模块总览

| 模块 | 优先级 | 设计文档 | 简述 |
|------|--------|----------|------|
| 上下文记忆系统 | **P0** | `01-上下文记忆系统.md` | Lorebook 条目管理 + KAG 知识图谱 + 语义检索 + 自动 prompt 注入。v2 最核心能力。 |
| 风格画像与角色声音 | **P1** | `02-风格画像与角色声音.md` | 作品级文风分析与画像、角色级语言特征提取、生成时风格约束注入。 |
| AI Beta Reader 与连续性检查 | **P1** | `03-AI-Beta-Reader与连续性检查.md` | AI 模拟读者审读全文，输出结构/节奏/角色/逻辑反馈；自动连续性校验。 |
| 版本控制系统 | **P2** | `04-版本控制系统.md` | 稿件/大纲的完整版本历史、分支管理、diff 对比、版本回滚。 |
| 稿件导出系统 | **P2** | `05-稿件导出系统.md` | 支持 EPUB / DOCX / PDF / TXT 四种格式导出，含封面、目录、样式。 |
| 多模型协作 | **P3** | `06-多模型协作.md` | 多 LLM 注册与路由、按任务类型推荐模型、用户可覆盖、并行生成与择优。 |
| 工作台与体验优化 | **P4** | `07-工作台与体验优化.md` | 工作台 UI 重构、知识图谱可视化面板、写作统计仪表盘、快捷键体系。 |

### 4.2 模块依赖关系

```
P0  上下文记忆系统 ◄──────────────────────────────────────────┐
        │                                                      │
        ▼                                                      │
P1  风格画像与角色声音 ──▶ AI Beta Reader 与连续性检查          │
                                │                              │
                                ▼                              │
P2  版本控制系统          稿件导出系统                          │
        │                    │                                 │
        ▼                    ▼                                 │
P3  多模型协作 ─────────────────────────────────────────────────┘
        │                    (多模型为所有 AI 调用提供路由能力)
        ▼
P4  工作台与体验优化
```

说明：
- P0 上下文记忆系统是所有 AI 生成质量提升的基础，必须最先完成。
- P1 风格画像依赖上下文记忆提供的角色/世界信息；Beta Reader 依赖风格画像作为评判标准。
- P2 版本控制与导出相对独立，可并行开发。
- P3 多模型协作是横切关注点，完成后可回溯增强 P0-P2 的模型选择能力。
- P4 工作台优化在所有功能模块稳定后进行。

---

## 5. 数据架构演进

### 5.1 关系型数据库（MySQL）

#### 5.1.1 现有表（保留，部分扩展）

| 表名 | v2 变更 |
|------|---------|
| `stories` | 新增 `style_profile_id` 外键 |
| `outlines` | 无变更 |
| `character_cards` | 新增 `voice_profile` (TEXT) 字段 → 见 `02-风格画像与角色声音.md` § 3.2 |
| `manuscripts` | 无变更（版本控制通过独立表实现） |
| `materials` | 新增 `graph_synced` (BOOLEAN) 标记是否已同步到 Neo4j |
| `worlds` | 新增 `graph_synced` (BOOLEAN) |
| `users` | 无变更 |
| `user_roles` | 无变更 |
| `prompt_templates` | 无变更 |
| `world_prompt_templates` | 无变更 |
| `global_settings` | 新增多模型相关配置字段 |

#### 5.1.2 新增表

**上下文记忆模块** → 见 `01-上下文记忆系统.md` § 4

| 表名 | 说明 |
|------|------|
| `lorebook_entries` | Lorebook 条目：关键词触发 + 内容片段 + 优先级 + 作用域 |
| `lorebook_entry_triggers` | 条目触发关键词（一对多） |
| `graph_sync_tasks` | KAG 图谱同步任务状态追踪 |

**风格画像模块** → 见 `02-风格画像与角色声音.md` § 4

| 表名 | 说明 |
|------|------|
| `style_profiles` | 作品风格画像：叙事视角、句式偏好、词汇倾向、节奏特征等 |
| `character_voices` | 角色语言声音：口头禅、语气词、句式模式、禁用词等 |

**AI Beta Reader 模块** → 见 `03-AI-Beta-Reader与连续性检查.md` § 4

| 表名 | 说明 |
|------|------|
| `review_sessions` | 审读会话：关联稿件、审读范围、状态 |
| `review_findings` | 审读发现：类型（结构/节奏/角色/逻辑）、严重度、位置、建议 |
| `continuity_checks` | 连续性检查记录：检查类型、冲突描述、关联实体 |

**版本控制模块** → 见 `04-版本控制系统.md` § 4

| 表名 | 说明 |
|------|------|
| `version_snapshots` | 版本快照：关联实体（稿件/大纲）、快照内容、父版本、分支名 |
| `version_branches` | 分支定义：分支名、基准版本、HEAD 版本 |
| `version_tags` | 版本标签：用户自定义里程碑标记 |

**稿件导出模块** → 见 `05-稿件导出系统.md` § 4

| 表名 | 说明 |
|------|------|
| `export_tasks` | 导出任务：格式、状态、文件路径、错误信息 |
| `export_templates` | 导出模板：格式对应的样式/封面/版式配置 |

**多模型协作模块** → 见 `06-多模型协作.md` § 4

| 表名 | 说明 |
|------|------|
| `model_registry` | 模型注册表：名称、提供商、端点、能力标签、费用系数 |
| `model_routing_rules` | 路由规则：任务类型 → 推荐模型 + 回退模型 |
| `model_usage_logs` | 模型调用日志：模型、任务类型、token 用量、延迟、用户评分 |

**异步任务通用表**

| 表名 | 说明 |
|------|------|
| `async_tasks` | 统一异步任务表：类型、状态、进度百分比、结果/错误、创建/完成时间 |

### 5.2 图数据库（Neo4j）

KAG（Knowledge Augmented Generation）知识图谱用于存储作品中的实体及其关系，支持语义检索。

→ 见 `01-上下文记忆系统.md` § 5

#### 5.2.1 节点类型

| 节点标签 | 属性 | 来源 |
|----------|------|------|
| `:Character` | `name`, `storyId`, `synopsis`, `role`(主角/配角/龙套) | `character_cards` 表 |
| `:Location` | `name`, `storyId`, `description`, `region` | 世界观模块 / Lorebook |
| `:Event` | `name`, `storyId`, `chapterIndex`, `description`, `timestamp` | 大纲 / 稿件解析 |
| `:Item` | `name`, `storyId`, `description`, `significance` | Lorebook / 素材 |
| `:Concept` | `name`, `storyId`, `description`, `category` | 世界观模块（魔法体系/科技/社会制度等） |
| `:Faction` | `name`, `storyId`, `description`, `alignment` | 世界观模块 / Lorebook |
| `:Chapter` | `index`, `title`, `storyId`, `summary` | 大纲 |
| `:Scene` | `index`, `chapterIndex`, `storyId`, `summary` | 大纲 |

#### 5.2.2 关系类型

| 关系 | 起点 → 终点 | 属性 | 说明 |
|------|-------------|------|------|
| `KNOWS` | Character → Character | `since`, `attitude` | 角色认识关系 |
| `ALLY_OF` | Character → Character | `strength` | 盟友 |
| `ENEMY_OF` | Character → Character | `reason` | 敌对 |
| `FAMILY_OF` | Character → Character | `relation`(父/母/兄/妹...) | 亲属 |
| `LOCATED_IN` | Character → Location | `since`, `current` | 角色所在地 |
| `PARTICIPATES_IN` | Character → Event | `role` | 角色参与事件 |
| `OCCURS_AT` | Event → Location | — | 事件发生地 |
| `CAUSES` | Event → Event | — | 事件因果链 |
| `FOLLOWS` | Event → Event | — | 事件时序 |
| `BELONGS_TO` | Character → Faction | `rank` | 角色所属阵营 |
| `POSSESSES` | Character → Item | `since` | 角色持有物品 |
| `CONTAINS` | Chapter → Scene | `order` | 章节包含场景 |

### 5.3 数据流向

```
                    ┌──────────────────────────────────┐
                    │           用户操作                 │
                    │  (创建角色/编辑大纲/写正文/...)     │
                    └──────────────┬───────────────────┘
                                   │
                    ┌──────────────▼───────────────────┐
                    │         MySQL (主存储)             │
                    │  写入实体数据 (JPA)                 │
                    └──────┬───────────────┬───────────┘
                           │               │
              ┌────────────▼──┐    ┌───────▼──────────┐
              │  Redis Cache  │    │  Neo4j (KAG)     │
              │               │    │                   │
              │ • 热点查询缓存 │    │ • 实体抽取后写入  │
              │ • 会话状态     │    │   节点与关系      │
              │ • 任务进度     │    │ • 增量同步        │
              │               │    │   (graph_synced)  │
              └───────┬───────┘    └───────┬──────────┘
                      │                    │
                      └────────┬───────────┘
                               │
                    ┌──────────▼───────────────────────┐
                    │       AI 生成请求                  │
                    │                                    │
                    │  1. 从 MySQL 读取当前稿件上下文     │
                    │  2. 从 Neo4j 语义检索相关实体       │
                    │  3. 从 Redis 读取缓存的风格画像     │
                    │  4. 从 Lorebook 匹配触发条目        │
                    │  5. 组装 prompt → 调用 LLM          │
                    │  6. 结果写回 MySQL                  │
                    │  7. 异步更新 Neo4j 图谱             │
                    └──────────────────────────────────┘
```

关键设计原则：
- **MySQL 是唯一事实源（Source of Truth）**：所有业务数据以 MySQL 为准。
- **Neo4j 是派生索引**：图数据从 MySQL 数据异步同步而来，允许重建。`graph_synced` 标记确保一致性。
- **Redis 是加速层**：缓存热点数据（风格画像、Lorebook 条目、图谱查询结果），设置合理 TTL。

---

## 6. 路线图

### 6.1 Phase 1（P0）：上下文记忆系统

→ 见 `01-上下文记忆系统.md`

**目标**：让 AI 在续写时自动获取完整、相关的上下文信息，从根本上解决长篇写作中的前后矛盾问题。

| 里程碑 | 内容 | 预估工期 |
|--------|------|----------|
| M1.1 Lorebook 基础 | Lorebook 条目 CRUD、关键词触发匹配、手动管理界面 | 2 周 |
| M1.2 Neo4j 集成 | Neo4j 环境搭建、Spring Data Neo4j 集成、基础节点/关系模型 | 1 周 |
| M1.3 实体抽取 | 从角色卡/世界观/大纲/稿件中自动抽取实体，写入 Neo4j | 2 周 |
| M1.4 语义检索 | 基于当前写作上下文，从 KAG 图谱检索相关实体与关系 | 2 周 |
| M1.5 Prompt 注入 | 将检索结果 + Lorebook 匹配结果自动注入 AI prompt | 1 周 |
| M1.6 增量同步 | 稿件编辑后增量更新图谱，graph_synced 状态管理 | 1 周 |

**Phase 1 总工期**：约 9 周

### 6.2 Phase 2（P1）：写作质量体系

→ 见 `02-风格画像与角色声音.md` 和 `03-AI-Beta-Reader与连续性检查.md`

**目标**：建立从"风格定义"到"质量检测"的完整写作质量闭环。

| 里程碑 | 内容 | 预估工期 |
|--------|------|----------|
| M2.1 风格画像 | 作品风格分析、画像生成与存储、画像编辑界面 | 2 周 |
| M2.2 角色声音 | 角色语言特征提取、声音画像管理、生成时声音约束注入 | 2 周 |
| M2.3 Beta Reader 基础 | 审读会话管理、全文/章节审读、结构化反馈输出 | 3 周 |
| M2.4 连续性检查 | 基于 KAG 图谱的自动连续性校验（时间线/角色状态/物品追踪） | 2 周 |
| M2.5 反馈集成 | 审读结果在编辑器中内联展示、一键采纳建议 | 1 周 |

**Phase 2 总工期**：约 10 周

### 6.3 Phase 3（P2）：版本控制 + 导出

→ 见 `04-版本控制系统.md` 和 `05-稿件导出系统.md`

**目标**：为创作过程提供安全网（版本控制），为创作成果提供出口（格式导出）。

| 里程碑 | 内容 | 预估工期 |
|--------|------|----------|
| M3.1 版本快照 | 稿件/大纲保存时自动创建快照、版本历史列表 | 2 周 |
| M3.2 Diff 对比 | 任意两个版本的文本差异对比（后端 java-diff-utils + 前端 react-diff-viewer） | 1 周 |
| M3.3 分支管理 | 从任意版本创建分支、分支切换、分支合并 | 2 周 |
| M3.4 版本回滚 | 回滚到指定版本、标签管理 | 1 周 |
| M3.5 TXT/DOCX 导出 | 纯文本与 Word 文档导出（Apache POI） | 1.5 周 |
| M3.6 EPUB 导出 | 电子书导出，含封面/目录/章节结构（epub4j） | 2 周 |
| M3.7 PDF 导出 | PDF 导出，含排版样式（OpenHTMLtoPDF） | 1.5 周 |

**Phase 3 总工期**：约 11 周（版本控制与导出可并行，实际约 7 周）

### 6.4 Phase 4（P3-P4）：多模型 + 工作台

→ 见 `06-多模型协作.md` 和 `07-工作台与体验优化.md`

**目标**：释放多模型协作的潜力，打磨整体用户体验。

| 里程碑 | 内容 | 预估工期 |
|--------|------|----------|
| M4.1 模型注册 | 模型注册表管理、能力标签、费用配置 | 1 周 |
| M4.2 路由引擎 | 任务类型→模型映射规则、默认推荐 + 用户覆盖 | 2 周 |
| M4.3 并行生成 | 同一任务多模型并行生成、结果对比、用户择优 | 2 周 |
| M4.4 知识图谱面板 | 工作台内嵌知识图谱可视化（react-force-graph），支持交互探索 | 2 周 |
| M4.5 写作统计 | 字数趋势、写作习惯分析、目标追踪仪表盘 | 1 周 |
| M4.6 快捷键与 UX | 全局快捷键体系、工作台布局优化、响应式适配 | 1 周 |

**Phase 4 总工期**：约 9 周

### 6.5 总时间线概览

```
2026-Q1          2026-Q2          2026-Q3          2026-Q4
  │                │                │                │
  ├─ Phase 1 ─────┤                │                │
  │  上下文记忆     │                │                │
  │  (9 周)        │                │                │
  │                ├─ Phase 2 ─────┤                │
  │                │  写作质量体系   │                │
  │                │  (10 周)       │                │
  │                │                ├─ Phase 3 ─────┤
  │                │                │  版本控制+导出  │
  │                │                │  (7 周并行)    │
  │                │                │                ├─ Phase 4 ──
  │                │                │                │  多模型+工作台
  │                │                │                │  (9 周)
```

---

## 7. 非功能性需求

### 7.1 性能目标

| 指标 | 目标值 | 说明 |
|------|--------|------|
| KAG 语义检索延迟 | < 500ms (P95) | 单次检索返回 Top-K 相关实体 |
| Lorebook 关键词匹配 | < 50ms | 内存缓存 + 前缀树匹配 |
| 版本快照创建 | < 200ms | 异步写入，不阻塞编辑保存 |
| EPUB 导出（10万字） | < 30s | 异步任务，前端轮询进度 |
| PDF 导出（10万字） | < 60s | HTML→PDF 渲染较慢，异步处理 |
| 知识图谱可视化渲染 | < 2s（500 节点以内） | 前端 WebGL 渲染，超过阈值分页加载 |
| API 响应时间（非 AI 调用） | < 200ms (P95) | 与 v1 保持一致 |

### 7.2 安全考量

| 领域 | 措施 |
|------|------|
| Neo4j 访问控制 | 仅后端服务可访问 Neo4j，不暴露 Bolt 端口到公网；使用独立数据库用户 |
| 导出文件安全 | 导出文件存储在临时目录，设置过期自动清理（24h）；下载链接包含一次性 token |
| 版本数据隔离 | 版本快照严格按 `user_id` 隔离，API 层强制校验所有权 |
| 模型 API Key | 多模型注册时 API Key 加密存储（AES-256），运行时解密，日志中脱敏 |
| 图谱数据隔离 | Neo4j 中所有节点携带 `storyId`，查询时强制过滤，防止跨故事数据泄露 |

### 7.3 向后兼容性

| 维度 | 策略 |
|------|------|
| 数据库迁移 | 所有新表通过 JPA `ddl-auto: update` 自动创建；现有表仅新增字段（nullable），不修改/删除现有字段 |
| API 版本 | 新功能使用 `/api/v2/` 前缀；v1 API 保持不变，标记为 deprecated 但不删除 |
| 前端路由 | 新页面使用新路由；现有页面路由不变，渐进增强 |
| Neo4j 可选 | Neo4j 连接失败时降级为纯 Lorebook 关键词匹配模式，不影响基础写作功能 |
| 配置兼容 | 所有新配置项提供合理默认值，v1 的 `application.yml` 无需修改即可启动 v2 |

---

## 8. 风险与缓解

| 风险 | 影响 | 概率 | 缓解措施 |
|------|------|------|----------|
| Neo4j 引入增加运维复杂度 | 中 | 高 | 使用 Neo4j Community（免费）；提供 Docker Compose 一键部署；设计降级方案（无 Neo4j 时退化为关键词匹配） |
| KAG 实体抽取准确率不足 | 高 | 中 | 采用 LLM 辅助抽取 + 人工校正的混合模式；提供图谱编辑界面让用户修正错误实体 |
| 多模型路由增加调用成本 | 中 | 中 | 默认推荐性价比最优模型；并行生成为可选高级功能；提供费用预估与预算上限设置 |
| 版本快照存储空间膨胀 | 中 | 中 | 采用增量存储（仅存 diff）而非全量快照；设置自动清理策略（保留最近 N 个版本 + 所有标签版本） |
| 长篇导出内存溢出 | 中 | 低 | 流式处理（分章节生成）；设置单次导出字数上限（100万字）；异步任务隔离 |
| AI Beta Reader 审读耗时过长 | 低 | 中 | 支持章节级审读（非必须全文）；审读结果缓存；后台异步执行不阻塞写作 |
| 前端知识图谱渲染性能 | 低 | 中 | 节点数超过阈值时自动聚合/分页；使用 WebGL 渲染（react-force-graph 3D）；提供列表视图作为备选 |
| Spring @Async 线程池耗尽 | 高 | 低 | 配置独立线程池（核心 4，最大 16）；任务排队机制；超时自动取消；监控告警 |

---

## 附录 A：目录结构参考

```
backend/src/main/java/com/ainovel/app/
├── ai/                          # AI 调用（v1 保留）
├── admin/                       # 管理后台（v1 保留）
├── common/                      # 公共组件（v1 保留）
├── economy/                     # 积分经济（v1 保留）
├── integration/                 # 外部服务集成（v1 保留）
├── manuscript/                  # 稿件模块（v1 保留）
├── material/                    # 素材模块（v1 保留，扩展 graph_synced）
├── security/                    # 安全模块（v1 保留）
├── settings/                    # 设置模块（v1 保留）
├── story/                       # 故事模块（v1 保留）
├── user/                        # 用户模块（v1 保留）
├── world/                       # 世界观模块（v1 保留，扩展 graph_synced）
│
│   ── v2 新增 ──
├── context/                     # [P0] 上下文记忆系统
│   ├── lorebook/                #   Lorebook 条目管理
│   ├── kag/                     #   KAG 知识图谱（Neo4j 交互）
│   └── retrieval/               #   语义检索 + prompt 注入
├── style/                       # [P1] 风格画像与角色声音
├── review/                      # [P1] AI Beta Reader + 连续性检查
├── version/                     # [P2] 版本控制系统
├── export/                      # [P2] 稿件导出系统
├── model/                       # [P3] 多模型协作（路由 + 注册）
└── async/                       # 统一异步任务框架
```

## 附录 B：配置扩展参考

v2 在 `application.yml` 中新增的配置项（均提供默认值，向后兼容）：

```yaml
# v2 新增配置
app:
  neo4j:
    enabled: ${NEO4J_ENABLED:false}          # 默认关闭，显式启用
    uri: ${NEO4J_URI:bolt://localhost:7687}
    username: ${NEO4J_USERNAME:neo4j}
    password: ${NEO4J_PASSWORD:}
    database: ${NEO4J_DATABASE:ainovel}

  context:
    lorebook:
      max-entries-per-story: 500
      max-content-length: 2000               # 单条目最大字符数
    kag:
      auto-sync: true                        # 编辑后自动同步图谱
      sync-delay-seconds: 30                 # 防抖延迟
      max-retrieval-results: 20              # 单次检索最大返回数

  export:
    temp-dir: ${EXPORT_TEMP_DIR:${java.io.tmpdir}/ainovel-export}
    cleanup-hours: 24                        # 临时文件清理周期
    max-word-count: 1000000                  # 单次导出字数上限

  version:
    auto-snapshot: true                      # 保存时自动创建快照
    max-snapshots-per-entity: 200            # 超出后自动清理旧版本
    diff-context-lines: 3                    # diff 上下文行数

  async:
    core-pool-size: 4
    max-pool-size: 16
    queue-capacity: 100
    task-timeout-minutes: 30
```

## 附录 C：关联文档索引

| 编号 | 文档名 | 核心内容 |
|------|--------|----------|
| 01 | `01-上下文记忆系统.md` | Lorebook 数据模型、KAG 图谱设计、语义检索算法、prompt 注入策略 |
| 02 | `02-风格画像与角色声音.md` | 风格分析流程、画像数据结构、角色声音提取、生成约束注入 |
| 03 | `03-AI-Beta-Reader与连续性检查.md` | 审读流程、反馈分类体系、连续性检查规则、编辑器集成方案 |
| 04 | `04-版本控制系统.md` | 快照存储策略、分支模型、diff 算法、合并冲突处理 |
| 05 | `05-稿件导出系统.md` | 四种格式的生成流水线、模板系统、样式配置、异步导出流程 |
| 06 | `06-多模型协作.md` | 模型注册表、路由引擎、并行生成、结果评估与择优 |
| 07 | `07-工作台与体验优化.md` | 知识图谱面板、写作统计、快捷键体系、布局重构方案 |
