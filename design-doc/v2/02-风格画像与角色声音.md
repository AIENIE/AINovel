# 风格画像与角色声音

## 文档信息

| 字段 | 值 |
|------|-----|
| 版本 | v2.0 |
| 日期 | 2026-02-17 |
| 优先级 | P1 |
| 关联模块 | 01-上下文记忆, 03-Beta-Reader, 06-多模型协作 |

---

## 1. 背景与动机

### 1.1 问题陈述

v1 版本的 AI 生成存在以下核心痛点：

1. **风格不一致**：不同章节的叙事风格差异明显，读起来像多人合写。第一章可能是冷硬派叙事，第三章突然变成华丽辞藻堆砌，用户需要大量手动润色才能统一全书风格。
2. **角色对话同质化**：所有角色的对话语气趋同——一个粗犷的战士和一个儒雅的书生说出的话几乎没有区别。当前 `CharacterCard` 实体仅存储 `name`/`synopsis`/`details`/`relationships`，缺乏对角色语言特征的结构化描述。
3. **无风格定义机制**：当前 `PromptTemplatesEntity` 提供了 `storyCreation`/`outlineChapter`/`manuscriptSection`/`refine` 四类模板，但没有独立的风格维度控制。用户只能在提示词中手写风格要求，无法量化、复用或跨故事迁移。
4. **场景模式缺失**：动作戏、对话戏、内心独白、环境描写等不同叙事模式需要不同的节奏和笔触，但当前系统一视同仁。

### 1.2 业界参考

| 产品/方案 | 做法 | 可借鉴点 |
|-----------|------|----------|
| **Sudowrite** | 提供 Style Dials（正式度、描写密度等滑块），用户可微调 AI 输出风格 | 可视化风格维度滑块 |
| **ProWritingAid** | 对已有文本进行风格分析，输出可读性评分、句长分布、词汇丰富度等指标 | 风格指纹提取与量化分析 |
| **GPT Custom Instructions** | 允许用户设定全局语气、角色扮演指令，在所有对话中生效 | 全局风格锁定 + 按需覆盖 |
| **NovelAI** | 为角色提供独立的 lorebook 条目，包含语言习惯、口头禅等 | 角色声音独立建模 |
| **Character.AI** | 每个角色有独立的 persona 定义，包含说话方式、性格特征 | 角色语言特征结构化 |

---

## 2. 设计目标

| 编号 | 目标 | 说明 |
|------|------|------|
| G1 | 风格锁定 | 定义并强制执行全书一致的写作风格，跨章节保持叙事统一性 |
| G2 | 角色声音 | 每个角色拥有独立的语言特征——说话方式、词汇水平、口头禅、方言 |
| G3 | 风格分析 | AI 可分析已有文本，提取风格指纹（维度评分 + 文字说明） |
| G4 | 风格迁移 | 支持参考某位作者或某部作品的风格，应用到新内容生成中 |
| G5 | 场景模式覆盖 | 允许不同叙事模式（动作、对话、内省、描写）使用不同风格参数 |
| G6 | 与现有流程无缝集成 | 风格/声音指令自动注入现有的 `manuscriptSection`/`refine` 等生成流程，无需用户手动拼接 |

---

## 3. 详细设计

### 3.1 数据模型

#### 3.1.1 ER 关系概览

```
users 1──N style_profiles
stories 1──N style_profiles
stories 1──N character_voices
character_cards 1──1 character_voices
users 1──N style_analysis_jobs
style_profiles 1──N style_profile_scene_overrides
```

#### 3.1.2 表：`style_profiles`（风格画像）

```sql
CREATE TABLE style_profiles (
    id              CHAR(36)        NOT NULL COMMENT '主键 UUID',
    user_id         CHAR(36)        NOT NULL COMMENT '所属用户',
    story_id        CHAR(36)        NULL     COMMENT '所属故事；NULL 表示全局画像',
    name            VARCHAR(100)    NOT NULL COMMENT '画像名称，如"冷硬派叙事"',
    profile_type    ENUM('narrative','dialogue','global')
                                    NOT NULL DEFAULT 'global'
                                    COMMENT '画像类型：叙事/对话/全局',
    dimensions_json TEXT            NULL     COMMENT '风格维度 JSON，见下方结构',
    sample_text     TEXT            NULL     COMMENT '参考风格样本文本',
    ai_analysis_json TEXT           NULL     COMMENT 'AI 生成的风格分析结果 JSON',
    is_active       TINYINT(1)      NOT NULL DEFAULT 0 COMMENT '是否为当前激活画像',
    created_at      TIMESTAMP       NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at      TIMESTAMP       NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    PRIMARY KEY (id),
    INDEX idx_sp_user    (user_id),
    INDEX idx_sp_story   (story_id),
    INDEX idx_sp_active  (story_id, is_active),
    CONSTRAINT fk_sp_user  FOREIGN KEY (user_id)  REFERENCES users(id)   ON DELETE CASCADE,
    CONSTRAINT fk_sp_story FOREIGN KEY (story_id)  REFERENCES stories(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci
  COMMENT='风格画像';
```

`dimensions_json` 结构示例：

```json
{
  "formality": { "score": 7, "description": "偏正式，避免口语化表达" },
  "sentence_length": { "score": 6, "description": "中等偏长，允许复合句" },
  "vocabulary_richness": { "score": 8, "description": "词汇丰富，使用文学性词汇" },
  "pacing": { "score": 5, "description": "中等节奏，张弛有度" },
  "descriptiveness": { "score": 7, "description": "较高描写密度，注重环境与感官" },
  "dialogue_ratio": { "score": 4, "description": "对话占比偏低，以叙述为主" },
  "emotional_intensity": { "score": 6, "description": "情感克制但有张力" },
  "rhetoric_frequency": { "score": 5, "description": "适度使用比喻、拟人等修辞" }
}
```

#### 3.1.3 表：`style_profile_scene_overrides`（场景模式覆盖）

```sql
CREATE TABLE style_profile_scene_overrides (
    id              CHAR(36)        NOT NULL COMMENT '主键 UUID',
    style_profile_id CHAR(36)       NOT NULL COMMENT '所属风格画像',
    scene_type      ENUM('action','dialogue','introspection','description','flashback')
                                    NOT NULL COMMENT '场景类型',
    override_json   TEXT            NOT NULL COMMENT '覆盖的维度 JSON（仅包含需要覆盖的字段）',
    created_at      TIMESTAMP       NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at      TIMESTAMP       NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    PRIMARY KEY (id),
    UNIQUE KEY uk_profile_scene (style_profile_id, scene_type),
    CONSTRAINT fk_spso_profile FOREIGN KEY (style_profile_id) REFERENCES style_profiles(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci
  COMMENT='风格画像场景模式覆盖';
```

#### 3.1.4 表：`character_voices`（角色声音）

```sql
CREATE TABLE character_voices (
    id                  CHAR(36)        NOT NULL COMMENT '主键 UUID',
    character_card_id   CHAR(36)        NOT NULL COMMENT '关联角色卡',
    story_id            CHAR(36)        NOT NULL COMMENT '所属故事',
    speech_pattern      TEXT            NULL     COMMENT '说话方式描述',
    vocabulary_level    VARCHAR(50)     NULL     COMMENT '词汇水平：colloquial/formal/archaic/mixed',
    catchphrases_json   TEXT            NULL     COMMENT '口头禅 JSON 数组',
    emotional_range_json TEXT           NULL     COMMENT '情感表达方式 JSON',
    dialect             VARCHAR(100)    NULL     COMMENT '方言/社会语域',
    sample_dialogues_json TEXT          NULL     COMMENT '示例对话 JSON 数组',
    ai_analysis_json    TEXT            NULL     COMMENT 'AI 生成的声音分析 JSON',
    created_at          TIMESTAMP       NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at          TIMESTAMP       NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    PRIMARY KEY (id),
    UNIQUE KEY uk_cv_character (character_card_id),
    INDEX idx_cv_story (story_id),
    CONSTRAINT fk_cv_character FOREIGN KEY (character_card_id) REFERENCES character_cards(id) ON DELETE CASCADE,
    CONSTRAINT fk_cv_story     FOREIGN KEY (story_id)          REFERENCES stories(id)         ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci
  COMMENT='角色声音';
```

`catchphrases_json` 示例：

```json
["老子说了算", "哼，不过如此", "你这是在找死"]
```

`emotional_range_json` 示例：

```json
{
  "anger": "语速加快，用词粗鲁，喜欢反问",
  "sadness": "沉默寡言，偶尔冒出短句",
  "joy": "大笑，拍人肩膀，语气夸张",
  "fear": "结巴，声音发颤，不断重复"
}
```

`sample_dialogues_json` 示例：

```json
[
  { "context": "战斗前", "line": "都给老子让开，这仗我一个人打！" },
  { "context": "安慰同伴", "line": "……别哭了。哭有什么用，不如磨刀。" },
  { "context": "面对敌人", "line": "你最好祈祷你的剑比你的嘴快。" }
]
```

#### 3.1.5 表：`style_analysis_jobs`（风格分析任务）

```sql
CREATE TABLE style_analysis_jobs (
    id               CHAR(36)        NOT NULL COMMENT '主键 UUID',
    user_id          CHAR(36)        NOT NULL COMMENT '发起用户',
    source_type      ENUM('manuscript','uploaded_text','url')
                                     NOT NULL COMMENT '分析来源类型',
    source_reference TEXT            NOT NULL COMMENT '来源引用：稿件ID / 粘贴文本 / URL',
    status           ENUM('pending','processing','completed','failed')
                                     NOT NULL DEFAULT 'pending',
    result_json      TEXT            NULL     COMMENT '分析结果 JSON',
    error_message    VARCHAR(500)    NULL     COMMENT '失败原因',
    created_at       TIMESTAMP       NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at       TIMESTAMP       NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    PRIMARY KEY (id),
    INDEX idx_saj_user   (user_id),
    INDEX idx_saj_status (status),
    CONSTRAINT fk_saj_user FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci
  COMMENT='风格分析任务';
```

#### 3.1.6 JPA 实体与现有模型的关系

```
CharacterCard (现有)
  └── @OneToOne → CharacterVoice (新增)

Story (现有)
  ├── @OneToMany → StyleProfile (新增)
  └── @OneToMany → CharacterVoice (新增，通过 story_id)

User (现有)
  ├── @OneToMany → StyleProfile (新增)
  └── @OneToMany → StyleAnalysisJob (新增)
```

### 3.2 后端设计

#### 3.2.1 包结构

```
backend/src/main/java/com/ainovel/app/style/
├── model/
│   ├── StyleProfile.java
│   ├── StyleProfileSceneOverride.java
│   ├── CharacterVoice.java
│   ├── StyleAnalysisJob.java
│   └── enums/
│       ├── ProfileType.java          // NARRATIVE, DIALOGUE, GLOBAL
│       ├── SceneType.java            // ACTION, DIALOGUE, INTROSPECTION, DESCRIPTION, FLASHBACK
│       ├── SourceType.java           // MANUSCRIPT, UPLOADED_TEXT, URL
│       └── JobStatus.java            // PENDING, PROCESSING, COMPLETED, FAILED
├── dto/
│   ├── StyleProfileDto.java
│   ├── StyleProfileCreateRequest.java
│   ├── StyleProfileUpdateRequest.java
│   ├── StyleDimensionsDto.java
│   ├── CharacterVoiceDto.java
│   ├── CharacterVoiceCreateRequest.java
│   ├── CharacterVoiceUpdateRequest.java
│   ├── StyleAnalysisRequest.java
│   ├── StyleAnalysisResultDto.java
│   └── SceneOverrideDto.java
├── repo/
│   ├── StyleProfileRepository.java
│   ├── StyleProfileSceneOverrideRepository.java
│   ├── CharacterVoiceRepository.java
│   └── StyleAnalysisJobRepository.java
├── service/
│   ├── StyleProfileService.java
│   ├── CharacterVoiceService.java
│   ├── StyleAnalysisService.java
│   └── StyleInjectionService.java
├── StyleProfileController.java
└── CharacterVoiceController.java
```

#### 3.2.2 核心实体示例

```java
// StyleProfile.java
package com.ainovel.app.style.model;

import com.ainovel.app.story.model.Story;
import com.ainovel.app.user.User;
import com.ainovel.app.style.model.enums.ProfileType;
import jakarta.persistence.*;
import org.hibernate.annotations.CreationTimestamp;
import org.hibernate.annotations.UpdateTimestamp;
import java.time.Instant;
import java.util.UUID;

@Entity
@Table(name = "style_profiles")
public class StyleProfile {
    @Id
    @GeneratedValue(strategy = GenerationType.UUID)
    private UUID id;

    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "user_id", nullable = false)
    private User user;

    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "story_id")
    private Story story; // nullable → 全局画像

    @Column(length = 100, nullable = false)
    private String name;

    @Enumerated(EnumType.STRING)
    @Column(name = "profile_type", nullable = false)
    private ProfileType profileType = ProfileType.GLOBAL;

    @Lob
    @Column(name = "dimensions_json")
    private String dimensionsJson;

    @Lob
    @Column(name = "sample_text")
    private String sampleText;

    @Lob
    @Column(name = "ai_analysis_json")
    private String aiAnalysisJson;

    @Column(name = "is_active", nullable = false)
    private boolean active = false;

    @CreationTimestamp
    private Instant createdAt;

    @UpdateTimestamp
    private Instant updatedAt;

    // getters/setters 省略
}
```

```java
// CharacterVoice.java
package com.ainovel.app.style.model;

import com.ainovel.app.story.model.CharacterCard;
import com.ainovel.app.story.model.Story;
import jakarta.persistence.*;
import org.hibernate.annotations.CreationTimestamp;
import org.hibernate.annotations.UpdateTimestamp;
import java.time.Instant;
import java.util.UUID;

@Entity
@Table(name = "character_voices")
public class CharacterVoice {
    @Id
    @GeneratedValue(strategy = GenerationType.UUID)
    private UUID id;

    @OneToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "character_card_id", nullable = false, unique = true)
    private CharacterCard characterCard;

    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "story_id", nullable = false)
    private Story story;

    @Lob private String speechPattern;

    @Column(name = "vocabulary_level", length = 50)
    private String vocabularyLevel;

    @Lob @Column(name = "catchphrases_json")
    private String catchphrasesJson;

    @Lob @Column(name = "emotional_range_json")
    private String emotionalRangeJson;

    @Column(length = 100)
    private String dialect;

    @Lob @Column(name = "sample_dialogues_json")
    private String sampleDialoguesJson;

    @Lob @Column(name = "ai_analysis_json")
    private String aiAnalysisJson;

    @CreationTimestamp private Instant createdAt;
    @UpdateTimestamp  private Instant updatedAt;

    // getters/setters 省略
}
```

#### 3.2.3 核心服务方法

```java
// StyleAnalysisService.java — 核心方法签名
@Service
public class StyleAnalysisService {

    private final AiService aiService;
    private final StyleAnalysisJobRepository jobRepository;

    /**
     * 分析文本风格，返回维度评分。
     * 内部调用 AiGatewayGrpcClient.chatCompletions，
     * 使用风格分析专用 prompt（见 §3.5）。
     */
    public StyleAnalysisResultDto analyzeStyle(User user, String text) { ... }

    /**
     * 异步分析：创建 job → 状态 pending → 后台线程执行 → completed/failed。
     * 用于大文本或 URL 来源。
     */
    public UUID submitAnalysisJob(User user, StyleAnalysisRequest request) { ... }

    /** 查询分析任务状态 */
    public StyleAnalysisJob getJob(UUID jobId) { ... }
}
```

```java
// StyleInjectionService.java — 提示词注入核心
@Service
public class StyleInjectionService {

    private final StyleProfileRepository profileRepo;
    private final StyleProfileSceneOverrideRepository overrideRepo;
    private final CharacterVoiceRepository voiceRepo;

    /**
     * 根据故事 ID 和场景类型，组装风格指令文本。
     * 1. 查找 story 下 is_active=true 的 StyleProfile
     * 2. 如果指定了 sceneType，合并 scene_override
     * 3. 返回可直接拼入 system prompt 的风格指令字符串
     */
    public String buildStylePrompt(UUID storyId, String sceneType) { ... }

    /**
     * 根据角色 ID，组装角色声音指令文本。
     * 查找 character_card_id 对应的 CharacterVoice，
     * 格式化为角色声音 prompt（见 §3.5）。
     */
    public String buildVoicePrompt(UUID characterId) { ... }

    /**
     * 组合方法：风格 + 涉及角色的声音 → 完整注入文本。
     * 在 AiService.chat() 调用前，将此文本 prepend 到 messages 中。
     */
    public String buildFullInjection(UUID storyId, String sceneType,
                                      List<UUID> characterIds) { ... }
}
```

```java
// CharacterVoiceService.java — 核心方法
@Service
public class CharacterVoiceService {

    /**
     * 根据 CharacterCard 的 name/synopsis/details/relationships，
     * 调用 AI 自动生成角色声音配置。
     */
    public CharacterVoiceDto generateVoiceFromCard(User user, UUID characterCardId) { ... }

    /**
     * 组装单个角色的声音 prompt 片段。
     */
    public String buildVoicePrompt(UUID characterId) { ... }
}
```

#### 3.2.4 与现有 AiService 的集成流程

```
用户发起"生成稿件段落"请求
        │
        ▼
ManuscriptService.generateSection()
        │
        ├─ 1. 获取 PromptTemplatesEntity.manuscriptSection 模板
        │
        ├─ 2. 调用 StyleInjectionService.buildFullInjection(storyId, sceneType, characterIds)
        │     ├─ 查询激活的 StyleProfile
        │     ├─ 合并 SceneOverride（如有）
        │     └─ 查询涉及角色的 CharacterVoice
        │
        ├─ 3. 将风格+声音指令作为 system message 的一部分
        │     拼入 AiChatRequest.messages 的首条
        │
        ├─ 4. AiService.chat(user, request)
        │     └─ AiGatewayGrpcClient.chatCompletions(...)
        │
        └─ 5. 返回生成结果
```

现有 `AiService.chat()` 方法无需修改签名，风格注入在调用方（ManuscriptService / StoryService）完成 message 组装即可。

### 3.3 API 设计

所有 v2 接口统一前缀 `/v2`，与现有 `/v1` 的 `StoryController` 共存。

#### 3.3.1 风格画像 API

##### GET /v2/stories/{storyId}/style-profiles

获取故事下所有风格画像。

**Response 200:**

```json
[
  {
    "id": "a1b2c3d4-...",
    "storyId": "s1s2s3s4-...",
    "name": "冷硬派叙事",
    "profileType": "global",
    "dimensions": {
      "formality": { "score": 7, "description": "偏正式，避免口语化表达" },
      "sentence_length": { "score": 6, "description": "中等偏长，允许复合句" },
      "vocabulary_richness": { "score": 8, "description": "词汇丰富，使用文学性词汇" },
      "pacing": { "score": 5, "description": "中等节奏，张弛有度" },
      "descriptiveness": { "score": 7, "description": "较高描写密度" },
      "dialogue_ratio": { "score": 4, "description": "对话占比偏低" },
      "emotional_intensity": { "score": 6, "description": "情感克制但有张力" },
      "rhetoric_frequency": { "score": 5, "description": "适度使用修辞" }
    },
    "sampleText": "他站在废墟边缘，风卷起灰尘...",
    "aiAnalysis": null,
    "isActive": true,
    "sceneOverrides": [
      {
        "sceneType": "action",
        "overrides": {
          "pacing": { "score": 9, "description": "极快节奏，短句为主" },
          "descriptiveness": { "score": 3, "description": "精简描写，聚焦动作" }
        }
      }
    ],
    "createdAt": "2026-02-17T10:00:00Z",
    "updatedAt": "2026-02-17T10:00:00Z"
  }
]
```

##### POST /v2/stories/{storyId}/style-profiles

创建风格画像。

**Request:**

```json
{
  "name": "冷硬派叙事",
  "profileType": "global",
  "dimensions": {
    "formality": { "score": 7, "description": "偏正式" },
    "sentence_length": { "score": 6, "description": "中等偏长" },
    "vocabulary_richness": { "score": 8, "description": "词汇丰富" },
    "pacing": { "score": 5, "description": "中等节奏" },
    "descriptiveness": { "score": 7, "description": "较高描写密度" },
    "dialogue_ratio": { "score": 4, "description": "对话占比偏低" },
    "emotional_intensity": { "score": 6, "description": "情感克制" },
    "rhetoric_frequency": { "score": 5, "description": "适度修辞" }
  },
  "sampleText": "他站在废墟边缘，风卷起灰尘...",
  "sceneOverrides": [
    {
      "sceneType": "action",
      "overrides": {
        "pacing": { "score": 9, "description": "极快节奏" },
        "descriptiveness": { "score": 3, "description": "精简描写" }
      }
    }
  ]
}
```

**Response 201:** 同 GET 单条结构。

##### PUT /v2/stories/{storyId}/style-profiles/{id}

更新风格画像。请求体同 POST，所有字段可选（PATCH 语义）。

**Request:**

```json
{
  "name": "冷硬派叙事 v2",
  "dimensions": {
    "formality": { "score": 8, "description": "更正式" }
  }
}
```

**Response 200:** 更新后的完整画像。

##### DELETE /v2/stories/{storyId}/style-profiles/{id}

删除风格画像。

**Response 204:** 无内容。

##### POST /v2/stories/{storyId}/style-profiles/{id}/activate

激活指定画像（同时停用该故事下同类型的其他画像）。

**Request:** 无请求体。

**Response 200:**

```json
{
  "id": "a1b2c3d4-...",
  "isActive": true,
  "deactivated": ["x1y2z3-..."]
}
```

##### POST /v2/style-analysis

分析文本提取风格指纹。

**Request:**

```json
{
  "sourceType": "uploaded_text",
  "text": "这是一段需要分析风格的文本...",
  "storyId": null
}
```

或引用已有稿件：

```json
{
  "sourceType": "manuscript",
  "manuscriptId": "m1m2m3m4-...",
  "storyId": "s1s2s3s4-..."
}
```

**Response 200（同步，短文本）:**

```json
{
  "dimensions": {
    "formality": { "score": 6, "description": "半正式，偶有口语" },
    "sentence_length": { "score": 7, "description": "偏长句" },
    "vocabulary_richness": { "score": 5, "description": "中等词汇量" },
    "pacing": { "score": 8, "description": "节奏较快" },
    "descriptiveness": { "score": 4, "description": "描写偏少" },
    "dialogue_ratio": { "score": 7, "description": "对话占比较高" },
    "emotional_intensity": { "score": 6, "description": "中等情感强度" },
    "rhetoric_frequency": { "score": 3, "description": "修辞较少" }
  },
  "summary": "该文本风格偏向快节奏的对话驱动叙事，词汇平实，情感表达直接。",
  "suggestedProfileName": "快节奏对话体"
}
```

**Response 202（异步，大文本/URL）:**

```json
{
  "jobId": "j1j2j3j4-...",
  "status": "pending",
  "pollUrl": "/v2/style-analysis/jobs/j1j2j3j4-..."
}
```

#### 3.3.2 角色声音 API

##### GET /v2/stories/{storyId}/character-voices

获取故事下所有角色声音配置。

**Response 200:**

```json
[
  {
    "id": "v1v2v3v4-...",
    "characterCardId": "c1c2c3c4-...",
    "characterName": "铁柱",
    "storyId": "s1s2s3s4-...",
    "speechPattern": "说话简短有力，常用祈使句，不喜欢解释",
    "vocabularyLevel": "colloquial",
    "catchphrases": ["老子说了算", "废话少说", "你这是在找死"],
    "emotionalRange": {
      "anger": "语速加快，用词粗鲁，喜欢反问",
      "sadness": "沉默寡言，偶尔冒出短句",
      "joy": "大笑，拍人肩膀，语气夸张",
      "fear": "结巴，声音发颤，不断重复"
    },
    "dialect": "北方口语",
    "sampleDialogues": [
      { "context": "战斗前", "line": "都给老子让开，这仗我一个人打！" },
      { "context": "安慰同伴", "line": "……别哭了。哭有什么用，不如磨刀。" }
    ],
    "aiAnalysis": null,
    "createdAt": "2026-02-17T10:00:00Z",
    "updatedAt": "2026-02-17T10:00:00Z"
  }
]
```

##### POST /v2/stories/{storyId}/character-voices

为角色创建声音配置。

**Request:**

```json
{
  "characterCardId": "c1c2c3c4-...",
  "speechPattern": "说话简短有力，常用祈使句",
  "vocabularyLevel": "colloquial",
  "catchphrases": ["老子说了算", "废话少说"],
  "emotionalRange": {
    "anger": "语速加快，用词粗鲁",
    "sadness": "沉默寡言"
  },
  "dialect": "北方口语",
  "sampleDialogues": [
    { "context": "战斗前", "line": "都给老子让开！" }
  ]
}
```

**Response 201:** 同 GET 单条结构。

##### PUT /v2/stories/{storyId}/character-voices/{id}

更新角色声音。请求体同 POST，所有字段可选。

**Request:**

```json
{
  "catchphrases": ["老子说了算", "废话少说", "你这是在找死"],
  "sampleDialogues": [
    { "context": "战斗前", "line": "都给老子让开，这仗我一个人打！" },
    { "context": "安慰同伴", "line": "……别哭了。哭有什么用，不如磨刀。" },
    { "context": "面对敌人", "line": "你最好祈祷你的剑比你的嘴快。" }
  ]
}
```

**Response 200:** 更新后的完整声音配置。

##### DELETE /v2/stories/{storyId}/character-voices/{id}

删除角色声音配置。

**Response 204:** 无内容。

##### POST /v2/stories/{storyId}/character-voices/{id}/generate

基于角色卡信息，AI 自动生成声音配置。

**Request:**

```json
{
  "additionalContext": "这个角色是个退伍老兵，性格暴躁但内心善良"
}
```

**Response 200:**

```json
{
  "id": "v1v2v3v4-...",
  "characterCardId": "c1c2c3c4-...",
  "characterName": "铁柱",
  "speechPattern": "说话简短有力，常用祈使句和反问句。不喜欢长篇大论，习惯用行动代替语言。偶尔会冒出军队里的术语。",
  "vocabularyLevel": "colloquial",
  "catchphrases": ["老子说了算", "废话少说", "执行！"],
  "emotionalRange": {
    "anger": "语速加快，声音压低，用词粗鲁直接",
    "sadness": "沉默不语，偶尔冒出一两个短句，避免眼神接触",
    "joy": "大笑，用力拍人肩膀，语气夸张豪爽",
    "fear": "表面镇定但语速变快，不断确认周围环境"
  },
  "dialect": "北方军旅口语",
  "sampleDialogues": [
    { "context": "战斗前动员", "line": "都给老子打起精神来！今天要么赢，要么死，没有第三条路！" },
    { "context": "安慰受伤同伴", "line": "……死不了。我见过比这重十倍的伤，那人现在还活蹦乱跳。" },
    { "context": "日常对话", "line": "吃饭。别磨蹭。" }
  ],
  "aiAnalysis": {
    "voiceSummary": "典型的军人硬汉形象，语言风格粗犷直接，内心柔软但不善表达。",
    "distinctiveness": 8,
    "consistency_tips": "注意保持短句风格，避免让该角色说出过于文雅或冗长的句子。"
  },
  "generated": true
}
```

### 3.4 前端设计

#### 3.4.1 组件架构

```
frontend/src/pages/
├── Settings/
│   ├── Settings.tsx                    ← 新增 Tab: "风格画像"
│   └── tabs/
│       ├── WorkspacePrompts.tsx        (现有)
│       ├── WorldPrompts.tsx            (现有)
│       └── StyleProfileManager.tsx     ← 新增：全局风格画像管理
│
├── Workbench/
│   ├── Workbench.tsx                   ← 现有 5 个 Tab 不变
│   └── tabs/
│       ├── StoryConception.tsx         ← 集成角色声音入口
│       └── StoryManager.tsx            ← 集成风格画像选择器
│
frontend/src/components/
├── style/
│   ├── StyleProfilePanel.tsx           ← 风格画像面板（侧边栏/弹窗）
│   ├── StyleDimensionSliders.tsx       ← 8 维度可视化滑块
│   ├── StyleSampleEditor.tsx           ← 参考文本编辑器
│   ├── StyleAnalysisResult.tsx         ← AI 分析结果展示
│   ├── StyleComparisonView.tsx         ← 双画像对比视图
│   └── SceneOverrideEditor.tsx         ← 场景模式覆盖编辑
├── voice/
│   ├── CharacterVoiceEditor.tsx        ← 角色声音编辑器
│   ├── VoiceSampleDialogues.tsx        ← 示例对话管理
│   ├── VoicePreview.tsx                ← 声音预览（生成样本文本）
│   └── EmotionalRangeEditor.tsx        ← 情感表达编辑
```

#### 3.4.2 StyleDimensionSliders 组件

使用 shadcn/ui 的 `Slider` 组件，为 8 个风格维度提供可视化控制：

```tsx
// StyleDimensionSliders.tsx 核心结构
import { Slider } from "@/components/ui/slider";
import { Label } from "@/components/ui/label";
import { Textarea } from "@/components/ui/textarea";

interface StyleDimension {
  key: string;
  label: string;
  score: number;        // 1-10
  description: string;
  leftLabel: string;    // 滑块左端标签
  rightLabel: string;   // 滑块右端标签
}

const DIMENSIONS: Omit<StyleDimension, 'score' | 'description'>[] = [
  { key: "formality",            label: "正式程度",   leftLabel: "口语化", rightLabel: "书面正式" },
  { key: "sentence_length",      label: "句子长度",   leftLabel: "短句为主", rightLabel: "长句复合" },
  { key: "vocabulary_richness",  label: "词汇丰富度", leftLabel: "平实简洁", rightLabel: "华丽丰富" },
  { key: "pacing",               label: "叙事节奏",   leftLabel: "舒缓",   rightLabel: "紧凑急促" },
  { key: "descriptiveness",      label: "描写密度",   leftLabel: "精简",   rightLabel: "浓墨重彩" },
  { key: "dialogue_ratio",       label: "对话占比",   leftLabel: "叙述为主", rightLabel: "对话驱动" },
  { key: "emotional_intensity",  label: "情感强度",   leftLabel: "克制冷静", rightLabel: "浓烈激昂" },
  { key: "rhetoric_frequency",   label: "修辞频率",   leftLabel: "朴素直白", rightLabel: "修辞丰富" },
];

// 每个维度渲染为：标签 + 滑块(1-10) + 描述输入框
// 滑块两端显示 leftLabel / rightLabel
```

#### 3.4.3 CharacterVoiceEditor 组件

嵌入现有 `StoryConception.tsx` 的角色卡编辑区域，在角色卡详情下方新增"声音配置"折叠面板：

```tsx
// CharacterVoiceEditor.tsx 核心结构
import { Accordion, AccordionContent, AccordionItem, AccordionTrigger } from "@/components/ui/accordion";
import { Button } from "@/components/ui/button";
import { Textarea } from "@/components/ui/textarea";
import { Select } from "@/components/ui/select";

interface CharacterVoiceEditorProps {
  characterCardId: string;
  storyId: string;
  voice: CharacterVoiceDto | null;
  onSave: (voice: CharacterVoiceDto) => void;
}

// 包含以下子区域：
// 1. 说话方式 (Textarea)
// 2. 词汇水平 (Select: colloquial/formal/archaic/mixed)
// 3. 口头禅列表 (可增删的 Input 列表)
// 4. 方言/语域 (Input)
// 5. 情感表达 (EmotionalRangeEditor — 按情感类型的 Textarea 组)
// 6. 示例对话 (VoiceSampleDialogues — 场景+台词的可增删列表)
// 7. "AI 生成" 按钮 — 调用 POST .../generate
// 8. "预览" 按钮 — 调用 VoicePreview 生成样本
```

#### 3.4.4 StyleComparisonView 组件

并排展示两个风格画像的雷达图对比：

```
┌─────────────────────────────────────────────┐
│  画像 A: 冷硬派叙事    画像 B: 华丽浪漫体    │
│  ┌──────────────┐    ┌──────────────┐       │
│  │   雷达图 A    │    │   雷达图 B    │       │
│  │  (8维度)     │    │  (8维度)     │       │
│  └──────────────┘    └──────────────┘       │
│                                             │
│  维度对比表：                                │
│  正式程度    ████████░░ 8   ████░░░░░░ 4    │
│  句子长度    ██████░░░░ 6   ████████░░ 8    │
│  词汇丰富度  ████████░░ 8   ██████████ 10   │
│  ...                                        │
└─────────────────────────────────────────────┘
```

#### 3.4.5 页面集成点

| 现有页面 | 集成方式 |
|----------|----------|
| `Settings.tsx` | 新增第三个 Tab "风格画像"，渲染 `StyleProfileManager` |
| `StoryConception.tsx` | 角色卡编辑区新增 `CharacterVoiceEditor` 折叠面板 |
| `StoryManager.tsx` | 故事详情侧边栏新增"风格画像"快捷入口 |
| `ManuscriptWriter.tsx` | 工具栏新增"风格/声音"指示器，显示当前激活画像 |
| `CopilotSidebar.tsx` | AI 对话中自动注入风格上下文 |

### 3.5 Prompt 工程

#### 3.5.1 风格分析 Prompt

用于 `StyleAnalysisService.analyzeStyle()`，通过 `AiGatewayGrpcClient.chatCompletions()` 调用。

```
你是一位专业的文学风格分析师。请分析以下文本的写作风格，从以下 8 个维度进行评分（1-10）并给出简要说明。

评分维度：
1. 正式程度 (formality) — 1=极口语化，10=极书面正式
2. 句子长度偏好 (sentence_length) — 1=极短句为主，10=长复合句为主
3. 词汇丰富度 (vocabulary_richness) — 1=基础词汇，10=文学性/专业词汇丰富
4. 叙事节奏 (pacing) — 1=极舒缓，10=极紧凑急促
5. 描写密度 (descriptiveness) — 1=极精简，10=浓墨重彩
6. 对话占比 (dialogue_ratio) — 1=纯叙述，10=对话驱动
7. 情感强度 (emotional_intensity) — 1=极克制冷静，10=极浓烈激昂
8. 修辞手法使用频率 (rhetoric_frequency) — 1=朴素直白，10=大量使用比喻、拟人、排比等

待分析文本：
---
{text}
---

请严格以如下 JSON 格式返回，不要包含其他内容：
{
  "dimensions": {
    "formality": { "score": <int>, "description": "<string>" },
    "sentence_length": { "score": <int>, "description": "<string>" },
    "vocabulary_richness": { "score": <int>, "description": "<string>" },
    "pacing": { "score": <int>, "description": "<string>" },
    "descriptiveness": { "score": <int>, "description": "<string>" },
    "dialogue_ratio": { "score": <int>, "description": "<string>" },
    "emotional_intensity": { "score": <int>, "description": "<string>" },
    "rhetoric_frequency": { "score": <int>, "description": "<string>" }
  },
  "summary": "<一句话总结该文本的整体风格特征>",
  "suggestedProfileName": "<建议的风格画像名称>"
}
```

#### 3.5.2 风格注入 Prompt

在生成稿件时，由 `StyleInjectionService.buildStylePrompt()` 组装，作为 system message 的一部分注入。

```
[写作风格指令]
你需要严格遵循以下写作风格进行创作。这是本书的核心风格定义，所有生成内容必须保持一致。

风格画像：{profile_name}

维度要求：
- 正式程度：{formality_score}/10 — {formality_description}
- 句子长度：{sentence_length_score}/10 — {sentence_length_description}
- 词汇水平：{vocabulary_richness_score}/10 — {vocabulary_richness_description}
- 叙事节奏：{pacing_score}/10 — {pacing_description}
- 描写密度：{descriptiveness_score}/10 — {descriptiveness_description}
- 对话占比：{dialogue_ratio_score}/10 — {dialogue_ratio_description}
- 情感强度：{emotional_intensity_score}/10 — {emotional_intensity_description}
- 修辞频率：{rhetoric_frequency_score}/10 — {rhetoric_frequency_description}

{if sample_text}
参考风格样本（请模仿此样本的语感和笔触）：
---
{sample_text_excerpt (前500字)}
---
{/if}

{if scene_overrides}
[当前场景模式覆盖：{scene_type}]
以下维度在当前场景中有特殊要求，优先级高于上方基础设定：
{foreach override}
- {dimension_label}：{override_score}/10 — {override_description}
{/foreach}
{/if}

请确保生成内容严格符合以上风格要求。
```

#### 3.5.3 角色声音 Prompt

在生成包含特定角色对话的内容时，由 `CharacterVoiceService.buildVoicePrompt()` 组装。

```
[角色声音指令 — {character_name}]
以下是角色「{character_name}」的语言特征定义。该角色的所有对话、内心独白必须严格符合这些特征。

说话方式：{speech_pattern}
词汇水平：{vocabulary_level}
方言/语域：{dialect}

{if catchphrases}
口头禅（在合适的场景中自然使用，不要每句都用）：
{foreach phrase in catchphrases}
- "{phrase}"
{/foreach}
{/if}

{if emotional_range}
情感表达方式：
{foreach emotion, expression in emotional_range}
- {emotion}时：{expression}
{/foreach}
{/if}

{if sample_dialogues}
示例对话（参考语感和用词习惯）：
{foreach dialogue in sample_dialogues}
[{dialogue.context}] {character_name}："{dialogue.line}"
{/foreach}
{/if}

重要提醒：
1. 该角色的对话必须与其他角色有明显区分度
2. 保持口头禅的自然使用频率，不要刻意堆砌
3. 根据当前情感状态调整说话方式
4. 词汇水平要一致——{vocabulary_level}水平的角色不应突然使用不符合其身份的词汇
```

#### 3.5.4 角色声音自动生成 Prompt

用于 `CharacterVoiceService.generateVoiceFromCard()`，根据现有 `CharacterCard` 的 `name`/`synopsis`/`details`/`relationships` 自动生成声音配置。

```
你是一位专业的小说角色语言设计师。请根据以下角色信息，为该角色设计独特的语言特征。

角色名：{character_name}
角色简介：{character_synopsis}
角色详情：{character_details}
角色关系：{character_relationships}

{if additional_context}
补充说明：{additional_context}
{/if}

请严格以如下 JSON 格式返回角色声音配置：
{
  "speechPattern": "<描述该角色的说话方式，包括句式偏好、语速特征、表达习惯等>",
  "vocabularyLevel": "<colloquial|formal|archaic|mixed 四选一>",
  "catchphrases": ["<口头禅1>", "<口头禅2>", "<口头禅3>"],
  "emotionalRange": {
    "anger": "<愤怒时的语言表现>",
    "sadness": "<悲伤时的语言表现>",
    "joy": "<高兴时的语言表现>",
    "fear": "<恐惧时的语言表现>",
    "surprise": "<惊讶时的语言表现>",
    "contempt": "<轻蔑时的语言表现>"
  },
  "dialect": "<方言或社会语域描述，如无则填'标准普通话'>",
  "sampleDialogues": [
    { "context": "<场景描述>", "line": "<台词>" },
    { "context": "<场景描述>", "line": "<台词>" },
    { "context": "<场景描述>", "line": "<台词>" }
  ],
  "voiceSummary": "<一句话总结该角色的语言风格>",
  "distinctiveness": <1-10的区分度评分>,
  "consistencyTips": "<保持该角色声音一致性的注意事项>"
}

要求：
1. 语言特征必须与角色身份、性格、背景高度匹配
2. 口头禅要自然，不能太刻意
3. 示例对话要覆盖不同情境（日常、冲突、情感）
4. 确保该角色的声音与常见角色模板有区分度
```

#### 3.5.5 多角色场景组合注入

当一个场景涉及多个角色对话时，`StyleInjectionService.buildFullInjection()` 将风格指令和所有涉及角色的声音指令组合：

```
{style_prompt}

---

[本场景涉及以下角色，请严格区分各角色的语言风格]

{foreach character in scene_characters}
{voice_prompt_for_character}

---
{/foreach}

[对话区分度要求]
以上角色在同一场景中对话时，读者应仅通过语言风格就能辨别说话者。
请特别注意：
- 不同角色的句式长度、用词习惯、语气应有明显差异
- 口头禅的使用要自然融入，不要生硬
- 情感表达方式要符合各角色的设定
```

---

## 4. 与现有代码的集成点

### 4.1 后端集成

| 现有文件 | 集成方式 | 说明 |
|----------|----------|------|
| `backend/.../story/model/CharacterCard.java` | 新增 `@OneToOne` 关联 | 添加 `CharacterVoice` 的反向引用，便于级联查询 |
| `backend/.../settings/model/PromptTemplatesEntity.java` | 无需修改 | 风格注入独立于模板系统，在调用层组装 |
| `backend/.../ai/AiService.java` | 无需修改签名 | `chat()` 方法接收的 `messages` 由调用方组装，风格指令作为 system message 注入 |
| `backend/.../manuscript/ManuscriptService.java` | 修改 `generateSection()` | 在构建 AI 请求前调用 `StyleInjectionService.buildFullInjection()` |
| `backend/.../story/StoryService.java` | 修改 `conception()` | 一键构思时可选择应用全局风格画像 |
| `backend/.../story/StoryController.java` | 无需修改 | v2 接口由新的 `StyleProfileController` 和 `CharacterVoiceController` 提供 |
| `backend/.../integration/AiGatewayGrpcClient.java` | 无需修改 | 底层 gRPC 调用不感知风格注入 |
| `backend/.../security/SecurityConfig.java` | 新增 `/v2/**` 路径授权 | 确保 v2 接口受 JWT 保护 |

### 4.2 前端集成

| 现有文件 | 集成方式 | 说明 |
|----------|----------|------|
| `frontend/.../pages/Settings/Settings.tsx` | 新增 Tab | 添加"风格画像"Tab，引入 `StyleProfileManager` |
| `frontend/.../pages/Workbench/tabs/StoryConception.tsx` | 扩展角色卡区域 | 在角色卡详情下方嵌入 `CharacterVoiceEditor` |
| `frontend/.../pages/Workbench/tabs/StoryManager.tsx` | 新增侧边栏入口 | 故事详情中添加"风格画像"快捷链接 |
| `frontend/.../pages/Workbench/tabs/ManuscriptWriter.tsx` | 工具栏扩展 | 显示当前激活风格画像名称和状态指示器 |
| `frontend/.../components/ai/CopilotSidebar.tsx` | 上下文注入 | AI 对话时自动携带风格上下文 |
| `frontend/.../components/editor/TiptapEditor.tsx` | 无需修改 | 编辑器本身不感知风格系统 |

### 4.3 与其他 v2 模块的协作

| 模块 | 协作方式 |
|------|----------|
| **01-上下文记忆** | 风格画像和角色声音作为长期记忆的一部分，在上下文窗口中优先保留 |
| **03-Beta-Reader** | Beta-Reader 检查时可验证风格一致性——对比生成内容与激活画像的维度偏差 |
| **06-多模型协作** | 不同模型可能对风格指令的响应不同，需要在多模型协作层做风格校准 |

---

## 5. 实施注意事项

### 5.1 数据迁移

- 新增三张表（`style_profiles`、`style_profile_scene_overrides`、`character_voices`）和一张任务表（`style_analysis_jobs`），均为纯新增，不影响现有表结构。
- 使用 Flyway/Liquibase 管理 DDL 迁移脚本，建议版本号 `V2.0.1__create_style_tables.sql`。
- 现有 `CharacterCard` 实体添加 `@OneToOne(mappedBy = "characterCard")` 反向引用，不改变数据库 schema。

### 5.2 性能考量

- `StyleInjectionService.buildFullInjection()` 在每次 AI 调用时执行，需确保查询高效：
  - `style_profiles` 按 `(story_id, is_active)` 索引查询，命中率高。
  - `character_voices` 按 `character_card_id` 唯一索引查询。
  - 考虑对激活画像做应用层缓存（Caffeine，TTL 5 分钟），减少数据库查询。
- 风格分析（`StyleAnalysisService`）为 AI 密集型操作，大文本走异步 job 队列，避免阻塞请求线程。
- `dimensions_json` 等 JSON 字段使用 `TEXT` 类型而非 `JSON` 类型，兼容 MySQL 5.7+，解析在应用层完成。

### 5.3 安全性

- 所有 v2 接口需通过 `SecurityConfig` 配置 JWT 认证。
- 风格画像和角色声音的 CRUD 操作需校验 `user_id` 归属，防止越权访问。
- `style_analysis_jobs` 的 `source_reference` 字段如果是 URL 类型，需做 URL 白名单校验，防止 SSRF。
- `sample_text` 和 `sample_dialogues_json` 需做内容长度限制（建议 sample_text <= 5000 字，单条对话 <= 500 字）。

### 5.4 向后兼容

- v1 接口（`/v1/...`）完全不受影响，`StoryController` 无需修改。
- 未配置风格画像的故事，AI 生成行为与 v1 完全一致（`StyleInjectionService` 返回空字符串）。
- 未配置角色声音的角色，对话生成不注入声音指令。

### 5.5 开发顺序建议

| 阶段 | 内容 | 预估工时 |
|------|------|----------|
| Phase 1 | 数据模型 + Repository + 基础 CRUD API | 3 天 |
| Phase 2 | StyleAnalysisService（AI 风格分析） | 2 天 |
| Phase 3 | StyleInjectionService + 与 ManuscriptService 集成 | 2 天 |
| Phase 4 | CharacterVoiceService（含 AI 自动生成） | 2 天 |
| Phase 5 | 前端 StyleProfilePanel + StyleDimensionSliders | 3 天 |
| Phase 6 | 前端 CharacterVoiceEditor + VoicePreview | 3 天 |
| Phase 7 | 前端 StyleComparisonView + 页面集成 | 2 天 |
| Phase 8 | 端到端测试 + Prompt 调优 | 3 天 |
| **合计** | | **20 天** |

---

## 6. 验收标准

### 6.1 功能验收

| 编号 | 验收项 | 通过条件 |
|------|--------|----------|
| AC-1 | 风格画像 CRUD | 用户可创建、编辑、删除、激活风格画像；同一故事同一类型仅一个激活画像 |
| AC-2 | 风格维度滑块 | 8 个维度滑块可独立调节（1-10），每个维度可附加文字说明 |
| AC-3 | 场景模式覆盖 | 可为 action/dialogue/introspection/description/flashback 设置维度覆盖值 |
| AC-4 | 风格分析 | 粘贴文本后点击"分析"，AI 返回 8 维度评分 + 总结 + 建议画像名称 |
| AC-5 | 风格分析转画像 | 分析结果可一键转为风格画像 |
| AC-6 | 角色声音 CRUD | 用户可为每个角色卡创建、编辑、删除声音配置 |
| AC-7 | AI 生成声音 | 点击"AI 生成"，基于角色卡信息自动生成声音配置（含口头禅、示例对话等） |
| AC-8 | 声音预览 | 点击"预览"，AI 生成一段该角色的示例对话文本 |
| AC-9 | 风格注入生效 | 激活风格画像后，生成的稿件段落风格与画像设定一致（人工评审） |
| AC-10 | 角色声音注入生效 | 配置角色声音后，生成的对话符合角色语言特征（人工评审） |
| AC-11 | 多角色区分度 | 同一场景中多个角色的对话，仅通过语言风格可辨别说话者（人工评审） |
| AC-12 | 无画像降级 | 未配置风格画像/角色声音时，AI 生成行为与 v1 完全一致 |

### 6.2 非功能验收

| 编号 | 验收项 | 通过条件 |
|------|--------|----------|
| NF-1 | 风格注入延迟 | `buildFullInjection()` 执行时间 < 50ms（含数据库查询） |
| NF-2 | 风格分析响应 | 短文本（< 2000 字）同步返回，< 15 秒；长文本异步，job 创建 < 500ms |
| NF-3 | 并发安全 | 同一故事的画像激活操作在并发场景下不会出现多个激活画像 |
| NF-4 | 数据完整性 | 删除故事时级联删除关联的风格画像和角色声音 |
| NF-5 | API 文档 | 所有 v2 接口在 Swagger UI 中可见且示例完整 |



