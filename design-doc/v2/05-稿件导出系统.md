# 稿件导出系统

## 文档信息

| 字段 | 值 |
|------|-----|
| 版本 | v2.0 |
| 日期 | 2026-02-17 |
| 优先级 | P2 |
| 关联模块 | 04-版本控制, 07-工作台 |

---

## 1. 背景与动机

### 1.1 问题陈述

AINovel v1 版本不具备任何导出能力。作者在平台上完成的作品只能在系统内部查看和编辑，无法以标准出版格式输出。这带来了以下核心痛点：

1. **作品锁定**：作者的创作成果被锁定在平台内，无法提交给出版社、上传到电子书平台（如 Kindle、豆瓣阅读、起点中文网）或分享给 Beta 读者。
2. **排版缺失**：`Manuscript.sectionsJson` 以 JSON 键值对（`sceneId -> content`）存储正文，没有章节排序、分页、字体样式等排版信息，无法直接用于阅读或印刷。
3. **元数据断裂**：`Story` 实体中的 `title`、`synopsis`、`genre`、`tone` 等元数据与稿件正文分离存储，导出时需要手动组装标题页、目录和版权信息。
4. **大稿件阻塞**：长篇小说（10万字以上）的导出是 CPU 密集型操作（尤其 PDF 渲染），如果同步执行会阻塞 HTTP 请求线程，导致超时。

当前数据流：

```
Outline.contentJson          Manuscript.sectionsJson
(章节/场景结构树)              (sceneId -> 正文内容)
        │                              │
        └──────── 无导出管道 ──────────┘
                      ↓
                    (空)
```

### 1.2 业界参考

| 产品 | 核心机制 | 借鉴点 |
|------|----------|--------|
| **Scrivener Compile** | 多目标编译引擎，支持 DOCX/PDF/EPUB/Kindle，可自定义编译格式（字体、间距、章节标题样式），支持前言/后记/版权页模板 | 模板系统设计、格式配置粒度、章节范围选择 |
| **Google Docs 导出** | 一键导出为 DOCX/PDF/TXT/HTML/EPUB，保留文档内样式，PDF 使用服务端渲染 | 简洁的用户交互、异步大文件处理 |
| **Reedsy Book Editor** | 专业排版导出，内置出版级模板（小说/非虚构/诗集），支持 EPUB3 和 Print-Ready PDF，自动生成目录和标题页 | 出版级模板预设、EPUB3 标准合规、Print-Ready PDF |
| **Atticus** | 拖拽式排版编辑器，300+ 格式化主题，支持 EPUB/PDF 双格式同步预览，内置字体嵌入 | 主题/模板市场概念、字体嵌入策略、实时预览 |
| **Vellum (macOS)** | 所见即所得的电子书排版，自动适配不同阅读器，支持装饰性章节标题和场景分隔符 | 阅读器兼容性处理、装饰元素支持 |

---

## 2. 设计目标

1. **四格式覆盖**：支持 TXT、DOCX、EPUB、PDF 四种主流格式导出，覆盖纯文本分享、编辑协作、电子书发布和印刷排版四大场景。

2. **可配置排版**：每种格式提供独立的配置项（字体、字号、行距、页边距、章节标题样式、分页策略等），用户可根据需求自定义排版参数。

3. **模板系统**：提供系统预设模板（网文风格、文学出版风格、投稿格式等）和用户自定义模板，模板可保存、复用和分享。

4. **批量导出**：支持全书导出或按章节范围选择性导出，满足分批投稿、试读章节分享等场景。

5. **元数据组装**：导出时可选择包含标题页、目录、作者信息、版权声明等元数据，EPUB 格式额外支持封面图片和 ISBN。

6. **异步处理**：大稿件导出采用 Spring `@Async` 异步执行 + 状态轮询机制，避免阻塞请求线程，支持进度追踪。

7. **自动清理**：导出文件设置过期时间，到期后自动清理，避免磁盘空间无限增长。

8. **CJK 支持**：PDF 和 EPUB 导出内置中日韩字体支持，确保中文排版正确渲染。

---

## 3. 详细设计

### 3.1 数据模型

#### 3.1.1 表：`export_templates` — 导出模板表

存储系统预设和用户自定义的导出格式模板。

```sql
CREATE TABLE export_templates (
    id              CHAR(36)        NOT NULL    COMMENT '主键 UUID',
    user_id         CHAR(36)        NULL        COMMENT '所属用户 FK -> users.id；NULL 表示系统预设模板',
    name            VARCHAR(100)    NOT NULL    COMMENT '模板名称',
    description     VARCHAR(500)    NULL        COMMENT '模板描述',
    format          ENUM('txt','docx','epub','pdf')
                                    NOT NULL    COMMENT '目标格式',
    config_json     TEXT            NOT NULL    COMMENT '格式专属配置 JSON',
    is_default      BOOLEAN         NOT NULL    DEFAULT FALSE
                                                COMMENT '是否为该格式的默认模板',
    created_at      TIMESTAMP       NOT NULL    DEFAULT CURRENT_TIMESTAMP
                                                COMMENT '创建时间',
    updated_at      TIMESTAMP       NOT NULL    DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
                                                COMMENT '更新时间',

    PRIMARY KEY (id),
    INDEX idx_export_tpl_user (user_id),
    INDEX idx_export_tpl_format (format),
    CONSTRAINT fk_export_tpl_user
        FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci
  COMMENT='导出模板表';
```

#### 3.1.2 表：`export_jobs` — 导出任务表

记录每次导出操作的状态、配置和结果。

```sql
CREATE TABLE export_jobs (
    id              CHAR(36)        NOT NULL    COMMENT '主键 UUID',
    user_id         CHAR(36)        NOT NULL    COMMENT '发起用户 FK -> users.id',
    story_id        CHAR(36)        NOT NULL    COMMENT '所属故事 FK -> stories.id',
    manuscript_id   CHAR(36)        NOT NULL    COMMENT '导出稿件 FK -> manuscripts.id',
    template_id     CHAR(36)        NULL        COMMENT '使用模板 FK -> export_templates.id；NULL 表示自定义配置',
    format          ENUM('txt','docx','epub','pdf')
                                    NOT NULL    COMMENT '导出格式',
    config_json     TEXT            NOT NULL    COMMENT '本次导出的完整配置快照',
    chapter_range   VARCHAR(200)    NULL        COMMENT '章节范围，如 "1-5" 或 "all"；NULL 等同 "all"',
    status          ENUM('queued','processing','completed','failed')
                                    NOT NULL    DEFAULT 'queued'
                                                COMMENT '任务状态',
    progress        INT             NOT NULL    DEFAULT 0
                                                COMMENT '进度百分比 0-100',
    file_path       VARCHAR(500)    NULL        COMMENT '生成文件的存储路径',
    file_name       VARCHAR(300)    NULL        COMMENT '生成文件的下载文件名',
    file_size_bytes BIGINT          NULL        COMMENT '文件大小（字节）',
    error_message   TEXT            NULL        COMMENT '失败时的错误信息',
    expires_at      TIMESTAMP       NULL        COMMENT '文件过期时间，过期后自动清理',
    created_at      TIMESTAMP       NOT NULL    DEFAULT CURRENT_TIMESTAMP
                                                COMMENT '创建时间',

    PRIMARY KEY (id),
    INDEX idx_export_job_user (user_id),
    INDEX idx_export_job_story (story_id),
    INDEX idx_export_job_manuscript (manuscript_id),
    INDEX idx_export_job_status (status),
    INDEX idx_export_job_expires (expires_at),
    CONSTRAINT fk_export_job_user
        FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    CONSTRAINT fk_export_job_story
        FOREIGN KEY (story_id) REFERENCES stories(id) ON DELETE CASCADE,
    CONSTRAINT fk_export_job_manuscript
        FOREIGN KEY (manuscript_id) REFERENCES manuscripts(id) ON DELETE CASCADE,
    CONSTRAINT fk_export_job_template
        FOREIGN KEY (template_id) REFERENCES export_templates(id) ON DELETE SET NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci
  COMMENT='导出任务表';
```

#### 3.1.3 config_json 结构定义

每种格式的 `config_json` 遵循独立的 JSON Schema：

**TXT 配置：**

```json
{
  "encoding": "UTF-8",
  "lineEnding": "LF",
  "chapterSeparator": "\n\n========\n\n",
  "sceneSeparator": "\n\n---\n\n",
  "includeMetadata": true,
  "includeChapterTitles": true,
  "indentFirstLine": true,
  "indentSpaces": 4
}
```

| 字段 | 类型 | 默认值 | 说明 |
|------|------|--------|------|
| encoding | string | "UTF-8" | 文件编码，可选 UTF-8 / GBK / GB18030 |
| lineEnding | string | "LF" | 换行符，可选 LF / CRLF |
| chapterSeparator | string | "\n\n========\n\n" | 章节间分隔符 |
| sceneSeparator | string | "\n\n---\n\n" | 场景间分隔符 |
| includeMetadata | boolean | true | 是否在文件头部包含书名、作者等信息 |
| includeChapterTitles | boolean | true | 是否输出章节标题 |
| indentFirstLine | boolean | true | 段落首行是否缩进 |
| indentSpaces | int | 4 | 首行缩进空格数 |

**DOCX 配置：**

```json
{
  "fontFamily": "SimSun",
  "fontSize": 12,
  "lineSpacing": 1.5,
  "margins": {
    "top": 2.54,
    "bottom": 2.54,
    "left": 3.18,
    "right": 3.18
  },
  "headerStyle": {
    "fontFamily": "SimHei",
    "fontSize": 16,
    "bold": true,
    "alignment": "CENTER"
  },
  "pageBreakBetweenChapters": true,
  "includeToc": true,
  "includeTitlePage": true,
  "titlePageConfig": {
    "title": true,
    "author": true,
    "synopsis": false,
    "date": false
  },
  "headerFooter": {
    "headerText": "",
    "showPageNumbers": true,
    "pageNumberPosition": "BOTTOM_CENTER"
  }
}
```

| 字段 | 类型 | 默认值 | 说明 |
|------|------|--------|------|
| fontFamily | string | "SimSun" | 正文字体 |
| fontSize | int | 12 | 正文字号（磅） |
| lineSpacing | double | 1.5 | 行距倍数 |
| margins | object | {2.54, 2.54, 3.18, 3.18} | 页边距（厘米） |
| headerStyle | object | — | 章节标题样式 |
| pageBreakBetweenChapters | boolean | true | 章节间是否分页 |
| includeToc | boolean | true | 是否生成目录 |
| includeTitlePage | boolean | true | 是否生成标题页 |
| titlePageConfig | object | — | 标题页包含的元素 |
| headerFooter | object | — | 页眉页脚配置 |

**EPUB 配置：**

```json
{
  "coverImage": null,
  "language": "zh-CN",
  "publisher": "",
  "isbn": "",
  "rights": "",
  "cssOverride": "",
  "includeToc": true,
  "includeTitlePage": true,
  "chapterPageBreak": true,
  "fontEmbedding": {
    "enabled": false,
    "fonts": []
  },
  "metadata": {
    "subject": "",
    "description": "",
    "contributors": []
  }
}
```

| 字段 | 类型 | 默认值 | 说明 |
|------|------|--------|------|
| coverImage | string/null | null | 封面图片 URL 或 Base64；null 则不含封面 |
| language | string | "zh-CN" | EPUB 语言标识 |
| publisher | string | "" | 出版方 |
| isbn | string | "" | ISBN 编号 |
| rights | string | "" | 版权声明 |
| cssOverride | string | "" | 自定义 CSS 覆盖默认样式 |
| includeToc | boolean | true | 是否生成导航目录 |
| includeTitlePage | boolean | true | 是否生成标题页 |
| chapterPageBreak | boolean | true | 章节间是否分页 |
| fontEmbedding | object | — | 字体嵌入配置 |
| metadata | object | — | 扩展元数据 |

**PDF 配置：**

```json
{
  "paperSize": "A4",
  "fontFamily": "SimSun",
  "fontSize": 12,
  "lineSpacing": 1.5,
  "margins": {
    "top": 2.54,
    "bottom": 2.54,
    "left": 3.18,
    "right": 3.18
  },
  "headerStyle": {
    "fontFamily": "SimHei",
    "fontSize": 18,
    "bold": true,
    "alignment": "CENTER"
  },
  "headerFooter": {
    "headerText": "",
    "footerText": "",
    "showPageNumbers": true,
    "pageNumberPosition": "BOTTOM_CENTER",
    "firstPageDifferent": true
  },
  "pageNumbers": true,
  "includeToc": true,
  "includeTitlePage": true,
  "titlePageConfig": {
    "title": true,
    "author": true,
    "synopsis": false,
    "genre": false,
    "date": false
  },
  "watermark": {
    "enabled": false,
    "text": ""
  }
}
```

| 字段 | 类型 | 默认值 | 说明 |
|------|------|--------|------|
| paperSize | string | "A4" | 纸张大小，可选 A4 / A5 / B5 / LETTER / CUSTOM |
| fontFamily | string | "SimSun" | 正文字体 |
| fontSize | int | 12 | 正文字号（磅） |
| lineSpacing | double | 1.5 | 行距倍数 |
| margins | object | {2.54, 2.54, 3.18, 3.18} | 页边距（厘米） |
| headerStyle | object | — | 章节标题样式 |
| headerFooter | object | — | 页眉页脚配置 |
| pageNumbers | boolean | true | 是否显示页码 |
| includeToc | boolean | true | 是否生成目录 |
| includeTitlePage | boolean | true | 是否生成标题页 |
| titlePageConfig | object | — | 标题页包含的元素 |
| watermark | object | — | 水印配置（草稿标记等） |

### 3.2 后端设计

#### 3.2.1 包结构

```
backend/src/main/java/com/ainovel/app/export/
├── ExportController.java              # REST 控制器
├── ExportService.java                 # 导出编排服务（入口）
├── ExportJobService.java              # 异步任务管理
├── ExportTemplateService.java         # 模板 CRUD
├── ManuscriptAssembler.java           # 稿件内容组装器
├── model/
│   ├── ExportJob.java                 # 导出任务实体
│   ├── ExportTemplate.java            # 导出模板实体
│   ├── ExportFormat.java              # 格式枚举
│   └── ExportStatus.java             # 状态枚举
├── dto/
│   ├── ExportRequest.java             # 导出请求 DTO
│   ├── ExportJobDto.java              # 任务状态 DTO
│   ├── ExportTemplateDto.java         # 模板 DTO
│   ├── ExportTemplateCreateRequest.java
│   ├── ExportTemplateUpdateRequest.java
│   └── AssembledManuscript.java       # 组装后的稿件数据
├── exporter/
│   ├── FormatExporter.java            # 导出器接口
│   ├── TxtExporter.java              # TXT 导出实现
│   ├── DocxExporter.java             # DOCX 导出实现 (Apache POI)
│   ├── EpubExporter.java             # EPUB 导出实现 (epublib)
│   └── PdfExporter.java              # PDF 导出实现 (OpenPDF)
├── repo/
│   ├── ExportJobRepository.java
│   └── ExportTemplateRepository.java
└── cleanup/
    └── ExportFileCleanupTask.java     # 定时清理过期文件
```

#### 3.2.2 核心接口与类

**FormatExporter 接口：**

```java
package com.ainovel.app.export.exporter;

import com.ainovel.app.export.dto.AssembledManuscript;

public interface FormatExporter {

    /**
     * 将组装后的稿件导出为目标格式的字节数组。
     *
     * @param manuscript 组装后的稿件（有序章节/场景 + 元数据）
     * @param configJson 格式专属配置 JSON 字符串
     * @return 生成的文件字节数组
     */
    byte[] export(AssembledManuscript manuscript, String configJson);

    /**
     * 返回导出文件的 MIME 类型。
     */
    String contentType();

    /**
     * 返回导出文件的扩展名（不含点号）。
     */
    String fileExtension();
}
```

**AssembledManuscript DTO：**

```java
package com.ainovel.app.export.dto;

import java.util.List;

public class AssembledManuscript {
    private String storyTitle;
    private String authorName;
    private String synopsis;
    private String genre;
    private String tone;
    private List<AssembledChapter> chapters;

    public static class AssembledChapter {
        private String chapterId;
        private String title;
        private int order;
        private String summary;
        private List<AssembledScene> scenes;
    }

    public static class AssembledScene {
        private String sceneId;
        private String title;
        private int order;
        private String content;   // 正文文本
        private String summary;   // 场景摘要（可选，用于 TOC 描述）
    }
}
```

**ManuscriptAssembler — 稿件组装器：**

```java
package com.ainovel.app.export;

import com.ainovel.app.export.dto.AssembledManuscript;
import com.ainovel.app.manuscript.model.Manuscript;
import com.ainovel.app.story.model.Outline;
import com.ainovel.app.story.model.Story;

/**
 * 从 Manuscript.sectionsJson + Outline.contentJson + Story 元数据
 * 组装出有序的、可供导出器消费的 AssembledManuscript。
 */
public class ManuscriptAssembler {

    /**
     * 组装稿件。
     *
     * 流程：
     * 1. 从 Outline.contentJson 解析章节/场景结构树，获取排序信息
     * 2. 从 Manuscript.sectionsJson 解析 sceneId -> content 映射
     * 3. 按 Outline 中的章节顺序和场景顺序，将正文内容填入结构
     * 4. 从 Story 读取 title/synopsis/genre/tone 作为元数据
     * 5. 从 User 读取 username 作为作者名
     * 6. 如指定了章节范围，则过滤到目标章节
     *
     * @param manuscriptId 稿件 ID
     * @param chapterRange 章节范围（如 "1-5"），null 表示全部
     * @return 组装后的稿件
     */
    public AssembledManuscript assemble(java.util.UUID manuscriptId, String chapterRange);
}
```

**ExportService — 导出编排服务：**

```java
package com.ainovel.app.export;

import com.ainovel.app.export.model.ExportFormat;
import com.ainovel.app.export.model.ExportJob;

import java.util.UUID;

public class ExportService {

    /**
     * 发起导出任务。
     *
     * 1. 校验 manuscriptId 存在且属于当前用户
     * 2. 创建 ExportJob 记录，状态 = queued
     * 3. 调用 ExportJobService.executeAsync() 异步执行
     * 4. 返回 ExportJob（含 jobId 供前端轮询）
     */
    public ExportJob startExport(UUID manuscriptId, ExportFormat format,
                                  String configJson, UUID templateId,
                                  String chapterRange);

    /**
     * 查询导出任务状态。
     */
    public ExportJob getJobStatus(UUID jobId);

    /**
     * 获取导出文件的字节流（用于下载）。
     */
    public byte[] downloadFile(UUID jobId);
}
```

**ExportJobService — 异步任务执行：**

```java
package com.ainovel.app.export;

import org.springframework.scheduling.annotation.Async;

public class ExportJobService {

    /**
     * 异步执行导出任务。
     *
     * 流程：
     * 1. 更新 job 状态 → processing, progress = 0
     * 2. 调用 ManuscriptAssembler.assemble() 组装内容 → progress = 30
     * 3. 根据 format 选择对应的 FormatExporter
     * 4. 调用 exporter.export() 生成文件字节 → progress = 80
     * 5. 将文件写入临时存储目录 → progress = 90
     * 6. 更新 job：status = completed, filePath, fileSize, expiresAt → progress = 100
     *
     * 异常处理：
     * - 捕获所有异常，更新 job：status = failed, errorMessage
     */
    @Async("exportTaskExecutor")
    public void executeAsync(java.util.UUID jobId);
}
```

#### 3.2.3 各格式导出器实现要点

**TxtExporter：**

```java
// 依赖：纯 Java，无第三方库
// 实现要点：
// 1. 按 encoding 配置创建 OutputStreamWriter
// 2. 如 includeMetadata=true，写入书名、作者、分隔线
// 3. 遍历 chapters，写入章节标题 + 场景正文
// 4. 段落首行缩进处理（indentFirstLine + indentSpaces）
// 5. 章节间插入 chapterSeparator，场景间插入 sceneSeparator
// 6. 按 lineEnding 配置统一换行符
```

**DocxExporter：**

```java
// 依赖：org.apache.poi:poi-ooxml 5.2.x
// 实现要点：
// 1. 创建 XWPFDocument
// 2. 设置页面大小和页边距（CTSectPr）
// 3. 如 includeTitlePage=true，生成标题页（居中大标题 + 作者名）
// 4. 如 includeToc=true，插入 TOC 域代码（Word 打开时自动更新）
// 5. 遍历 chapters：
//    a. 如 pageBreakBetweenChapters=true，插入分页符
//    b. 创建 Heading1 段落写入章节标题（应用 headerStyle）
//    c. 遍历 scenes，按段落写入正文（应用 fontFamily/fontSize/lineSpacing）
// 6. 设置页眉页脚（页码位置）
// 7. 中文字体处理：确保 SimSun/SimHei 等字体名正确映射
```

**EpubExporter：**

```java
// 依赖：io.documentnode:epub4j-core 4.2.x
// 实现要点：
// 1. 创建 Book 对象
// 2. 设置 metadata：title, author, language, publisher, isbn, rights
// 3. 如 coverImage 非空，添加封面资源
// 4. 生成默认 CSS 样式表（或使用 cssOverride）
// 5. 如 includeTitlePage=true，生成标题页 XHTML
// 6. 遍历 chapters，每章生成一个 XHTML 文件：
//    a. 章节标题 <h1>
//    b. 场景正文 <p> 段落（场景间用 <hr/> 分隔）
// 7. 如 includeToc=true，生成 NCX 导航和 EPUB3 nav.xhtml
// 8. 字体嵌入：如 fontEmbedding.enabled=true，将字体文件打包进 EPUB
// 9. 使用 EpubWriter 输出字节数组
```

**PdfExporter：**

```java
// 依赖：com.github.librepdf:openpdf 2.0.x
// 实现要点：
// 1. 创建 Document，设置 paperSize 和 margins
// 2. 注册中文字体（BaseFont.createFont 加载 SimSun.ttf / NotoSansCJK）
// 3. 如 includeTitlePage=true，生成标题页（居中标题 + 作者 + 可选简介）
// 4. 如 includeToc=true，生成目录页（章节标题 + 页码占位，二次渲染填充）
// 5. 遍历 chapters：
//    a. 新章节起始新页面
//    b. 写入章节标题（应用 headerStyle 字体/字号/加粗/对齐）
//    c. 遍历 scenes，按段落写入正文
//    d. 场景间插入空行或分隔符
// 6. 设置页眉页脚（HeaderFooter 事件监听器）
// 7. 如 watermark.enabled=true，添加水印文字
// 8. 二次渲染：回填目录页码（PdfStamper）
```

#### 3.2.4 异步执行器配置

```java
@Configuration
@EnableAsync
public class ExportAsyncConfig {

    @Bean("exportTaskExecutor")
    public TaskExecutor exportTaskExecutor() {
        ThreadPoolTaskExecutor executor = new ThreadPoolTaskExecutor();
        executor.setCorePoolSize(2);
        executor.setMaxPoolSize(4);
        executor.setQueueCapacity(50);
        executor.setThreadNamePrefix("export-");
        executor.setRejectedExecutionHandler(new ThreadPoolExecutor.CallerRunsPolicy());
        executor.initialize();
        return executor;
    }
}
```

#### 3.2.5 定时清理任务

```java
@Component
public class ExportFileCleanupTask {

    /**
     * 每小时执行一次，清理已过期的导出文件。
     * 1. 查询 expires_at < NOW() 且 status = 'completed' 的 job
     * 2. 删除对应的物理文件
     * 3. 更新 job：file_path = null, file_size_bytes = null
     */
    @Scheduled(cron = "0 0 * * * *")
    public void cleanExpiredFiles();
}
```

#### 3.2.6 导出流程时序图

```
用户          ExportController    ExportService    ExportJobService    ManuscriptAssembler    FormatExporter    文件系统
 │                 │                  │                  │                     │                    │              │
 │─POST /export──→│                  │                  │                     │                    │              │
 │                 │──startExport()─→│                  │                     │                    │              │
 │                 │                  │──创建 ExportJob──→│                     │                    │              │
 │                 │                  │   status=queued  │                     │                    │              │
 │                 │                  │──executeAsync()─→│                     │                    │              │
 │                 │                  │                  │                     │                    │              │
 │←─202 {jobId}───│                  │                  │                     │                    │              │
 │                 │                  │                  │                     │                    │              │
 │                 │                  │                  │──assemble()────────→│                    │              │
 │                 │                  │                  │                     │──读取 Outline──────→│              │
 │                 │                  │                  │                     │──读取 Manuscript───→│              │
 │                 │                  │                  │                     │──读取 Story────────→│              │
 │                 │                  │                  │←─AssembledManuscript│                    │              │
 │                 │                  │                  │                     │                    │              │
 │                 │                  │                  │──export()──────────────────────────────→│              │
 │                 │                  │                  │←─byte[]────────────────────────────────│              │
 │                 │                  │                  │                     │                    │              │
 │                 │                  │                  │──写入文件──────────────────────────────────────────────→│
 │                 │                  │                  │──更新 job: completed │                    │              │
 │                 │                  │                  │                     │                    │              │
 │─GET /jobs/{id}→│                  │                  │                     │                    │              │
 │←─{status,progress}                │                  │                     │                    │              │
 │                 │                  │                  │                     │                    │              │
 │─GET /download─→│                  │                  │                     │                    │              │
 │←─文件流────────│                  │                  │                     │                    │              │
```

### 3.3 API 设计

所有接口使用 `/v2` 前缀，与 v1 的 `/v1` 路径隔离。需要 Bearer Token 认证。

#### 3.3.1 导出操作接口

**POST /v2/manuscripts/{manuscriptId}/export — 发起导出任务**

请求：

```json
{
  "format": "docx",
  "templateId": "550e8400-e29b-41d4-a716-446655440001",
  "configOverrides": {
    "fontFamily": "KaiTi",
    "includeToc": false
  },
  "chapterRange": "1-10"
}
```

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| format | string | 是 | 导出格式：txt / docx / epub / pdf |
| templateId | string | 否 | 使用的模板 ID；不传则使用该格式的默认配置 |
| configOverrides | object | 否 | 覆盖模板中的部分配置项（与模板配置合并） |
| chapterRange | string | 否 | 章节范围，如 "1-5"、"3"、"all"；不传等同 "all" |

响应（202 Accepted）：

```json
{
  "id": "660e8400-e29b-41d4-a716-446655440099",
  "manuscriptId": "770e8400-e29b-41d4-a716-446655440010",
  "storyId": "880e8400-e29b-41d4-a716-446655440020",
  "format": "docx",
  "status": "queued",
  "progress": 0,
  "chapterRange": "1-10",
  "createdAt": "2026-02-17T10:30:00Z"
}
```

**GET /v2/manuscripts/{manuscriptId}/export/jobs — 查询导出任务列表**

查询参数：

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| status | string | 否 | 按状态过滤：queued / processing / completed / failed |
| format | string | 否 | 按格式过滤 |
| page | int | 否 | 页码，默认 0 |
| size | int | 否 | 每页条数，默认 20 |

响应（200 OK）：

```json
{
  "content": [
    {
      "id": "660e8400-e29b-41d4-a716-446655440099",
      "format": "docx",
      "status": "completed",
      "progress": 100,
      "fileName": "我的小说_第1-10章.docx",
      "fileSizeBytes": 245760,
      "chapterRange": "1-10",
      "expiresAt": "2026-02-18T10:30:00Z",
      "createdAt": "2026-02-17T10:30:00Z"
    },
    {
      "id": "660e8400-e29b-41d4-a716-446655440100",
      "format": "epub",
      "status": "processing",
      "progress": 45,
      "fileName": null,
      "fileSizeBytes": null,
      "chapterRange": "all",
      "expiresAt": null,
      "createdAt": "2026-02-17T11:00:00Z"
    }
  ],
  "totalElements": 2,
  "totalPages": 1,
  "number": 0,
  "size": 20
}
```

**GET /v2/manuscripts/{manuscriptId}/export/jobs/{jobId} — 查询单个任务状态**

响应（200 OK）：

```json
{
  "id": "660e8400-e29b-41d4-a716-446655440099",
  "manuscriptId": "770e8400-e29b-41d4-a716-446655440010",
  "storyId": "880e8400-e29b-41d4-a716-446655440020",
  "format": "docx",
  "templateId": "550e8400-e29b-41d4-a716-446655440001",
  "configJson": "{ ... }",
  "status": "completed",
  "progress": 100,
  "fileName": "我的小说_第1-10章.docx",
  "fileSizeBytes": 245760,
  "filePath": "/exports/660e8400.docx",
  "chapterRange": "1-10",
  "expiresAt": "2026-02-18T10:30:00Z",
  "createdAt": "2026-02-17T10:30:00Z",
  "errorMessage": null
}
```

失败时的响应示例：

```json
{
  "id": "660e8400-e29b-41d4-a716-446655440101",
  "format": "pdf",
  "status": "failed",
  "progress": 30,
  "errorMessage": "PDF 渲染失败：字体文件 SimSun.ttf 未找到",
  "createdAt": "2026-02-17T12:00:00Z"
}
```

**GET /v2/manuscripts/{manuscriptId}/export/jobs/{jobId}/download — 下载导出文件**

响应：
- 200 OK：`Content-Type` 对应格式的 MIME 类型，`Content-Disposition: attachment; filename="文件名"`
- 404 Not Found：任务不存在或文件已过期
- 409 Conflict：任务尚未完成

MIME 类型映射：

| 格式 | Content-Type |
|------|-------------|
| txt | text/plain; charset=UTF-8 |
| docx | application/vnd.openxmlformats-officedocument.wordprocessingml.document |
| epub | application/epub+zip |
| pdf | application/pdf |

#### 3.3.2 实时预览接口

**POST /v2/manuscripts/{manuscriptId}/export/preview — 生成导出预览**

根据当前导出配置，生成前 3 页的预览内容。该接口为同步接口，仅渲染少量页面，响应时间控制在 3 秒以内。

请求：

```json
{
  "format": "pdf",
  "templateId": "550e8400-e29b-41d4-a716-446655440001",
  "configOverrides": {
    "fontFamily": "KaiTi",
    "fontSize": 14
  },
  "chapterRange": "1-10",
  "previewPages": 3
}
```

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| format | string | 是 | 导出格式：txt / docx / epub / pdf |
| templateId | string | 否 | 使用的模板 ID |
| configOverrides | object | 否 | 覆盖模板中的部分配置项 |
| chapterRange | string | 否 | 章节范围；不传等同 "all" |
| previewPages | int | 否 | 预览页数，默认 3，最大 10 |

响应（200 OK）：

```json
{
  "format": "pdf",
  "totalPages": 156,
  "previewPages": 3,
  "content": {
    "type": "image",
    "pages": [
      {
        "page": 1,
        "dataUrl": "data:image/png;base64,iVBORw0KGgo..."
      },
      {
        "page": 2,
        "dataUrl": "data:image/png;base64,iVBORw0KGgo..."
      },
      {
        "page": 3,
        "dataUrl": "data:image/png;base64,iVBORw0KGgo..."
      }
    ]
  },
  "generatedAt": "2026-02-17T10:30:00Z"
}
```

不同格式的 `content.type` 和内容结构：

| 格式 | content.type | 内容说明 |
|------|-------------|----------|
| pdf | `"image"` | 每页渲染为 PNG 图片，以 Base64 data URL 返回 |
| epub | `"html"` | 前 3 章/节渲染为带样式的 HTML 片段 |
| docx | `"html"` | 前 3 页渲染为近似样式的 HTML 片段 |
| txt | `"text"` | 前 3 页的纯文本内容，保留缩进和分隔符格式 |

EPUB/DOCX 格式的 HTML 响应示例：

```json
{
  "format": "epub",
  "totalPages": 25,
  "previewPages": 3,
  "content": {
    "type": "html",
    "pages": [
      {
        "page": 1,
        "html": "<div class=\"preview-page\"><h1>第一章 ...</h1><p>...</p></div>",
        "css": "body { font-family: 'SimSun'; line-height: 1.5; ... }"
      }
    ]
  },
  "generatedAt": "2026-02-17T10:30:00Z"
}
```

TXT 格式的纯文本响应示例：

```json
{
  "format": "txt",
  "totalPages": 80,
  "previewPages": 3,
  "content": {
    "type": "text",
    "pages": [
      {
        "page": 1,
        "text": "书名：我的小说\n作者：张三\n\n========\n\n第一章 开端\n\n    正文内容..."
      }
    ]
  },
  "generatedAt": "2026-02-17T10:30:00Z"
}
```

错误响应：
- 400 Bad Request：配置参数无效
- 404 Not Found：稿件不存在
- 422 Unprocessable Entity：稿件内容为空，无法生成预览

#### 3.3.3 模板管理接口

**GET /v2/export-templates — 查询模板列表**

返回当前用户的自定义模板 + 所有系统预设模板（`user_id IS NULL`）。

查询参数：

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| format | string | 否 | 按格式过滤 |

响应（200 OK）：

```json
[
  {
    "id": "550e8400-e29b-41d4-a716-446655440001",
    "name": "网文标准格式",
    "description": "适用于起点/番茄等平台的标准排版",
    "format": "docx",
    "isSystem": true,
    "isDefault": true,
    "configJson": {
      "fontFamily": "SimSun",
      "fontSize": 14,
      "lineSpacing": 1.8,
      "pageBreakBetweenChapters": true,
      "includeToc": false,
      "includeTitlePage": false
    },
    "createdAt": "2026-01-01T00:00:00Z"
  },
  {
    "id": "550e8400-e29b-41d4-a716-446655440002",
    "name": "我的投稿模板",
    "description": "投稿出版社用的格式",
    "format": "docx",
    "isSystem": false,
    "isDefault": false,
    "configJson": {
      "fontFamily": "SimSun",
      "fontSize": 12,
      "lineSpacing": 2.0,
      "margins": { "top": 3.0, "bottom": 3.0, "left": 3.5, "right": 3.5 },
      "includeToc": true,
      "includeTitlePage": true
    },
    "createdAt": "2026-02-10T08:00:00Z"
  }
]
```

**POST /v2/export-templates — 创建模板**

请求：

```json
{
  "name": "Kindle 电子书",
  "description": "适配 Kindle 阅读器的 EPUB 格式",
  "format": "epub",
  "configJson": {
    "language": "zh-CN",
    "includeToc": true,
    "includeTitlePage": true,
    "chapterPageBreak": true,
    "fontEmbedding": { "enabled": false }
  },
  "isDefault": false
}
```

响应（201 Created）：返回完整的模板对象。

**PUT /v2/export-templates/{id} — 更新模板**

请求：与创建相同结构（部分字段可选）。仅允许更新自己创建的模板，不可修改系统模板。

响应（200 OK）：返回更新后的模板对象。

**DELETE /v2/export-templates/{id} — 删除模板**

仅允许删除自己创建的模板。

响应（204 No Content）。

### 3.4 前端设计

#### 3.4.1 组件结构

```
frontend/src/pages/Workbench/
├── tabs/
│   └── ManuscriptWriter.tsx          # 现有组件，新增导出按钮入口
└── export/
    ├── ExportDialog.tsx               # 导出主对话框（Modal，左右分栏布局）
    ├── FormatSelector.tsx             # 格式选择卡片（TXT/DOCX/EPUB/PDF）
    ├── TemplateSelector.tsx           # 模板选择下拉
    ├── ChapterRangeSelector.tsx       # 章节范围选择器
    ├── config/
    │   ├── TxtConfigForm.tsx          # TXT 配置表单
    │   ├── DocxConfigForm.tsx         # DOCX 配置表单
    │   ├── EpubConfigForm.tsx         # EPUB 配置表单
    │   └── PdfConfigForm.tsx          # PDF 配置表单
    ├── preview/
    │   ├── ExportPreviewPanel.tsx     # 实时预览面板（右侧）
    │   ├── PdfPreviewRenderer.tsx     # PDF 预览：渲染 Base64 图片
    │   ├── HtmlPreviewRenderer.tsx    # EPUB/DOCX 预览：渲染带样式 HTML
    │   ├── TxtPreviewRenderer.tsx     # TXT 预览：渲染纯文本
    │   └── PreviewControls.tsx        # 预览控制栏（翻页、缩放）
    ├── ExportJobList.tsx              # 导出历史列表（含下载链接）
    ├── ExportProgress.tsx             # 导出进度条
    └── hooks/
        ├── useExport.ts               # 导出操作 hook
        ├── useExportJobs.ts           # 任务列表轮询 hook
        ├── useExportTemplates.ts      # 模板 CRUD hook
        └── useExportPreview.ts        # 预览请求 hook（含 debounce）
```

#### 3.4.2 组件交互流程

```
ManuscriptWriter
    │
    │── 点击 "导出" 按钮
    ▼
ExportDialog (Modal，左右分栏)
    │
    ├─────────────────────────────────────────────────────────────────┐
    │  左侧：配置区                          右侧：实时预览区         │
    │                                                                │
    │  FormatSelector ──── 选择格式 ──────→ 触发预览刷新             │
    │       │                                     │                  │
    │       ▼                                     ▼                  │
    │  TemplateSelector ── 选择模板 ──────→ ExportPreviewPanel       │
    │       │                              │                         │
    │       ▼                              ├── PdfPreviewRenderer    │
    │  [Format]ConfigForm                  ├── HtmlPreviewRenderer   │
    │  （配置变更 debounce 500ms）──────→  ├── TxtPreviewRenderer    │
    │       │                              │                         │
    │       ▼                              ├── PreviewControls       │
    │  ChapterRangeSelector ──────────→   │   (翻页 / 缩放)         │
    │       │                              │                         │
    │       ▼                              │  POST /v2/.../preview   │
    │  [确认导出] 按钮                      │  → 渲染前 3 页预览      │
    │       │                              │                         │
    ├───────┼──────────────────────────────┘                         │
    │       │                                                        │
    │       │── POST /v2/manuscripts/{id}/export                     │
    │       ▼                                                        │
    │   ExportProgress ──────────── 显示进度条，轮询 job 状态        │
    │       │                                                        │
    │       │── 完成后显示下载链接                                    │
    │       ▼                                                        │
    │   ExportJobList ───────────── 导出历史记录                     │
    └────────────────────────────────────────────────────────────────┘
```

配置变更到预览刷新的数据流：

```
用户修改配置项
      │
      ▼
onChange 回调更新 configState
      │
      ▼
useEffect 监听 configState 变化
      │
      ▼
debounce 500ms（lodash.debounce）
      │
      ▼
调用 useExportPreview.fetchPreview()
      │
      ▼
POST /v2/manuscripts/{id}/export/preview
      │
      ▼
ExportPreviewPanel 渲染返回内容
```

#### 3.4.3 各配置表单字段

**FormatSelector 组件：**

四张卡片式选择，每张卡片包含：
- 格式图标（FileText / FileType / BookOpen / Printer）
- 格式名称
- 简短描述（如"纯文本，兼容所有平台"）
- 选中状态高亮

**TxtConfigForm：**
- 编码选择（UTF-8 / GBK / GB18030）
- 换行符（LF / CRLF）
- 章节分隔符（文本输入）
- 包含元数据（开关）
- 首行缩进（开关 + 空格数）

**DocxConfigForm：**
- 正文字体（下拉：宋体/楷体/仿宋/微软雅黑/Times New Roman）
- 正文字号（数字输入）
- 行距（下拉：1.0/1.15/1.5/2.0/自定义）
- 页边距（上/下/左/右 数字输入，单位 cm）
- 章节标题样式（字体/字号/加粗/对齐）
- 章节间分页（开关）
- 生成目录（开关）
- 生成标题页（开关）
- 页码显示（开关 + 位置选择）

**EpubConfigForm：**
- 封面图片（上传区域）
- 语言（下拉：zh-CN / zh-TW / en-US）
- 出版方（文本输入）
- ISBN（文本输入）
- 版权声明（文本输入）
- 自定义 CSS（代码编辑器，可选展开）
- 生成目录（开关）
- 生成标题页（开关）

**PdfConfigForm：**
- 纸张大小（下拉：A4 / A5 / B5 / Letter）
- 正文字体（下拉）
- 正文字号（数字输入）
- 行距（下拉）
- 页边距（上/下/左/右）
- 章节标题样式
- 页眉页脚（文本 + 页码位置）
- 生成目录（开关）
- 生成标题页（开关）
- 水印（开关 + 文本输入）

**ChapterRangeSelector：**
- 单选：全部章节 / 指定范围
- 范围模式下显示双滑块或起止输入框
- 显示选中章节的标题预览列表

#### 3.4.4 轮询策略

```typescript
// useExportJobs.ts 轮询逻辑
const POLL_INTERVAL_MS = 2000;  // 2 秒轮询一次
const MAX_POLL_COUNT = 300;     // 最多轮询 10 分钟

// 仅当存在 status=queued 或 status=processing 的 job 时启动轮询
// job 完成或失败后停止轮询，显示结果
// 使用 useEffect + setInterval，组件卸载时清理
```

#### 3.4.5 实时预览设计

导出对话框采用左右分栏布局，左侧为配置区，右侧为实时预览区。用户调整任何配置项后，预览区在 500ms 防抖延迟后自动刷新，呈现所选格式的前 3 页效果。

**ExportPreviewPanel 组件结构：**

```
ExportPreviewPanel
├── 加载状态层（Skeleton / Spinner）
├── 错误状态层（错误提示 + 重试按钮）
├── 预览内容区
│   ├── PdfPreviewRenderer      # format="pdf" 时激活
│   ├── HtmlPreviewRenderer     # format="epub" 或 "docx" 时激活
│   └── TxtPreviewRenderer      # format="txt" 时激活
└── PreviewControls
    ├── 翻页控制（上一页 / 下一页 / 页码指示器 "1 / 3"）
    └── 缩放控制（缩小 / 重置 / 放大 / 缩放百分比显示）
```

**各格式预览渲染策略：**

| 格式 | 渲染器 | 渲染方式 | 说明 |
|------|--------|----------|------|
| PDF | PdfPreviewRenderer | 将后端返回的 Base64 PNG 图片渲染到 `<img>` 标签 | 后端使用 OpenPDF 渲染页面后转为 PNG 图片，保证所见即所得 |
| EPUB | HtmlPreviewRenderer | 将后端返回的 HTML 片段注入 `<iframe sandbox>` 并应用返回的 CSS | 使用 iframe 隔离样式，防止预览 CSS 污染主页面 |
| DOCX | HtmlPreviewRenderer | 将后端返回的近似 HTML 渲染到 `<iframe sandbox>` | 后端将 DOCX 配置转换为近似的 CSS 样式（字体、字号、行距、页边距），生成 HTML 近似预览 |
| TXT | TxtPreviewRenderer | 将纯文本渲染到 `<pre>` 标签，应用等宽字体和缩进 | 直接展示文本内容，保留空格、缩进和分隔符格式 |

**后端预览 API 端点：**

```
POST /v2/manuscripts/{manuscriptId}/export/preview
```

- 同步接口，不创建 ExportJob 记录
- 仅组装并渲染前 N 页内容（默认 3 页，最大 10 页），控制响应时间
- PDF 预览：调用 PdfExporter 渲染指定页数后，使用 `PDFRenderer` 将每页转为 PNG 图片，以 Base64 编码返回
- EPUB/DOCX 预览：调用对应 Exporter 的轻量渲染方法，生成带样式的 HTML 片段返回
- TXT 预览：调用 TxtExporter 生成纯文本，按页面行数分页后返回
- 响应体结构详见 3.3.2 节

**防抖策略：**

```typescript
// useExportPreview.ts

import { useState, useEffect, useRef, useCallback } from 'react';
import { debounce } from 'lodash';

interface PreviewConfig {
  format: ExportFormat;
  templateId?: string;
  configOverrides?: Record<string, unknown>;
  chapterRange?: string;
}

interface PreviewPage {
  page: number;
  dataUrl?: string;   // PDF 格式
  html?: string;       // EPUB/DOCX 格式
  css?: string;        // EPUB/DOCX 格式
  text?: string;       // TXT 格式
}

interface PreviewResult {
  format: ExportFormat;
  totalPages: number;
  previewPages: number;
  contentType: 'image' | 'html' | 'text';
  pages: PreviewPage[];
  generatedAt: string;
}

interface UseExportPreviewReturn {
  preview: PreviewResult | null;
  isLoading: boolean;
  error: string | null;
  currentPage: number;
  zoomLevel: number;
  setCurrentPage: (page: number) => void;
  setZoomLevel: (zoom: number) => void;
  refresh: () => void;
}

const DEBOUNCE_MS = 500;
const DEFAULT_ZOOM = 100;
const ZOOM_STEP = 10;
const ZOOM_MIN = 50;
const ZOOM_MAX = 200;

export function useExportPreview(
  manuscriptId: string,
  config: PreviewConfig
): UseExportPreviewReturn {
  const [preview, setPreview] = useState<PreviewResult | null>(null);
  const [isLoading, setIsLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const [currentPage, setCurrentPage] = useState(1);
  const [zoomLevel, setZoomLevel] = useState(DEFAULT_ZOOM);

  // 中止控制器，用于取消进行中的请求
  const abortControllerRef = useRef<AbortController | null>(null);

  const fetchPreview = useCallback(async (cfg: PreviewConfig) => {
    // 取消上一次未完成的请求
    if (abortControllerRef.current) {
      abortControllerRef.current.abort();
    }
    const controller = new AbortController();
    abortControllerRef.current = controller;

    setIsLoading(true);
    setError(null);

    try {
      const response = await fetch(
        `/v2/manuscripts/${manuscriptId}/export/preview`,
        {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(cfg),
          signal: controller.signal,
        }
      );
      if (!response.ok) {
        throw new Error(`预览生成失败 (${response.status})`);
      }
      const data: PreviewResult = await response.json();
      setPreview(data);
      setCurrentPage(1); // 配置变更后重置到第 1 页
    } catch (err: unknown) {
      if (err instanceof DOMException && err.name === 'AbortError') {
        return; // 请求被取消，忽略
      }
      setError(err instanceof Error ? err.message : '预览生成失败');
    } finally {
      setIsLoading(false);
    }
  }, [manuscriptId]);

  // 防抖：配置变更后 500ms 触发预览请求
  const debouncedFetch = useRef(
    debounce((cfg: PreviewConfig) => fetchPreview(cfg), DEBOUNCE_MS)
  ).current;

  useEffect(() => {
    if (config.format) {
      debouncedFetch(config);
    }
    return () => debouncedFetch.cancel();
  }, [config.format, config.templateId, config.configOverrides, config.chapterRange]);

  // 组件卸载时清理
  useEffect(() => {
    return () => {
      abortControllerRef.current?.abort();
      debouncedFetch.cancel();
    };
  }, []);

  return {
    preview,
    isLoading,
    error,
    currentPage,
    zoomLevel,
    setCurrentPage,
    setZoomLevel,
    refresh: () => fetchPreview(config),
  };
}
```

**TypeScript 接口定义：**

```typescript
// types/export-preview.ts

/** 导出格式 */
type ExportFormat = 'txt' | 'docx' | 'epub' | 'pdf';

/** 预览内容类型 */
type PreviewContentType = 'image' | 'html' | 'text';

/** 预览请求参数 */
interface ExportPreviewRequest {
  format: ExportFormat;
  templateId?: string;
  configOverrides?: Record<string, unknown>;
  chapterRange?: string;
  previewPages?: number;  // 默认 3，最大 10
}

/** 预览页面 — PDF 格式 */
interface PdfPreviewPage {
  page: number;
  dataUrl: string;  // data:image/png;base64,...
}

/** 预览页面 — HTML 格式（EPUB/DOCX） */
interface HtmlPreviewPage {
  page: number;
  html: string;
  css: string;
}

/** 预览页面 — 纯文本格式 */
interface TextPreviewPage {
  page: number;
  text: string;
}

/** 预览响应 */
interface ExportPreviewResponse {
  format: ExportFormat;
  totalPages: number;
  previewPages: number;
  content: {
    type: PreviewContentType;
    pages: PdfPreviewPage[] | HtmlPreviewPage[] | TextPreviewPage[];
  };
  generatedAt: string;
}

/** 预览控制状态 */
interface PreviewControlState {
  currentPage: number;
  zoomLevel: number;       // 百分比，默认 100
  zoomMin: number;         // 最小 50
  zoomMax: number;         // 最大 200
  zoomStep: number;        // 步进 10
}
```

**PreviewControls 组件行为：**

- 翻页控制：
  - "上一页" 按钮：`currentPage > 1` 时可用，点击后 `currentPage -= 1`
  - "下一页" 按钮：`currentPage < previewPages` 时可用，点击后 `currentPage += 1`
  - 页码指示器：显示 `"第 {currentPage} / {previewPages} 页（共 {totalPages} 页）"`
  - 键盘快捷键：左箭头 = 上一页，右箭头 = 下一页

- 缩放控制：
  - "缩小" 按钮：`zoomLevel > 50` 时可用，每次 -10%
  - "放大" 按钮：`zoomLevel < 200` 时可用，每次 +10%
  - "重置" 按钮：恢复到 100%
  - 缩放百分比显示：如 "100%"
  - 缩放通过 CSS `transform: scale()` 应用到预览内容区

### 3.5 Prompt 工程

导出模块本身是纯数据转换管道，AI 介入点较少，但在以下两个场景中使用 AI 生成辅助内容：

#### 3.5.1 EPUB 元数据 — AI 生成书籍简介

当用户导出 EPUB 格式且 `Story.synopsis` 为空或过短时，可选调用 AI 生成出版级书籍简介。

```
系统提示词：
你是一位专业的图书编辑，擅长撰写吸引读者的书籍简介。

任务：根据以下小说信息，生成一段 150-200 字的书籍简介，适用于电子书商店展示。

小说标题：{story.title}
类型：{story.genre}
基调：{story.tone}
现有简介：{story.synopsis}
章节概要：
{chapters[0..3].title + summary}

要求：
1. 简介应引起读者兴趣，但不剧透核心情节
2. 突出作品的独特卖点和情感基调
3. 使用与作品基调一致的语言风格
4. 以悬念或情感钩子结尾
```

#### 3.5.2 目录描述 — AI 生成章节摘要

当导出格式支持目录描述（EPUB 的 TOC 描述、PDF 目录的副标题）且章节缺少摘要时，可选批量生成。

```
系统提示词：
你是一位小说编辑助手。

任务：为以下章节生成一句话摘要（15-30 字），用于目录展示。

章节标题：{chapter.title}
章节正文前 500 字：{chapter.scenes[0].content.substring(0, 500)}

要求：
1. 摘要应概括本章核心事件或情感转折
2. 不剧透后续章节内容
3. 语言简洁，有吸引力
4. 输出格式：仅返回摘要文本，不加引号或前缀
```

注意：AI 生成的内容均为可选功能，用户可在导出配置中关闭。生成结果会缓存到 `AssembledManuscript` 中，避免重复调用。

---

## 4. 与现有代码的集成点

### 4.1 后端集成

| 集成目标 | 文件路径 | 集成方式 |
|----------|----------|----------|
| Manuscript 实体 | `backend/src/main/java/com/ainovel/app/manuscript/model/Manuscript.java` | ManuscriptAssembler 读取 `sectionsJson`，解析 `sceneId -> content` 映射 |
| Outline 实体 | `backend/src/main/java/com/ainovel/app/story/model/Outline.java` | ManuscriptAssembler 读取 `contentJson`，解析章节/场景结构树获取排序和标题 |
| Story 实体 | `backend/src/main/java/com/ainovel/app/story/model/Story.java` | ManuscriptAssembler 读取 `title`、`synopsis`、`genre`、`tone` 作为导出元数据 |
| User 实体 | `backend/src/main/java/com/ainovel/app/user/User.java` | 读取 `username` 作为作者名；权限校验确保用户只能导出自己的稿件 |
| ManuscriptRepository | `backend/src/main/java/com/ainovel/app/manuscript/repo/ManuscriptRepository.java` | ExportService 通过 repository 加载 Manuscript 实体 |
| MaterialUploadJob 模式 | `backend/src/main/java/com/ainovel/app/material/model/MaterialUploadJob.java` | ExportJob 实体参考其异步任务模式（status/progress/message 字段设计） |
| SecurityConfig | `backend/src/main/java/com/ainovel/app/security/SecurityConfig.java` | 新增 `/v2/manuscripts/*/export/**` 和 `/v2/export-templates/**` 路径的认证规则 |
| AiService | `backend/src/main/java/com/ainovel/app/ai/AiService.java` | 可选：调用 AI 生成 EPUB 简介和章节摘要 |

### 4.2 前端集成

| 集成目标 | 文件路径 | 集成方式 |
|----------|----------|----------|
| 工作台页面 | `frontend/src/pages/Workbench/Workbench.tsx` | 在 ManuscriptWriter 标签页内添加导出按钮入口 |
| 稿件编辑器 | `frontend/src/pages/Workbench/tabs/ManuscriptWriter.tsx` | 在工具栏区域添加"导出"按钮，点击打开 ExportDialog |

### 4.3 数据流关系

```
┌─────────────┐     ┌──────────────┐     ┌──────────────┐
│   Story     │     │   Outline    │     │  Manuscript  │
│  .title     │     │ .contentJson │     │ .sectionsJson│
│  .synopsis  │     │  (结构树)     │     │  (正文映射)   │
│  .genre     │     │              │     │              │
│  .tone      │     │              │     │              │
└──────┬──────┘     └──────┬───────┘     └──────┬───────┘
       │                   │                     │
       └───────────────────┼─────────────────────┘
                           │
                           ▼
                 ┌─────────────────────┐
                 │ ManuscriptAssembler │
                 │                     │
                 │ 1. 解析 contentJson  │
                 │    → 章节/场景顺序   │
                 │ 2. 解析 sectionsJson │
                 │    → sceneId→正文    │
                 │ 3. 按顺序组装       │
                 │ 4. 填充元数据       │
                 └──────────┬──────────┘
                            │
                            ▼
                 ┌─────────────────────┐
                 │ AssembledManuscript │
                 │  (有序章节+场景+    │
                 │   元数据)           │
                 └──────────┬──────────┘
                            │
              ┌─────────────┼─────────────┐─────────────┐
              ▼             ▼             ▼             ▼
        ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐
        │ TxtExp.  │ │ DocxExp. │ │ EpubExp. │ │ PdfExp.  │
        │          │ │ (POI)    │ │ (epublib)│ │ (OpenPDF)│
        └────┬─────┘ └────┬─────┘ └────┬─────┘ └────┬─────┘
             │             │             │             │
             ▼             ▼             ▼             ▼
          .txt          .docx         .epub          .pdf
```

---

## 5. 实施注意事项

### 5.1 文件存储策略

- 导出文件存储在服务器本地临时目录：`${app.export.storage-path:/tmp/ainovel-exports/}`
- 文件命名规则：`{jobId}.{format}`，避免文件名冲突
- 下载时使用 `Content-Disposition` 返回用户友好的文件名：`{故事标题}_{章节范围}.{format}`
- 生产环境可配置为对象存储（如 S3/OSS），通过 `StorageStrategy` 接口抽象

### 5.2 自动清理策略

- 默认过期时间：24 小时（`app.export.file-ttl=24h`）
- 定时任务每小时扫描一次 `expires_at < NOW()` 的记录
- 清理流程：删除物理文件 → 清空 `file_path` 和 `file_size_bytes` → 保留 job 记录用于审计
- 磁盘空间告警：当导出目录占用超过配置阈值（默认 1GB）时，强制清理最早的已完成文件

### 5.3 大稿件处理

- 稿件字数阈值：超过 20 万字的稿件标记为"大稿件"
- 大稿件导出时增加线程池优先级控制，避免多个大任务同时执行
- PDF 渲染是最耗资源的操作，单个 PDF 导出任务内存峰值可达 200-500MB
- 建议：PDF 导出采用流式写入（`PdfWriter` 直接写入 `FileOutputStream`），避免全量 `byte[]` 驻留内存
- 超时保护：单个导出任务最长执行 5 分钟，超时自动标记为 failed

### 5.4 字体处理

#### PDF 字体嵌入

- 系统内置以下中文字体文件（放置在 `backend/src/main/resources/fonts/`）：
  - `NotoSansSC-Regular.ttf` — 思源黑体（正文备选）
  - `NotoSerifSC-Regular.ttf` — 思源宋体（正文默认）
- 用户配置的 `fontFamily` 映射到实际字体文件：
  - SimSun → NotoSerifSC-Regular.ttf
  - SimHei → NotoSansSC-Regular.ttf
  - KaiTi → 需额外提供或降级到 NotoSerifSC
- OpenPDF 注册字体：`FontFactory.register(fontPath, alias)`

#### EPUB 字体嵌入

- 默认不嵌入字体（依赖阅读器内置字体），减小文件体积
- 如 `fontEmbedding.enabled=true`，将字体文件打包进 EPUB 的 `fonts/` 目录
- 在 CSS 中声明 `@font-face` 引用嵌入字体
- 注意字体许可证：仅嵌入开源许可的字体（Noto 系列为 OFL 许可）

### 5.5 CJK 排版特殊处理

- 中文段落首行缩进 2 个全角字符宽度（约 2em）
- 标点挤压：避免行首出现句号、逗号等标点（PDF 渲染时处理）
- 竖排支持：v2.0 暂不支持，预留配置项 `writingMode: "horizontal"` 供后续扩展
- 中英文混排时的字体回退：英文使用 Times New Roman，中文使用配置字体

### 5.6 并发与限流

- 每个用户同时最多 3 个进行中的导出任务（queued + processing）
- 超出限制返回 429 Too Many Requests
- 全局线程池最大 4 个并发导出线程（见 3.2.4 异步执行器配置）

### 5.7 版本控制集成（04-版本控制模块）

- 导出时可选择导出特定版本的稿件（而非仅最新版本）
- ExportRequest 预留 `versionId` 字段，v2.0 首版暂不实现，待版本控制模块就绪后对接
- 导出记录（export_jobs）可作为版本的"发布快照"，关联到版本历史

---

## 6. 验收标准

### 6.1 功能验收

| 编号 | 验收项 | 验收条件 | 优先级 |
|------|--------|----------|--------|
| AC-01 | TXT 导出 | 导出的 TXT 文件包含完整正文，章节顺序正确，编码正确（UTF-8/GBK），可用记事本正常打开 | P0 |
| AC-02 | DOCX 导出 | 导出的 DOCX 文件可用 Microsoft Word / WPS 正常打开，字体/字号/行距/页边距与配置一致，章节标题使用 Heading 样式 | P0 |
| AC-03 | EPUB 导出 | 导出的 EPUB 文件通过 epubcheck 校验，可在 Calibre / Apple Books / Kindle Previewer 中正常阅读，目录导航正确 | P0 |
| AC-04 | PDF 导出 | 导出的 PDF 文件中文显示正确（无乱码/豆腐块），页码/页眉页脚正确，章节分页正确 | P0 |
| AC-05 | 标题页生成 | DOCX/EPUB/PDF 格式在 includeTitlePage=true 时生成包含书名和作者名的标题页 | P1 |
| AC-06 | 目录生成 | DOCX 生成可更新的 TOC 域；EPUB 生成 NCX + nav.xhtml；PDF 生成带页码的目录页 | P1 |
| AC-07 | 章节范围导出 | 指定 chapterRange="3-7" 时，仅导出第 3 至第 7 章内容 | P1 |
| AC-08 | 模板系统 | 用户可创建/编辑/删除自定义模板；系统预设模板不可修改/删除；导出时可选择模板并覆盖部分配置 | P1 |
| AC-09 | 异步导出 | 发起导出后立即返回 jobId；前端可通过轮询获取进度；大稿件（10万字+）导出不阻塞 UI | P0 |
| AC-10 | 文件下载 | 导出完成后可通过 download 接口下载文件；文件名包含故事标题和格式后缀 | P0 |
| AC-11 | 自动清理 | 过期文件（默认 24h）被定时任务自动删除；job 记录保留但文件路径清空 | P1 |
| AC-12 | 并发限制 | 单用户同时超过 3 个导出任务时返回 429；全局线程池不超过 4 个并发 | P1 |

### 6.2 非功能验收

| 编号 | 验收项 | 验收条件 |
|------|--------|----------|
| NF-01 | 性能 | 5 万字稿件 TXT 导出 < 2 秒；DOCX 导出 < 5 秒；EPUB 导出 < 10 秒；PDF 导出 < 30 秒 |
| NF-02 | 内存 | 单个导出任务内存增量不超过 500MB（PDF 最大） |
| NF-03 | 磁盘 | 导出目录占用不超过配置阈值（默认 1GB），清理机制有效 |
| NF-04 | 错误恢复 | 导出失败时 job 状态正确更新为 failed，errorMessage 包含可读的错误描述 |
| NF-05 | 安全 | 用户只能访问自己的导出任务和文件；下载接口校验 userId 归属 |
| NF-06 | CJK 兼容 | 所有格式正确渲染中文字符，无乱码、无豆腐块、无截断 |

### 6.3 系统预设模板清单

首版需提供以下系统模板：

| 模板名称 | 格式 | 说明 |
|----------|------|------|
| 纯文本（UTF-8） | TXT | UTF-8 编码，LF 换行，含章节标题 |
| 纯文本（GBK） | TXT | GBK 编码，CRLF 换行，兼容旧系统 |
| 网文标准格式 | DOCX | 宋体 14pt，1.8 倍行距，无目录无标题页 |
| 出版投稿格式 | DOCX | 宋体 12pt，2.0 倍行距，含目录和标题页，标准页边距 |
| 标准电子书 | EPUB | 含目录和标题页，默认 CSS，不嵌入字体 |
| A4 打印版 | PDF | A4 纸张，宋体 12pt，1.5 倍行距，含页码和目录 |
| A5 口袋书 | PDF | A5 纸张，宋体 10pt，1.3 倍行距，紧凑排版 |
