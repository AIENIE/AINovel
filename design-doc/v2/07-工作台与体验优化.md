# 工作台与体验优化

## 文档信息

| 字段 | 值 |
|------|-----|
| 版本 | v2.0 |
| 日期 | 2026-02-17 |
| 优先级 | P4 |
| 关联模块 | 01-上下文记忆, 04-版本控制, 05-稿件导出 |

---

## 1. 背景与动机

### 1.1 问题陈述

当前 v1 版本的工作台（`frontend/src/pages/Workbench/Workbench.tsx`）采用纯 Tab 切换布局，存在以下核心体验缺陷：

1. **单面板可见**：工作台使用 shadcn/ui 的 `<Tabs>` 组件将故事构思、故事管理、大纲编排、小说创作、素材检索五个功能区分隔为互斥的 Tab 页。作者在写作时无法同时查看大纲结构和素材资料，必须频繁切换 Tab，严重打断创作心流。

2. **无快捷键体系**：除浏览器原生快捷键外，系统未提供任何自定义快捷键。保存、切换章节、唤起 AI 助手等高频操作均需鼠标点击，不符合专业写作工具的操作效率预期。

3. **无批量操作**：稿件管理（`ManuscriptWriter.tsx`）仅支持逐个场景编辑，无法对多个章节/场景执行批量导出、批量删除、批量移动等操作。对于拥有数十章节的长篇小说，管理效率极低。

4. **布局不可定制**：所有用户共享同一固定布局。左侧导航栏宽度固定为 `w-64`（`AppLayout.tsx`），编辑器区域无法自由调整比例。不同写作阶段（构思 vs 精修 vs 校对）对面板配置的需求完全不同，但系统无法适应。

5. **无专注模式**：虽然 `TiptapEditor` 已预留 `zenMode` 属性，但工作台层面未实现完整的专注模式——无法隐藏侧边栏、状态栏和工具栏，让作者沉浸于纯文本写作。

6. **无写作统计**：系统不追踪写作会话数据（本次写了多少字、写了多长时间、编辑了哪些章节），也不支持写作目标设定（日更字数、截稿日期），缺乏对创作习惯的量化反馈。

7. **无命令面板**：缺少类似 VS Code `Ctrl+Shift+P` 或 Notion `Ctrl+K` 的全局命令面板，用户无法通过键盘快速定位章节、角色、执行操作。

8. **状态信息分散**：自动保存状态仅在编辑器顶部以文本形式显示（`ManuscriptWriter.tsx` 第 204 行），无统一的状态栏展示字数统计、当前位置、保存状态、写作目标进度等关键信息。

### 1.2 业界参考

| 产品 | 核心机制 | 借鉴点 |
|------|----------|--------|
| **Scrivener** | 三栏布局（Binder + Editor + Inspector），支持分屏编辑、全屏写作模式、写作目标追踪、快照（Snapshot）功能 | 三栏面板架构、写作目标系统、专注模式设计 |
| **VS Code** | 可拖拽面板布局、命令面板（Ctrl+Shift+P）、完整快捷键体系（可自定义）、多标签编辑器、状态栏 | 命令面板交互、快捷键自定义机制、状态栏信息架构 |
| **Notion** | Cmd+K 快速搜索与命令、侧边栏导航、块级编辑、简洁的专注体验 | 命令面板的模糊搜索、简洁 UI 风格 |
| **iA Writer** | 极简专注模式、语法高亮（句子/段落聚焦）、实时字数统计、写作目标 | 专注模式的视觉设计、字数目标交互 |
| **Ulysses** | 三栏布局（Library + Sheet List + Editor）、写作目标（字数/字符/句子）、iCloud 同步、Markdown 原生支持 | 写作目标的多维度设定、库-列表-编辑器的导航层级 |

---

## 2. 设计目标

1. **IDE 风格多面板布局**：将工作台从 Tab 切换重构为可调整的多面板布局，支持大纲树 + 编辑器 + 参考面板同时可见，使用已有的 `react-resizable-panels` 实现面板拖拽调整。

2. **可定制面板配置**：用户可自由显示/隐藏左右面板、调整面板宽度比例、保存多套布局预设（如"写作模式"、"校对模式"、"构思模式"），布局配置持久化到后端。

3. **完整快捷键体系**：为所有高频操作提供默认快捷键绑定，支持用户自定义快捷键映射，快捷键配置持久化到后端。

4. **专注/禅模式**：一键进入全屏无干扰写作模式，隐藏侧边栏、工具栏、状态栏，仅保留编辑器和最小化的退出控件。支持打字机滚动（当前行始终居中）。

5. **批量操作**：支持多选章节/场景，执行批量导出、批量删除、批量移动（拖拽排序）、批量状态变更等操作。

6. **全局命令面板**：实现 `Ctrl+K` 唤起的命令面板，支持模糊搜索章节、角色、场景、Lorebook 条目，以及执行系统操作（保存、导出、切换模式等）。

7. **写作目标与进度追踪**：支持设定日更字数目标、单次会话字数目标、章节截稿日期、全书总字数目标，实时显示进度。

8. **写作会话统计**：自动追踪每次写作会话的时长、新增字数、删除字数、净增字数、编辑章节列表，提供日/周/月维度的统计视图。

9. **统一状态栏**：在工作台底部添加持久状态栏，集中展示：当前字数、选中字数、光标位置、保存状态、会话时长、目标进度、主题切换。

10. **主题与外观**：支持亮色/暗色主题切换，支持自定义强调色，与现有 `AppearanceSettings`（parchment/hacker 主题）整合。配色方案已统一为"暖白 + 鼠尾草绿"设计系统：
    - Primary: `#5B7F67`（鼠尾草绿）
    - Accent: `#8B6F4E`（木质棕）
    - Background: `#FAFAF8`（暖白）
    - → 见 10-前端设计系统.md § 2

---

## 3. 详细设计

### 3.1 数据模型

#### 3.1.1 表 1：`workspace_layouts` — 工作台布局配置表

存储用户自定义的面板布局预设，支持多套布局方案切换。

```sql
CREATE TABLE workspace_layouts (
    id              CHAR(36)        NOT NULL    COMMENT '主键 UUID',
    user_id         CHAR(36)        NOT NULL    COMMENT '所属用户 FK -> users.id',
    name            VARCHAR(100)    NOT NULL    COMMENT '布局名称，如"写作模式"、"校对模式"',
    layout_json     TEXT            NOT NULL    COMMENT '面板布局配置 JSON，含面板可见性、尺寸比例、标签页配置',
    is_active       TINYINT(1)      NOT NULL DEFAULT 0
                                                COMMENT '是否为当前激活布局（每用户仅一个）',
    created_at      TIMESTAMP       NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at      TIMESTAMP       NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,

    PRIMARY KEY (id),
    INDEX idx_layout_user (user_id),
    INDEX idx_layout_active (user_id, is_active),
    CONSTRAINT fk_layout_user FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci
  COMMENT='工作台布局配置表';
```
`layout_json` 结构示例：

```json
{
  "leftPanel": {
    "visible": true,
    "width": 20,
    "minWidth": 15,
    "maxWidth": 35,
    "activeTab": "outline"
  },
  "centerPanel": {
    "width": 55
  },
  "rightPanel": {
    "visible": true,
    "width": 25,
    "minWidth": 15,
    "maxWidth": 40,
    "activeTab": "copilot"
  },
  "statusBar": {
    "visible": true
  },
  "toolbar": {
    "visible": true
  }
}
```

#### 3.1.2 表 2：`writing_sessions` — 写作会话表

追踪每次写作会话的详细数据，用于统计分析和习惯洞察。

```sql
CREATE TABLE writing_sessions (
    id                  CHAR(36)        NOT NULL    COMMENT '主键 UUID',
    user_id             CHAR(36)        NOT NULL    COMMENT '所属用户 FK -> users.id',
    story_id            CHAR(36)        NOT NULL    COMMENT '关联故事 FK -> stories.id',
    started_at          TIMESTAMP       NOT NULL DEFAULT CURRENT_TIMESTAMP
                                                    COMMENT '会话开始时间',
    ended_at            TIMESTAMP       NULL        COMMENT '会话结束时间（NULL 表示进行中）',
    words_written       INT             NOT NULL DEFAULT 0
                                                    COMMENT '本次会话新增字数',
    words_deleted       INT             NOT NULL DEFAULT 0
                                                    COMMENT '本次会话删除字数',
    net_words           INT             NOT NULL DEFAULT 0
                                                    COMMENT '净增字数 = words_written - words_deleted',
    duration_seconds    INT             NOT NULL DEFAULT 0
                                                    COMMENT '有效写作时长（秒），排除空闲时间',
    chapters_edited_json TEXT           NULL        COMMENT '本次编辑的章节/场景 ID 列表 JSON',

    PRIMARY KEY (id),
    INDEX idx_session_user (user_id),
    INDEX idx_session_story (user_id, story_id),
    INDEX idx_session_time (user_id, started_at),
    CONSTRAINT fk_session_user  FOREIGN KEY (user_id)  REFERENCES users(id)   ON DELETE CASCADE,
    CONSTRAINT fk_session_story FOREIGN KEY (story_id)  REFERENCES stories(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci
  COMMENT='写作会话追踪表';
```
`chapters_edited_json` 结构示例：

```json
[
  { "chapterId": "uuid-ch-001", "sceneId": "uuid-sc-001", "wordsAdded": 320, "wordsRemoved": 45 },
  { "chapterId": "uuid-ch-001", "sceneId": "uuid-sc-002", "wordsAdded": 150, "wordsRemoved": 10 }
]
```

#### 3.1.3 表 3：`writing_goals` — 写作目标表

存储用户设定的写作目标，支持多种目标类型和进度追踪。

```sql
CREATE TABLE writing_goals (
    id              CHAR(36)        NOT NULL    COMMENT '主键 UUID',
    user_id         CHAR(36)        NOT NULL    COMMENT '所属用户 FK -> users.id',
    story_id        CHAR(36)        NULL        COMMENT '关联故事 FK -> stories.id（NULL 表示全局目标）',
    goal_type       ENUM('daily_words','session_words','chapter_deadline','total_words')
                                    NOT NULL    COMMENT '目标类型',
    target_value    INT             NOT NULL    COMMENT '目标值（字数或天数）',
    current_value   INT             NOT NULL DEFAULT 0
                                                COMMENT '当前进度值',
    deadline        DATE            NULL        COMMENT '截止日期（仅 chapter_deadline 类型使用）',
    status          ENUM('active','completed','expired')
                                    NOT NULL DEFAULT 'active'
                                                COMMENT '目标状态',
    created_at      TIMESTAMP       NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at      TIMESTAMP       NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,

    PRIMARY KEY (id),
    INDEX idx_goal_user (user_id),
    INDEX idx_goal_story (user_id, story_id),
    INDEX idx_goal_status (user_id, status),
    CONSTRAINT fk_goal_user  FOREIGN KEY (user_id)  REFERENCES users(id)   ON DELETE CASCADE,
    CONSTRAINT fk_goal_story FOREIGN KEY (story_id)  REFERENCES stories(id) ON DELETE SET NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci
  COMMENT='写作目标表';
```

目标类型说明：

| goal_type | 含义 | target_value 语义 | 重置周期 |
|-----------|------|-------------------|----------|
| `daily_words` | 每日写作字数目标 | 目标字数（如 3000） | 每日 00:00 重置 current_value |
| `session_words` | 单次会话字数目标 | 目标字数（如 1000） | 每次新会话重置 |
| `chapter_deadline` | 章节截稿日期 | 剩余天数（动态计算） | 不重置，到期后标记 expired |
| `total_words` | 全书总字数目标 | 目标总字数（如 200000） | 不重置，累计计算 |

#### 3.1.4 表 4：`keyboard_shortcuts` — 快捷键配置表

存储用户自定义的快捷键映射，覆盖系统默认值。

```sql
CREATE TABLE keyboard_shortcuts (
    id              CHAR(36)        NOT NULL    COMMENT '主键 UUID',
    user_id         CHAR(36)        NOT NULL    COMMENT '所属用户 FK -> users.id',
    action          VARCHAR(100)    NOT NULL    COMMENT '操作标识，如 command_palette / save / focus_mode',
    shortcut        VARCHAR(50)     NOT NULL    COMMENT '快捷键组合，如 Ctrl+K / Ctrl+Shift+F',
    is_custom       TINYINT(1)      NOT NULL DEFAULT 0
                                                COMMENT '是否为用户自定义（0=系统默认，1=用户覆盖）',
    created_at      TIMESTAMP       NOT NULL DEFAULT CURRENT_TIMESTAMP,

    PRIMARY KEY (id),
    INDEX idx_shortcut_user (user_id),
    UNIQUE INDEX uk_shortcut_user_action (user_id, action),
    CONSTRAINT fk_shortcut_user FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci
  COMMENT='快捷键配置表';
```

---

### 3.2 后端设计

#### 3.2.1 包结构

```
backend/src/main/java/com/ainovel/app/workspace/
├── WorkspaceController.java          // REST 控制器
├── WorkspaceLayoutService.java       // 布局管理服务
├── WritingSessionService.java        // 写作会话追踪服务
├── WritingGoalService.java           // 写作目标管理服务
├── WritingStatsService.java          // 统计计算服务
├── dto/
│   ├── WorkspaceLayoutDto.java
│   ├── WorkspaceLayoutCreateRequest.java
│   ├── WorkspaceLayoutUpdateRequest.java
│   ├── WritingSessionDto.java
│   ├── SessionStartRequest.java
│   ├── SessionHeartbeatRequest.java
│   ├── WritingGoalDto.java
│   ├── WritingGoalCreateRequest.java
│   ├── WritingGoalUpdateRequest.java
│   ├── DailyStatDto.java
│   ├── GoalProgressDto.java
│   └── KeyboardShortcutDto.java
├── model/
│   ├── WorkspaceLayout.java          // JPA 实体
│   ├── WritingSession.java
│   ├── WritingGoal.java
│   └── KeyboardShortcut.java
└── repo/
    ├── WorkspaceLayoutRepository.java
    ├── WritingSessionRepository.java
    ├── WritingGoalRepository.java
    └── KeyboardShortcutRepository.java
```

#### 3.2.2 核心服务方法

##### WorkspaceLayoutService

```java
@Service
public class WorkspaceLayoutService {

    /** 获取用户所有布局预设 */
    public List<WorkspaceLayoutDto> listLayouts(UUID userId);

    /** 创建新布局预设 */
    public WorkspaceLayoutDto createLayout(UUID userId, WorkspaceLayoutCreateRequest req);

    /** 更新布局配置（面板尺寸、可见性等） */
    public WorkspaceLayoutDto updateLayout(UUID userId, UUID layoutId, WorkspaceLayoutUpdateRequest req);

    /** 删除布局预设 */
    public void deleteLayout(UUID userId, UUID layoutId);

    /**
     * 激活指定布局：将该布局的 is_active 设为 true，
     * 同时将该用户其他布局的 is_active 设为 false。
     */
    public WorkspaceLayoutDto activateLayout(UUID userId, UUID layoutId);
}
```

##### WritingSessionService

```java
@Service
public class WritingSessionService {

    /**
     * 开始新的写作会话。
     * 如果用户已有未结束的会话（ended_at IS NULL），先自动结束旧会话。
     */
    public WritingSessionDto startSession(UUID userId, UUID storyId);

    /**
     * 心跳更新：前端每 30 秒调用一次，上报增量写作数据。
     * - wordsAdded: 自上次心跳以来新增的字数
     * - wordsRemoved: 自上次心跳以来删除的字数
     * - activeChapterId / activeSceneId: 当前正在编辑的章节/场景
     * 服务端累加 words_written、words_deleted，重算 net_words 和 duration_seconds。
     */
    public WritingSessionDto recordActivity(UUID sessionId, SessionHeartbeatRequest req);

    /**
     * 结束写作会话，设置 ended_at 为当前时间。
     * 同时触发写作目标进度更新（调用 WritingGoalService.updateProgress）。
     */
    public WritingSessionDto endSession(UUID sessionId);

    /** 获取用户当前进行中的会话（如有） */
    public Optional<WritingSessionDto> getActiveSession(UUID userId);
}
```

##### WritingStatsService

```java
@Service
public class WritingStatsService {

    /**
     * 获取日维度统计：指定日期范围内每天的写作数据。
     * 返回每天的总字数、净增字数、写作时长、会话次数。
     */
    public List<DailyStatDto> getDailyStats(UUID userId, LocalDate from, LocalDate to);

    /**
     * 获取故事维度统计：指定故事的累计写作数据。
     */
    public StoryStatDto getStoryStats(UUID userId, UUID storyId);

    /**
     * 获取写作热力图数据：过去 N 天每天的写作字数，用于日历热力图展示。
     */
    public Map<LocalDate, Integer> getHeatmapData(UUID userId, int days);
}
```

##### WritingGoalService

```java
@Service
public class WritingGoalService {

    /** 获取用户所有活跃目标及其进度 */
    public List<GoalProgressDto> checkGoalProgress(UUID userId);

    /** 创建新写作目标 */
    public WritingGoalDto createGoal(UUID userId, WritingGoalCreateRequest req);

    /** 更新目标参数 */
    public WritingGoalDto updateGoal(UUID userId, UUID goalId, WritingGoalUpdateRequest req);

    /** 删除目标 */
    public void deleteGoal(UUID userId, UUID goalId);

    /**
     * 内部方法：写作会话结束时调用，更新相关目标的 current_value。
     * - daily_words: 累加当日净增字数
     * - session_words: 设置为本次会话净增字数
     * - total_words: 累加净增字数
     * - chapter_deadline: 检查是否已过期
     */
    void updateProgress(UUID userId, UUID storyId, int netWords);

    /**
     * 定时任务（@Scheduled, 每日 00:05 执行）：
     * - 重置所有 daily_words 目标的 current_value 为 0
     * - 将过期的 chapter_deadline 目标标记为 expired
     */
    @Scheduled(cron = "0 5 0 * * *")
    void resetDailyGoals();
}
```

---

### 3.3 API 设计

#### 3.3.1 工作台布局 API

##### GET /api/v2/users/me/workspace-layouts

获取当前用户的所有布局预设。

响应示例：

```json
{
  "code": 200,
  "data": [
    {
      "id": "uuid-layout-001",
      "name": "写作模式",
      "layoutJson": {
        "leftPanel": { "visible": true, "width": 20, "activeTab": "outline" },
        "centerPanel": { "width": 55 },
        "rightPanel": { "visible": true, "width": 25, "activeTab": "copilot" },
        "statusBar": { "visible": true },
        "toolbar": { "visible": true }
      },
      "isActive": true,
      "createdAt": "2026-02-17T10:00:00Z",
      "updatedAt": "2026-02-17T10:00:00Z"
    },
    {
      "id": "uuid-layout-002",
      "name": "专注模式",
      "layoutJson": {
        "leftPanel": { "visible": false, "width": 20, "activeTab": "outline" },
        "centerPanel": { "width": 100 },
        "rightPanel": { "visible": false, "width": 25, "activeTab": "copilot" },
        "statusBar": { "visible": false },
        "toolbar": { "visible": false }
      },
      "isActive": false,
      "createdAt": "2026-02-17T10:05:00Z",
      "updatedAt": "2026-02-17T10:05:00Z"
    }
  ]
}
```

##### POST /api/v2/users/me/workspace-layouts

创建新布局预设。

请求示例：

```json
{
  "name": "校对模式",
  "layoutJson": {
    "leftPanel": { "visible": true, "width": 15, "activeTab": "outline" },
    "centerPanel": { "width": 50 },
    "rightPanel": { "visible": true, "width": 35, "activeTab": "versionHistory" },
    "statusBar": { "visible": true },
    "toolbar": { "visible": true }
  }
}
```

响应：`201 Created`，返回完整的 `WorkspaceLayoutDto`。

##### PUT /api/v2/users/me/workspace-layouts/{id}

更新布局配置。

请求示例：

```json
{
  "name": "写作模式（宽屏）",
  "layoutJson": {
    "leftPanel": { "visible": true, "width": 18, "activeTab": "outline" },
    "centerPanel": { "width": 57 },
    "rightPanel": { "visible": true, "width": 25, "activeTab": "copilot" },
    "statusBar": { "visible": true },
    "toolbar": { "visible": true }
  }
}
```

响应：`200 OK`，返回更新后的 `WorkspaceLayoutDto`。

##### DELETE /api/v2/users/me/workspace-layouts/{id}

删除布局预设。如果删除的是当前激活布局，自动激活用户的第一个剩余布局。

响应：`204 No Content`。

##### POST /api/v2/users/me/workspace-layouts/{id}/activate

激活指定布局，取消其他布局的激活状态。

响应：`200 OK`，返回激活后的 `WorkspaceLayoutDto`。

#### 3.3.2 写作会话 API

##### POST /api/v2/writing-sessions/start

开始新的写作会话。

请求示例：

```json
{
  "storyId": "uuid-story-001"
}
```

响应示例：

```json
{
  "code": 200,
  "data": {
    "id": "uuid-session-001",
    "userId": "uuid-user-001",
    "storyId": "uuid-story-001",
    "startedAt": "2026-02-17T14:00:00Z",
    "endedAt": null,
    "wordsWritten": 0,
    "wordsDeleted": 0,
    "netWords": 0,
    "durationSeconds": 0,
    "chaptersEdited": []
  }
}
```

##### PUT /api/v2/writing-sessions/{id}/heartbeat

周期性心跳更新（前端每 30 秒调用一次）。

请求示例：

```json
{
  "wordsAdded": 45,
  "wordsRemoved": 8,
  "activeChapterId": "uuid-ch-001",
  "activeSceneId": "uuid-sc-002"
}
```

响应：`200 OK`，返回更新后的 `WritingSessionDto`。

##### POST /api/v2/writing-sessions/{id}/end

结束写作会话。

响应示例：

```json
{
  "code": 200,
  "data": {
    "id": "uuid-session-001",
    "userId": "uuid-user-001",
    "storyId": "uuid-story-001",
    "startedAt": "2026-02-17T14:00:00Z",
    "endedAt": "2026-02-17T16:30:00Z",
    "wordsWritten": 3200,
    "wordsDeleted": 450,
    "netWords": 2750,
    "durationSeconds": 7800,
    "chaptersEdited": [
      { "chapterId": "uuid-ch-001", "sceneId": "uuid-sc-001", "wordsAdded": 1800, "wordsRemoved": 200 },
      { "chapterId": "uuid-ch-001", "sceneId": "uuid-sc-002", "wordsAdded": 1400, "wordsRemoved": 250 }
    ]
  }
}
```

##### GET /api/v2/writing-sessions/stats

获取写作统计数据。

查询参数：
- `from` (必填): 起始日期，格式 `YYYY-MM-DD`
- `to` (必填): 结束日期，格式 `YYYY-MM-DD`
- `storyId` (可选): 按故事筛选

响应示例：

```json
{
  "code": 200,
  "data": {
    "dailyStats": [
      {
        "date": "2026-02-15",
        "totalWords": 3200,
        "netWords": 2750,
        "durationSeconds": 7800,
        "sessionCount": 2
      },
      {
        "date": "2026-02-16",
        "totalWords": 4100,
        "netWords": 3600,
        "durationSeconds": 9200,
        "sessionCount": 1
      }
    ],
    "summary": {
      "totalDays": 2,
      "activeDays": 2,
      "totalWords": 7300,
      "totalNetWords": 6350,
      "totalDurationSeconds": 17000,
      "avgWordsPerDay": 3175,
      "avgSessionDuration": 5667
    }
  }
}
```

#### 3.3.3 写作目标 API

##### GET /api/v2/users/me/writing-goals

获取当前用户的所有写作目标及进度。

响应示例：

```json
{
  "code": 200,
  "data": [
    {
      "id": "uuid-goal-001",
      "storyId": "uuid-story-001",
      "storyTitle": "仙剑奇缘",
      "goalType": "daily_words",
      "targetValue": 3000,
      "currentValue": 1250,
      "deadline": null,
      "status": "active",
      "progressPercent": 41.7,
      "createdAt": "2026-02-10T08:00:00Z"
    },
    {
      "id": "uuid-goal-002",
      "storyId": "uuid-story-001",
      "storyTitle": "仙剑奇缘",
      "goalType": "total_words",
      "targetValue": 200000,
      "currentValue": 45600,
      "deadline": null,
      "status": "active",
      "progressPercent": 22.8,
      "createdAt": "2026-01-15T08:00:00Z"
    }
  ]
}
```

##### POST /api/v2/users/me/writing-goals

创建新写作目标。

请求示例：

```json
{
  "storyId": "uuid-story-001",
  "goalType": "daily_words",
  "targetValue": 3000,
  "deadline": null
}
```

响应：`201 Created`，返回完整的 `WritingGoalDto`。

##### PUT /api/v2/users/me/writing-goals/{id}

更新目标参数。

请求示例：

```json
{
  "targetValue": 5000,
  "deadline": "2026-06-30"
}
```

响应：`200 OK`，返回更新后的 `WritingGoalDto`。

##### DELETE /api/v2/users/me/writing-goals/{id}

删除写作目标。

响应：`204 No Content`。

#### 3.3.4 快捷键 API

##### GET /api/v2/users/me/shortcuts

获取用户的快捷键配置（系统默认 + 用户自定义覆盖合并后的完整列表）。

响应示例：

```json
{
  "code": 200,
  "data": [
    { "action": "command_palette", "shortcut": "Ctrl+K", "isCustom": false },
    { "action": "save", "shortcut": "Ctrl+S", "isCustom": false },
    { "action": "focus_mode", "shortcut": "Ctrl+Shift+F", "isCustom": false },
    { "action": "toggle_left_panel", "shortcut": "Ctrl+B", "isCustom": false },
    { "action": "toggle_right_panel", "shortcut": "Ctrl+Shift+B", "isCustom": false },
    { "action": "next_chapter", "shortcut": "Ctrl+]", "isCustom": false },
    { "action": "prev_chapter", "shortcut": "Ctrl+[", "isCustom": false },
    { "action": "ai_refine", "shortcut": "Ctrl+Shift+R", "isCustom": true },
    { "action": "new_scene", "shortcut": "Ctrl+Shift+N", "isCustom": false },
    { "action": "search_manuscript", "shortcut": "Ctrl+F", "isCustom": false },
    { "action": "search_replace", "shortcut": "Ctrl+H", "isCustom": false },
    { "action": "export", "shortcut": "Ctrl+Shift+E", "isCustom": false }
  ]
}
```

##### PUT /api/v2/users/me/shortcuts

批量更新快捷键配置。仅需传入要覆盖的条目，未传入的保持默认。

请求示例：

```json
{
  "shortcuts": [
    { "action": "ai_refine", "shortcut": "Ctrl+Shift+R" },
    { "action": "focus_mode", "shortcut": "F11" }
  ]
}
```

响应：`200 OK`，返回更新后的完整快捷键列表。

---

### 3.4 前端设计

#### 3.4.1 布局架构

v2 工作台将从当前的 Tab 切换布局重构为 IDE 风格的多面板布局：

```
WorkbenchV2
├── CommandPalette (Ctrl+K 全局覆盖层)
├── StatusBar (底部持久状态栏)
│   ├── WordCount (总字数 / 选中字数)
│   ├── CursorPosition (行:列)
│   ├── SessionTimer (本次会话时长)
│   ├── SaveStatus (已保存 / 保存中... / 未保存)
│   ├── GoalProgress (今日目标进度条)
│   └── ThemeToggle (亮/暗切换)
├── ResizablePanelGroup (horizontal, 主体区域)
│   ├── LeftPanel (可折叠, 默认 20%)
│   │   ├── OutlineTree (章节/场景树, 支持拖拽排序)
│   │   └── LorebookQuickAccess (Lorebook 快速检索)
│   ├── CenterPanel (默认 55%)
│   │   ├── EditorTabs (多标签编辑, 支持同时打开多个场景)
│   │   └── TiptapEditor (增强版, 集成字数统计和快捷键)
│   └── RightPanel (可折叠, 默认 25%)
│       ├── TabGroup (标签切换)
│       │   ├── CopilotSidebar (AI 助手)
│       │   ├── ContextPreview (上下文记忆预览)
│       │   ├── MaterialSearch (素材检索)
│       │   ├── KnowledgeGraph (知识图谱迷你视图)
│       │   └── VersionHistory (版本历史)
│       └── PanelControls (面板操作按钮)
└── FocusMode (全屏覆盖层, 隐藏所有面板仅保留编辑器)
```

#### 3.4.2 核心组件设计

##### CommandPalette — 全局命令面板

触发方式：`Ctrl+K`（可自定义）

功能：
- 模糊搜索章节标题、场景标题、角色名称、Lorebook 条目
- 执行系统操作（保存、导出、切换布局、进入专注模式等）
- 最近访问的章节/场景快速跳转
- AI 快捷指令（如"润色当前段落"、"生成下一场景"）

```typescript
interface CommandPaletteProps {
  open: boolean;
  onOpenChange: (open: boolean) => void;
  storyId: string;
}

interface CommandItem {
  id: string;
  label: string;           // 显示名称
  category: 'chapter' | 'scene' | 'character' | 'lorebook' | 'action' | 'ai';
  icon?: React.ReactNode;
  shortcut?: string;       // 关联快捷键（仅展示）
  onSelect: () => void;    // 选中后执行的操作
  keywords?: string[];     // 额外搜索关键词
}
```

实现要点：
- 使用 shadcn/ui 的 `<Dialog>` + `<Command>` 组件（基于 cmdk 库）
- 搜索结果按类别分组展示
- 支持键盘上下导航 + Enter 选中
- 搜索结果实时过滤，无需等待后端响应（章节/角色数据已在前端缓存）

##### StatusBar — 底部状态栏

持久显示在工作台底部，高度固定 32px，提供关键写作状态信息。

```typescript
interface StatusBarProps {
  wordCount: number;          // 当前文档总字数
  selectedWordCount: number;  // 选中文本字数
  cursorLine: number;         // 光标所在行
  cursorColumn: number;       // 光标所在列
  saveStatus: 'saved' | 'saving' | 'unsaved';
  lastSavedAt: string | null;
  sessionDuration: number;    // 当前会话时长（秒）
  sessionWords: number;       // 当前会话净增字数
  dailyGoal: {                // 今日目标（如有）
    target: number;
    current: number;
  } | null;
}
```

布局：左侧显示字数和光标位置，中间显示保存状态，右侧显示会话统计和目标进度。

##### OutlineTree — 大纲树

将当前 `ManuscriptWriter` 左侧的 Select + ScrollArea 导航重构为完整的树形组件。

功能：
- 树形展示：故事 > 章节 > 场景，支持展开/折叠
- 拖拽排序：章节间拖拽调整顺序，场景可跨章节拖拽
- 右键菜单：新建章节/场景、重命名、删除、复制
- 多选模式：Ctrl+Click 多选，Shift+Click 范围选，触发批量操作工具栏
- 状态标记：已完成/进行中/未开始的视觉区分
- 字数显示：每个章节/场景旁显示字数

```typescript
interface OutlineTreeProps {
  outline: Outline;
  selectedSceneId: string;
  onSceneSelect: (sceneId: string) => void;
  onChapterReorder: (chapters: Chapter[]) => void;
  onSceneReorder: (chapterId: string, scenes: Scene[]) => void;
  onBatchSelect: (sceneIds: string[]) => void;
}
```

##### EditorTabs — 多标签编辑器

支持同时打开多个场景，以标签页形式切换。

功能：
- 标签页展示已打开的场景，显示场景标题和所属章节
- 标签页可关闭（Ctrl+W）、可拖拽调整顺序
- 未保存的标签页显示圆点标记
- 标签页溢出时显示左右滚动箭头
- 双击标签页可重命名场景

```typescript
interface EditorTabsProps {
  openTabs: TabItem[];
  activeTabId: string;
  onTabSelect: (tabId: string) => void;
  onTabClose: (tabId: string) => void;
  onTabReorder: (tabs: TabItem[]) => void;
}

interface TabItem {
  id: string;           // 场景 ID
  title: string;        // 场景标题
  chapterTitle: string; // 所属章节标题
  isDirty: boolean;     // 是否有未保存的修改
}
```

##### FocusModeToggle — 专注模式

进入方式：`Ctrl+Shift+F`（可自定义）或点击状态栏按钮

行为：
- 隐藏左右面板、状态栏、编辑器工具栏、AppLayout 侧边栏
- 编辑器全屏居中，最大宽度 `48rem`，上下留白充足
- 启用打字机滚动：当前编辑行始终保持在视口垂直中心
- 右下角显示半透明的退出按钮和字数统计
- 按 `Esc` 退出专注模式

```typescript
interface FocusModeProps {
  active: boolean;
  onExit: () => void;
  editor: Editor;
  wordCount: number;
  sessionWords: number;
}
```

##### WritingGoalWidget — 写作目标组件

显示位置：状态栏右侧（迷你进度条）+ 右面板可展开的详细视图

迷你视图：圆形进度环 + 百分比数字，悬停显示详情 tooltip

详细视图：
- 当前活跃目标列表
- 每个目标显示进度条、当前值/目标值、剩余量
- 支持快速创建新目标
- 目标完成时显示庆祝动画（confetti）

##### SessionStatsWidget — 会话统计组件

显示位置：右面板标签页之一

内容：
- 当前会话：时长、新增字数、删除字数、净增字数
- 今日汇总：总写作时长、总字数、会话次数
- 历史趋势：最近 7 天的字数折线图
- 写作热力图：最近 30 天的日历热力图（类似 GitHub 贡献图）

##### BatchOperationToolbar — 批量操作工具栏

触发条件：在 OutlineTree 中多选 2 个以上章节/场景时，工具栏从底部滑入。

操作按钮：
- 批量导出（调用 `05-稿件导出` 模块）
- 批量删除（二次确认）
- 批量移动（弹出目标章节选择器）
- 批量标记状态（已完成/进行中/未开始）
- 取消选择

```typescript
interface BatchOperationToolbarProps {
  selectedIds: string[];
  selectionType: 'chapter' | 'scene';
  onExport: (ids: string[]) => void;
  onDelete: (ids: string[]) => void;
  onMove: (ids: string[], targetChapterId: string) => void;
  onStatusChange: (ids: string[], status: string) => void;
  onClearSelection: () => void;
}
```

##### KeyboardShortcutEditor — 快捷键编辑器

显示位置：设置页面（`/settings`）的新标签页

功能：
- 表格展示所有操作及其当前快捷键
- 点击快捷键单元格进入录制模式，按下新组合键即可覆盖
- 冲突检测：如果新快捷键与已有绑定冲突，显示警告并要求确认
- 重置按钮：恢复单个操作或全部操作的默认快捷键
- 搜索过滤：按操作名称搜索

##### ThemeCustomizer — 主题定制器

整合现有 `AppearanceSettings` 组件，扩展以下能力：
- 亮色/暗色模式切换（系统级，影响整个应用）
- 强调色选择（预设 8 种 + 自定义 HEX）
- 编辑器主题保留现有选项（light / parchment / hacker）
- 字体和宽度设置保留现有选项

#### 3.4.3 默认快捷键表

| 操作 | 快捷键 | action 标识 | 说明 |
|------|--------|-------------|------|
| 命令面板 | `Ctrl+K` | `command_palette` | 打开全局命令面板 |
| 保存 | `Ctrl+S` | `save` | 保存当前场景 |
| 专注模式 | `Ctrl+Shift+F` | `focus_mode` | 切换专注/正常模式 |
| 切换左面板 | `Ctrl+B` | `toggle_left_panel` | 显示/隐藏左侧大纲面板 |
| 切换右面板 | `Ctrl+Shift+B` | `toggle_right_panel` | 显示/隐藏右侧参考面板 |
| 下一章节 | `Ctrl+]` | `next_chapter` | 跳转到下一个场景 |
| 上一章节 | `Ctrl+[` | `prev_chapter` | 跳转到上一个场景 |
| AI 润色 | `Ctrl+Shift+R` | `ai_refine` | 对选中文本执行 AI 润色 |
| 新建场景 | `Ctrl+Shift+N` | `new_scene` | 在当前章节末尾新建场景 |
| 搜索稿件 | `Ctrl+F` | `search_manuscript` | 在当前稿件中搜索 |
| 搜索替换 | `Ctrl+H` | `search_replace` | 搜索并替换 |
| 导出 | `Ctrl+Shift+E` | `export` | 打开导出对话框 |
| 关闭标签页 | `Ctrl+W` | `close_tab` | 关闭当前编辑器标签页 |
| 切换标签页 | `Ctrl+Tab` | `next_tab` | 切换到下一个编辑器标签页 |
| 撤销 | `Ctrl+Z` | `undo` | 编辑器撤销（Tiptap 原生） |
| 重做 | `Ctrl+Shift+Z` | `redo` | 编辑器重做（Tiptap 原生） |

#### 3.4.4 快捷键实现方案

前端使用自定义 `useKeyboardShortcuts` Hook 统一管理快捷键：

```typescript
// hooks/useKeyboardShortcuts.ts

interface ShortcutBinding {
  action: string;
  shortcut: string;
  handler: () => void;
  enabled?: boolean;        // 是否启用（某些快捷键仅在特定上下文生效）
  preventDefault?: boolean; // 是否阻止浏览器默认行为
}

function useKeyboardShortcuts(bindings: ShortcutBinding[]) {
  useEffect(() => {
    const handleKeyDown = (e: KeyboardEvent) => {
      for (const binding of bindings) {
        if (!binding.enabled) continue;
        if (matchShortcut(e, binding.shortcut)) {
          if (binding.preventDefault) e.preventDefault();
          binding.handler();
          return;
        }
      }
    };
    window.addEventListener('keydown', handleKeyDown);
    return () => window.removeEventListener('keydown', handleKeyDown);
  }, [bindings]);
}

/**
 * 解析快捷键字符串并与 KeyboardEvent 匹配。
 * 支持格式：Ctrl+K, Ctrl+Shift+F, F11, Escape 等。
 */
function matchShortcut(e: KeyboardEvent, shortcut: string): boolean {
  const parts = shortcut.toLowerCase().split('+');
  const key = parts.pop()!;
  const modifiers = {
    ctrl: parts.includes('ctrl'),
    shift: parts.includes('shift'),
    alt: parts.includes('alt'),
    meta: parts.includes('meta'),
  };
  return (
    e.key.toLowerCase() === key &&
    e.ctrlKey === modifiers.ctrl &&
    e.shiftKey === modifiers.shift &&
    e.altKey === modifiers.alt &&
    e.metaKey === modifiers.meta
  );
}
```

快捷键配置通过 React Context 全局共享：

```typescript
// contexts/ShortcutContext.tsx

interface ShortcutContextValue {
  shortcuts: Record<string, string>;  // action -> shortcut 映射
  updateShortcut: (action: string, shortcut: string) => Promise<void>;
  resetShortcut: (action: string) => Promise<void>;
  resetAll: () => Promise<void>;
}

const ShortcutContext = createContext<ShortcutContextValue>(/* ... */);

function ShortcutProvider({ children }: { children: React.ReactNode }) {
  // 初始化时从后端加载用户快捷键配置
  // 合并系统默认值和用户自定义值
  // 提供更新方法（调用 PUT /api/v2/users/me/shortcuts）
}
```

#### 3.4.5 写作会话追踪实现

前端使用 `useWritingSession` Hook 管理会话生命周期：

```typescript
// hooks/useWritingSession.ts

interface UseWritingSessionReturn {
  session: WritingSession | null;
  isActive: boolean;
  startSession: (storyId: string) => Promise<void>;
  endSession: () => Promise<void>;
  sessionDuration: number;   // 实时计算的会话时长（秒）
  sessionWords: number;      // 本次会话净增字数
}

function useWritingSession() {
  const [session, setSession] = useState<WritingSession | null>(null);
  const heartbeatRef = useRef<number>();
  const wordDeltaRef = useRef({ added: 0, removed: 0 });

  // 启动会话时开始 30 秒心跳定时器
  const startSession = async (storyId: string) => {
    const res = await api.post('/v2/writing-sessions/start', { storyId });
    setSession(res.data);
    heartbeatRef.current = window.setInterval(() => sendHeartbeat(), 30000);
  };

  // 心跳：上报增量数据并重置计数器
  const sendHeartbeat = async () => {
    if (!session) return;
    const delta = { ...wordDeltaRef.current };
    wordDeltaRef.current = { added: 0, removed: 0 };
    if (delta.added === 0 && delta.removed === 0) return; // 无活动则跳过
    const res = await api.put(`/v2/writing-sessions/${session.id}/heartbeat`, {
      wordsAdded: delta.added,
      wordsRemoved: delta.removed,
    });
    setSession(res.data);
  };

  // 编辑器内容变化时调用，累加字数增量
  const recordDelta = (added: number, removed: number) => {
    wordDeltaRef.current.added += added;
    wordDeltaRef.current.removed += removed;
  };

  // 页面卸载 / 切换故事时结束会话
  const endSession = async () => {
    if (!session) return;
    clearInterval(heartbeatRef.current);
    await sendHeartbeat(); // 发送最后一次心跳
    await api.post(`/v2/writing-sessions/${session.id}/end`);
    setSession(null);
  };

  // 页面关闭时自动结束会话（使用 navigator.sendBeacon）
  useEffect(() => {
    const handleBeforeUnload = () => {
      if (session) {
        navigator.sendBeacon(
          `/api/v2/writing-sessions/${session.id}/end`,
          JSON.stringify({})
        );
      }
    };
    window.addEventListener('beforeunload', handleBeforeUnload);
    return () => window.removeEventListener('beforeunload', handleBeforeUnload);
  }, [session]);

  return { session, isActive: !!session, startSession, endSession, recordDelta };
}
```

#### 3.4.6 项目中心页 (Dashboard)

项目中心页替代当前的左右分屏入口页（`Dashboard.tsx`），采用以下布局：

**顶部区域：**
- 欢迎语: "欢迎回来, {username}"
- 今日写作统计: 今日已写 {todayWords} 字 / 目标 {goal} 字（进度条）

**主体区域（两栏）：**

左侧 - 最近项目（卡片网格 2x2 或 3x2）：
- 项目卡片: 封面图/渐变占位图 + 标题 + 类型标签 + 进度条(已完成章节/总章节) + 最后编辑时间 + 字数 + 快捷操作(继续写作/导出/分析)
- 最后一张卡片为 "+ 新建项目" 入口

右侧 - 写作统计：
- 本周字数折线图 (recharts `LineChart`)
- 连续写作天数计数器
- 最近30天写作热力图 (类似 GitHub 贡献图)
- 平均每次会话字数

**底部区域 - 最近活动流（时间线）：**
- 时间线形式展示最近操作记录
- 如: "2小时前: 编辑了《xxx》第3章", "5小时前: Beta Reader 分析完成"

##### TypeScript 接口定义

```typescript
/** 项目卡片数据 */
interface ProjectCard {
  id: string;
  title: string;
  coverUrl: string | null;        // 封面图 URL，null 时使用渐变占位图
  genre: string;                  // 类型标签，如 "玄幻" / "言情"
  totalChapters: number;
  completedChapters: number;
  wordCount: number;
  lastEditedAt: string;           // ISO 8601
}

/** 活动流条目 */
interface ActivityItem {
  id: string;
  type: 'edit' | 'export' | 'analysis' | 'create' | 'goal_complete';
  storyId: string;
  storyTitle: string;
  description: string;            // 如 "编辑了第3章「重逢」"
  timestamp: string;              // ISO 8601
}
```

---

### 3.5 Prompt 工程

#### 3.5.1 命令面板 AI 建议

当用户在命令面板中输入以"AI"或"帮我"开头的文本时，系统将其作为 AI 指令处理。

Prompt 模板：

```
你是一个小说写作助手。用户正在编辑故事《{storyTitle}》的第{chapterIndex}章"{chapterTitle}"中的场景"{sceneTitle}"。

用户指令：{userInput}

当前场景内容（最后 500 字）：
{recentContent}

请根据用户指令执行操作，直接输出结果文本，不要添加解释。
```

#### 3.5.2 写作会话总结生成

当写作会话结束时，如果净增字数超过 500 字，系统可选择性地生成会话总结。

Prompt 模板：

```
请用一句话总结以下写作会话的内容进展：

故事：{storyTitle}
本次编辑章节：{editedChapters}
新增字数：{netWords}
编辑时长：{duration}

本次新增的关键内容片段：
{contentSnippets}

请用简洁的中文总结，不超过 50 字，格式如："完成了第三章林逸与苏瑶的重逢场景，推进了主线剧情"。
```

#### 3.5.3 编辑器内联 AI 建议

编辑器集成内联 AI 建议能力，与侧栏 CopilotSidebar 并存，提供两种交互模式：

1. **Ghost Text 建议**（类似 GitHub Copilot）：当用户停顿 1.5 秒以上时，根据上下文自动生成续写建议，以灰色半透明文本显示在光标后方。按 `Tab` 接受，按 `Esc` 或继续输入则忽略。
2. **增强 BubbleMenu**：选中文本后弹出的浮动菜单新增更多 AI 操作项——润色、扩写、缩写、改变语气、翻译、解释，点击后结果以 diff 形式内联展示，用户可接受或拒绝。

> → 见 10-前端设计系统.md § 7

---

## 4. 与现有代码的集成点

### 4.1 需要重构的文件

| 文件路径 | 变更类型 | 说明 |
|----------|----------|------|
| `frontend/src/pages/Workbench/Workbench.tsx` | 重大重构 | 从 Tab 布局重构为 `ResizablePanelGroup` 多面板布局。保留原有 Tab 内容组件（StoryConception、OutlineWorkbench 等）作为面板内容，但不再使用 `<Tabs>` 作为顶层容器。 |
| `frontend/src/components/editor/TiptapEditor.tsx` | 增强 | 集成快捷键系统（通过 `useKeyboardShortcuts`）、实时字数统计回调、打字机滚动模式、字数增量追踪（供写作会话使用）。 |
| `frontend/src/components/editor/EditorToolbar.tsx` | 增强 | 添加专注模式切换按钮、布局预设切换下拉菜单、快捷键提示 tooltip。 |
| `frontend/src/components/ai/CopilotSidebar.tsx` | 迁移 | 从 `ManuscriptWriter` 内嵌迁移到右面板的标签页之一。接口不变，仅调整容器样式。 |
| `frontend/src/components/layout/AppLayout.tsx` | 增强 | 集成 StatusBar 组件到主布局底部。专注模式下隐藏侧边栏（`aside` 元素）。 |
| `frontend/src/pages/Workbench/tabs/ManuscriptWriter.tsx` | 重构 | 移除内嵌的左侧导航和右侧 CopilotSidebar（这些功能上移到 WorkbenchV2 的面板层），ManuscriptWriter 简化为纯编辑器容器。 |

### 4.2 新增文件

| 文件路径 | 说明 |
|----------|------|
| `frontend/src/pages/Workbench/WorkbenchV2.tsx` | 新版工作台主组件 |
| `frontend/src/components/workbench/CommandPalette.tsx` | 命令面板组件 |
| `frontend/src/components/workbench/StatusBar.tsx` | 底部状态栏组件 |
| `frontend/src/components/workbench/OutlineTree.tsx` | 大纲树组件 |
| `frontend/src/components/workbench/EditorTabs.tsx` | 多标签编辑器组件 |
| `frontend/src/components/workbench/FocusMode.tsx` | 专注模式覆盖层 |
| `frontend/src/components/workbench/WritingGoalWidget.tsx` | 写作目标组件 |
| `frontend/src/components/workbench/SessionStatsWidget.tsx` | 会话统计组件 |
| `frontend/src/components/workbench/BatchOperationToolbar.tsx` | 批量操作工具栏 |
| `frontend/src/components/workbench/KeyboardShortcutEditor.tsx` | 快捷键编辑器 |
| `frontend/src/components/workbench/ThemeCustomizer.tsx` | 主题定制器 |
| `frontend/src/hooks/useKeyboardShortcuts.ts` | 快捷键管理 Hook |
| `frontend/src/hooks/useWritingSession.ts` | 写作会话管理 Hook |
| `frontend/src/hooks/useWorkspaceLayout.ts` | 布局状态管理 Hook |
| `frontend/src/contexts/ShortcutContext.tsx` | 快捷键配置 Context |
| `backend/src/main/java/com/ainovel/app/workspace/` | 后端工作台模块（完整包结构见 3.2.1） |

### 4.3 与其他 v2 模块的依赖

| 依赖模块 | 集成点 | 说明 |
|----------|--------|------|
| `01-上下文记忆系统` | 右面板 ContextPreview 标签页 | 展示当前场景的上下文记忆注入预览（哪些 Lorebook 条目被激活、图谱子图摘要）。左面板 LorebookQuickAccess 提供 Lorebook 条目快速检索。 |
| `04-版本控制系统` | 右面板 VersionHistory 标签页 | 展示当前场景的版本历史列表，支持快速 diff 对比和回滚操作。 |
| `05-稿件导出系统` | 批量操作工具栏的"批量导出"按钮 | 调用导出模块的 API，支持多选章节/场景后一键导出为 EPUB/DOCX/PDF/TXT。 |
| `06-多模型协作` | CopilotSidebar 模型选择 | 右面板 CopilotSidebar 的模型选择下拉菜单对接多模型路由系统，根据任务类型推荐最优模型。 |

---

## 5. 实施注意事项

### 5.1 面板状态持久化

- 面板尺寸变化时，使用 `debounce`（300ms）延迟保存到后端，避免拖拽过程中频繁请求。
- 首次加载时，如果用户无已保存布局，使用系统默认布局（左 20% / 中 55% / 右 25%）。
- 布局配置同时缓存到 `localStorage`，确保后端不可用时仍能恢复上次布局。
- `react-resizable-panels` 的 `onLayout` 回调提供面板尺寸百分比，直接存入 `layout_json`。

### 5.2 快捷键冲突处理

- **浏览器冲突**：`Ctrl+W`（关闭标签页）、`Ctrl+T`（新标签页）等浏览器快捷键无法被 `preventDefault` 覆盖。对于这些快捷键，提供替代绑定（如 `Ctrl+Shift+W` 关闭编辑器标签页）。
- **操作系统冲突**：`Ctrl+Shift+F`（Windows 搜索）在部分系统上可能被拦截。快捷键编辑器中标注已知冲突，建议用户更换。
- **Tiptap 内部快捷键**：`Ctrl+B`（加粗）、`Ctrl+I`（斜体）等 Tiptap 编辑器内置快捷键优先级高于自定义快捷键。当焦点在编辑器内时，编辑器快捷键优先；焦点在编辑器外时，自定义快捷键优先。
- **冲突检测**：快捷键编辑器在用户录制新快捷键时，实时检测是否与已有绑定冲突，冲突时显示警告并要求确认覆盖。

### 5.3 多编辑器性能

- 多标签编辑器中，仅当前激活标签页的 Tiptap 编辑器实例保持活跃状态。
- 非激活标签页的编辑器内容序列化为 HTML 字符串缓存在内存中，销毁 Tiptap 实例以释放 DOM 资源。
- 切换标签页时，从缓存的 HTML 重新初始化编辑器实例。初始化耗时约 50-100ms，用户感知不到延迟。
- 同时打开的标签页数量限制为 10 个，超出时提示用户关闭不需要的标签页。

### 5.4 响应式设计

- **桌面端**（>= 1280px）：完整三栏布局，所有面板可见。
- **平板端**（768px - 1279px）：默认隐藏右面板，左面板可折叠为图标模式（仅显示章节图标，悬停展开）。
- **移动端**（< 768px）：回退到 v1 的 Tab 切换布局，不加载多面板组件。移动端不支持快捷键和批量操作。
- 使用 `useMediaQuery` Hook 检测屏幕尺寸，动态切换布局模式。

### 5.5 自动保存与会话追踪的协调

- 自动保存（`ManuscriptWriter` 现有的 1200ms debounce）与写作会话心跳（30 秒间隔）独立运行。
- 自动保存负责将编辑器内容持久化到后端（`manuscripts.saveSection`）。
- 写作会话心跳负责上报字数增量统计（`writing-sessions/heartbeat`）。
- 两者不互相阻塞，使用独立的 API 调用。
- 字数增量计算：在 Tiptap 的 `onUpdate` 回调中，通过比较更新前后的 `editor.state.doc.textContent.length` 差值来计算增量。正差值为新增，负差值为删除。

---

## 6. 验收标准

### 6.1 功能验收

| 编号 | 验收项 | 验收标准 | 优先级 |
|------|--------|----------|--------|
| AC-01 | 多面板布局 | 工作台显示左（大纲树）、中（编辑器）、右（参考面板）三栏布局，面板间可拖拽调整宽度比例，最小/最大宽度限制生效 | P0 |
| AC-02 | 面板折叠 | 左右面板可通过快捷键或按钮折叠/展开，折叠动画流畅（< 300ms），折叠后中间编辑器自动扩展填充空间 | P0 |
| AC-03 | 布局持久化 | 用户调整面板布局后刷新页面，布局恢复到上次状态。支持创建/切换/删除多套布局预设 | P1 |
| AC-04 | 命令面板 | `Ctrl+K` 打开命令面板，输入关键词可模糊搜索章节/角色/操作，选中后执行对应操作，响应时间 < 100ms | P0 |
| AC-05 | 快捷键 | 所有默认快捷键表中的操作均可通过快捷键触发，快捷键在编辑器焦点内外均正确响应 | P0 |
| AC-06 | 快捷键自定义 | 用户可在设置页面修改快捷键绑定，修改后立即生效，冲突检测正确提示 | P1 |
| AC-07 | 专注模式 | `Ctrl+Shift+F` 进入专注模式，所有面板和工具栏隐藏，编辑器全屏居中，`Esc` 退出恢复原布局 | P0 |
| AC-08 | 打字机滚动 | 专注模式下，当前编辑行始终保持在视口垂直中心，滚动平滑 | P1 |
| AC-09 | 多标签编辑 | 可同时打开多个场景标签页，标签页可关闭/切换/拖拽排序，未保存标签显示标记 | P1 |
| AC-10 | 大纲树 | 左面板显示章节/场景树形结构，支持展开/折叠、单击选中、右键菜单操作 | P0 |
| AC-11 | 拖拽排序 | 大纲树中的章节和场景支持拖拽调整顺序，拖拽过程有视觉反馈，释放后顺序持久化 | P1 |
| AC-12 | 批量操作 | 多选章节/场景后显示批量操作工具栏，批量导出/删除/移动功能正常 | P2 |
| AC-13 | 状态栏 | 底部状态栏持久显示字数、保存状态、会话时长、目标进度，信息实时更新 | P0 |
| AC-14 | 写作会话 | 进入写作页面自动开始会话，离开或关闭页面自动结束会话，会话数据正确记录 | P1 |
| AC-15 | 写作目标 | 可创建/编辑/删除写作目标，目标进度实时更新，日更目标每日自动重置 | P1 |
| AC-16 | 写作统计 | 统计页面显示日/周/月维度的写作数据，热力图和折线图正确渲染 | P2 |
| AC-17 | 响应式 | 桌面端三栏布局、平板端双栏布局、移动端 Tab 布局，切换流畅无布局错乱 | P1 |

### 6.2 性能验收

| 编号 | 验收项 | 验收标准 |
|------|--------|----------|
| PF-01 | 工作台首屏加载 | 工作台页面首屏渲染时间 < 1.5 秒（桌面端，正常网络） |
| PF-02 | 面板拖拽 | 面板拖拽调整宽度时帧率 >= 30fps，无明显卡顿 |
| PF-03 | 命令面板搜索 | 命令面板输入到结果展示延迟 < 50ms（本地数据） |
| PF-04 | 标签页切换 | 编辑器标签页切换时间 < 200ms（含 Tiptap 实例重建） |
| PF-05 | 心跳请求 | 写作会话心跳请求耗时 < 200ms，不阻塞编辑器操作 |
| PF-06 | 内存占用 | 同时打开 10 个标签页时，页面内存增量 < 50MB |

### 6.3 兼容性验收

| 编号 | 验收项 | 验收标准 |
|------|--------|----------|
| CP-01 | 浏览器 | Chrome 90+、Firefox 90+、Safari 15+、Edge 90+ 均正常运行 |
| CP-02 | 快捷键 | Windows 和 macOS 上快捷键均正确响应（macOS 上 Ctrl 自动映射为 Cmd） |
| CP-03 | 暗色模式 | 所有新增组件在亮色和暗色模式下均正确显示，无对比度问题 |
